<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é³Œå¤ªçº¿æ¨¡æ‹Ÿå™¨</title>
    <style>
/**
 * é³Œå¤ªçº¿æ¨¡æ‹Ÿå™¨ - ä¸“ä¸šæ¸¸æˆçº§UIæ ·å¼
 * å‚è€ƒé£æ ¼ï¼šThis War of Mine + Don't Starve + The Long Dark + Death Stranding
 */

/* ========== CSSå˜é‡å®šä¹‰ ========== */
:root {
    /* ä¸»é¢˜è‰² - æ·±è‰²é‡å¤–æ°›å›´ */
    --bg-primary: #0d0d12;
    --bg-secondary: #1a1a24;
    --bg-tertiary: #252533;
    --bg-card: rgba(30, 30, 42, 0.85);
    
    /* å¼ºè°ƒè‰² */
    --accent-primary: #c9a227;
    --accent-secondary: #8b7355;
    --accent-danger: #c73e3e;
    --accent-success: #4a9b5e;
    --accent-info: #4a7c9b;
    --accent-warning: #c98a27;
    
    /* çŠ¶æ€è‰² */
    --stamina: #4a9b5e;
    --food: #c98a27;
    --water: #4a7c9b;
    --temp: #c9a227;
    --health: #c73e3e;
    
    /* æ–‡å­—è‰² */
    --text-primary: #f0f0f5;
    --text-secondary: #a0a0b0;
    --text-muted: #606070;
    --text-accent: #c9a227;
    
    /* è¾¹æ¡†ä¸é˜´å½± */
    --border-color: rgba(255, 255, 255, 0.08);
    --border-accent: rgba(201, 162, 39, 0.3);
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
    --glow-gold: 0 0 20px rgba(201, 162, 39, 0.3);
    --glow-danger: 0 0 20px rgba(199, 62, 62, 0.4);
    
    /* å­—ä½“ */
    --font-title: 'Noto Serif SC', serif;
    --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
    
    /* åŠ¨ç”» */
    --anim-fast: 0.15s;
    --anim-normal: 0.3s;
    --anim-slow: 0.5s;
    
    /* åœ†è§’ */
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
}

/* ========== åŸºç¡€é‡ç½® ========== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
    overflow: hidden;
}

body {
    font-family: var(--font-body);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow: hidden;
    position: relative;
}

/* ========== å¤©æ°”æ•ˆæœå±‚ ========== */
#weather-effects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
}

#rain-layer {
    position: absolute;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
        170deg,
        transparent,
        transparent 20px,
        rgba(174, 194, 224, 0.1) 20px,
        rgba(174, 194, 224, 0.1) 21px
    );
    animation: rain 0.5s linear infinite;
    opacity: 0;
}

#rain-layer.active {
    opacity: 1;
}

@keyframes rain {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(100%); }
}

#snow-layer {
    position: absolute;
    width: 100%;
    height: 100%;
    background-image: 
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.9), transparent),
        radial-gradient(2px 2px at 130px 80px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 160px 120px, rgba(255,255,255,0.8), transparent);
    background-size: 200px 200px;
    animation: snow 3s linear infinite;
    opacity: 0;
}

#snow-layer.active {
    opacity: 1;
}

@keyframes snow {
    0% { background-position: 0 0; }
    100% { background-position: 0 200px; }
}

#fog-layer {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        to bottom,
        rgba(200, 200, 210, 0.3) 0%,
        transparent 30%,
        transparent 70%,
        rgba(200, 200, 210, 0.3) 100%
    );
    backdrop-filter: blur(3px);
    opacity: 0;
    transition: opacity 1s;
}

#fog-layer.active {
    opacity: 1;
}

/* ========== å±é™©æ•ˆæœå±‚ ========== */
#danger-effects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 999;
}

#low-hp-vignette {
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(
        ellipse at center,
        transparent 40%,
        rgba(199, 62, 62, 0.4) 100%
    );
    opacity: 0;
    transition: opacity 0.5s;
}

#low-hp-vignette.active {
    opacity: 1;
    animation: pulse-vignette 1.5s ease-in-out infinite;
}

@keyframes pulse-vignette {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

#hypothermia-frost {
    position: absolute;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(200, 220, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(200, 220, 255, 0.08) 0%, transparent 40%);
    border: 20px solid transparent;
    border-image: linear-gradient(
        to bottom,
        rgba(200, 220, 255, 0.3),
        transparent 30%,
        transparent 70%,
        rgba(200, 220, 255, 0.3)
    ) 1;
    opacity: 0;
    transition: opacity 0.5s;
}

#hypothermia-frost.active {
    opacity: 1;
}

#altitude-blur {
    position: absolute;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(2px);
    opacity: 0;
    transition: opacity 0.5s;
}

#altitude-blur.active {
    opacity: 0.7;
}

/* ========== ç§¯æåé¦ˆæ•ˆæœ ========== */
#positive-effects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 998;
}

#water-glow {
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(
        circle at 50% 50%,
        rgba(74, 124, 155, 0.2) 0%,
        transparent 60%
    );
    opacity: 0;
}

#water-glow.active {
    animation: water-pulse 2s ease-out;
}

@keyframes water-pulse {
    0% { opacity: 0; transform: scale(0.5); }
    50% { opacity: 1; }
    100% { opacity: 0; transform: scale(1.5); }
}

#achievement-flash {
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(
        circle at 50% 50%,
        rgba(201, 162, 39, 0.5) 0%,
        transparent 50%
    );
    opacity: 0;
}

#achievement-flash.active {
    animation: achievement-flash 1s ease-out;
}

@keyframes achievement-flash {
    0% { opacity: 0; }
    20% { opacity: 1; }
    100% { opacity: 0; }
}

/* ========== æ¸¸æˆå®¹å™¨ ========== */
#game-container {
    position: relative;
    width: 100%;
    height: 100vh;
    max-width: 480px;
    margin: 0 auto;
    background: var(--bg-primary);
    overflow: hidden;
}

/* ========== å±å¹•åˆ‡æ¢ ========== */
.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    opacity: 0;
    transition: opacity var(--anim-normal) ease;
    overflow-y: auto;
    overflow-x: hidden;
}

.screen.active {
    display: flex;
    flex-direction: column;
    opacity: 1;
}

/* ========== å¼€å§‹ç•Œé¢ ========== */
#start-screen {
    background: linear-gradient(
        180deg,
        var(--bg-primary) 0%,
        var(--bg-secondary) 50%,
        var(--bg-tertiary) 100%
    );
}

.start-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

.mountain-silhouette {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 40%;
    background: linear-gradient(
        to top,
        var(--bg-tertiary) 0%,
        transparent 100%
    );
    clip-path: polygon(
        0% 100%,
        0% 60%,
        15% 40%,
        25% 55%,
        35% 35%,
        50% 50%,
        60% 30%,
        75% 45%,
        85% 25%,
        100% 50%,
        100% 100%
    );
}

.stars {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 60%;
    background-image: 
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 50px 100px, rgba(255,255,255,0.6), transparent),
        radial-gradient(2px 2px at 80px 50px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.9), transparent),
        radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.5), transparent),
        radial-gradient(1px 1px at 200px 40px, rgba(255,255,255,0.8), transparent),
        radial-gradient(2px 2px at 250px 90px, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 300px 150px, rgba(255,255,255,0.7), transparent),
        radial-gradient(2px 2px at 350px 60px, rgba(255,255,255,0.5), transparent);
    animation: twinkle 4s ease-in-out infinite;
}

@keyframes twinkle {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
}

.start-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 24px;
}

.title-section {
    text-align: center;
    margin-bottom: 48px;
}

.game-title {
    font-family: var(--font-title);
    font-size: 56px;
    font-weight: 900;
    color: var(--text-primary);
    text-shadow: 0 0 40px rgba(201, 162, 39, 0.3);
    letter-spacing: 8px;
    line-height: 1;
}

.game-subtitle {
    font-family: var(--font-title);
    font-size: 48px;
    font-weight: 700;
    color: var(--accent-primary);
    letter-spacing: 12px;
    margin-top: -10px;
    text-shadow: 0 0 30px rgba(201, 162, 39, 0.4);
}

.tagline {
    font-size: 14px;
    color: var(--text-secondary);
    letter-spacing: 4px;
    margin-top: 16px;
    text-transform: uppercase;
}

.start-menu {
    width: 100%;
    max-width: 280px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.menu-btn {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 24px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 16px;
    cursor: pointer;
    transition: all var(--anim-fast);
    backdrop-filter: blur(10px);
}

.menu-btn:hover:not(:disabled) {
    background: var(--bg-tertiary);
    border-color: var(--border-accent);
    transform: translateX(4px);
}

.menu-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.menu-btn.primary {
    background: linear-gradient(135deg, rgba(201, 162, 39, 0.2), rgba(201, 162, 39, 0.05));
    border-color: var(--accent-primary);
}

.menu-btn.primary:hover {
    background: linear-gradient(135deg, rgba(201, 162, 39, 0.3), rgba(201, 162, 39, 0.1));
    box-shadow: var(--glow-gold);
}

.btn-icon {
    width: 24px;
    text-align: center;
    font-size: 18px;
}

.btn-text {
    flex: 1;
    text-align: left;
}

/* ========== é€šç”¨å±å¹•å¤´éƒ¨ ========== */
.screen-header {
    display: flex;
    align-items: center;
    padding: 16px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 10;
}

.back-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 24px;
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: background var(--anim-fast);
}

.back-btn:hover {
    background: var(--bg-tertiary);
}

.screen-title {
    flex: 1;
    text-align: center;
    font-family: var(--font-title);
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
}

/* ========== è£…å¤‡ç•Œé¢ ========== */
#equipment-screen {
    background: var(--bg-primary);
}

.weight-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    color: var(--text-secondary);
}

.weight-icon {
    font-size: 16px;
}

.equipment-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}

.equipment-categories {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.equip-category {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 16px;
    backdrop-filter: blur(10px);
}

.category-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}

.cat-icon {
    font-size: 20px;
}

.item-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
}

.equip-item {
    aspect-ratio: 1;
    background: var(--bg-secondary);
    border: 2px solid transparent;
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
    transition: all var(--anim-fast);
    position: relative;
}

.equip-item:hover {
    background: var(--bg-tertiary);
}

.equip-item.selected {
    border-color: var(--accent-primary);
    background: rgba(201, 162, 39, 0.1);
}

.equip-item .item-icon {
    font-size: 28px;
}

.equip-item .item-name {
    font-size: 11px;
    color: var(--text-secondary);
    text-align: center;
}

.equip-item .item-cost {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 10px;
    color: var(--accent-primary);
    background: rgba(0, 0, 0, 0.5);
    padding: 2px 4px;
    border-radius: var(--radius-sm);
}

.equipment-footer {
    padding: 16px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
}

.equip-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 16px;
}

.stat-preview {
    text-align: center;
}

.preview-label {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.preview-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
}

.preview-value.gold {
    color: var(--accent-primary);
}

.action-btn-large {
    width: 100%;
    padding: 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 16px;
    font-weight: 600;
    cursor: not-allowed;
    transition: all var(--anim-fast);
}

.action-btn-large.primary {
    background: linear-gradient(135deg, var(--accent-primary), #b8921f);
    color: var(--bg-primary);
    border: none;
    cursor: pointer;
}

.action-btn-large.primary:hover {
    box-shadow: var(--glow-gold);
    transform: translateY(-2px);
}

/* ========== æ¸¸æˆä¸»ç•Œé¢ ========== */
#game-screen {
    background: var(--bg-primary);
    padding-bottom: 80px;
}

/* é¡¶éƒ¨ä¿¡æ¯æ¡ */
.top-info-bar {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    padding: 12px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

.info-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 4px;
    background: var(--bg-card);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.info-icon {
    font-size: 18px;
}

.info-item span:last-child {
    font-size: 11px;
    color: var(--text-secondary);
    text-align: center;
}

/* å®æ™¯åŒºåŸŸ */
.scene-viewer {
    position: relative;
    height: 200px;
    background: linear-gradient(
        180deg,
        #2a3a4a 0%,
        #1a2a3a 50%,
        #0d1a24 100%
    );
    overflow: hidden;
}

.scene-image {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.scene-placeholder {
    text-align: center;
}

.scene-emoji {
    font-size: 80px;
    display: block;
    margin-bottom: 8px;
    filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.2));
}

.scene-altitude {
    font-size: 14px;
    color: var(--text-secondary);
    background: rgba(0, 0, 0, 0.5);
    padding: 4px 12px;
    border-radius: var(--radius-xl);
}

.scene-overlay {
    position: absolute;
    bottom: 12px;
    left: 12px;
}

.location-marker {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0, 0, 0, 0.6);
    padding: 6px 12px;
    border-radius: var(--radius-xl);
    backdrop-filter: blur(4px);
}

.marker-dot {
    width: 8px;
    height: 8px;
    background: var(--accent-success);
    border-radius: 50%;
    animation: pulse-dot 2s ease-in-out infinite;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.2); }
}

.marker-label {
    font-size: 13px;
    color: var(--text-primary);
}

/* çŠ¶æ€æ¡ */
.status-bars {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

.status-item {
    display: flex;
    align-items: center;
    gap: 12px;
}

.status-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: var(--bg-card);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.status-info {
    flex: 1;
}

.status-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.status-bar-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-bar-bg {
    flex: 1;
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-xl);
    overflow: hidden;
}

.status-bar-fill {
    height: 100%;
    border-radius: var(--radius-xl);
    transition: width var(--anim-normal) ease;
}

.status-bar-fill.stamina { background: var(--stamina); }
.status-bar-fill.food { background: var(--food); }
.status-bar-fill.water { background: var(--water); }
.status-bar-fill.temp { background: var(--temp); }

.status-number {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    min-width: 36px;
    text-align: right;
}

/* å±é™©çŠ¶æ€åŠ¨ç”» */
.status-item.critical .status-bar-fill {
    animation: bar-pulse-danger 1s ease-in-out infinite;
}

@keyframes bar-pulse-danger {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.status-item.critical .status-icon {
    animation: icon-shake 0.5s ease-in-out infinite;
    border-color: var(--accent-danger);
}

@keyframes icon-shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

/* çŠ¶æ€æ•ˆæœåŒº */
.status-effects {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-color);
}

.effects-label {
    font-size: 12px;
    color: var(--text-muted);
}

.effects-icons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.effect-badge {
    padding: 4px 10px;
    border-radius: var(--radius-xl);
    font-size: 11px;
    font-weight: 500;
}

.effect-badge.normal {
    background: rgba(74, 155, 94, 0.2);
    color: var(--stamina);
    border: 1px solid rgba(74, 155, 94, 0.3);
}

.effect-badge.warning {
    background: rgba(201, 138, 39, 0.2);
    color: var(--food);
    border: 1px solid rgba(201, 138, 39, 0.3);
    animation: badge-pulse 2s ease-in-out infinite;
}

.effect-badge.danger {
    background: rgba(199, 62, 62, 0.2);
    color: var(--accent-danger);
    border: 1px solid rgba(199, 62, 62, 0.3);
    animation: badge-pulse 1s ease-in-out infinite;
}

@keyframes badge-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* å™äº‹é¢æ¿ */
.narrative-panel {
    flex: 1;
    margin: 16px;
    padding: 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    backdrop-filter: blur(10px);
}

.narrative-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}

.narrative-icon {
    font-size: 16px;
}

.narrative-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.narrative-content {
    font-size: 14px;
    line-height: 1.8;
    color: var(--text-primary);
    font-family: var(--font-title);
}

/* å†³ç­–é¢æ¿ */
.decision-panel {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 0 16px 16px;
}

.decision-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--anim-fast);
    text-align: left;
}

.decision-btn:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-accent);
    transform: translateX(4px);
}

.choice-label {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-weight: 700;
    color: var(--accent-primary);
}

.choice-text {
    flex: 1;
    font-size: 14px;
}

/* åº•éƒ¨å¯¼èˆª */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    display: flex;
    justify-content: space-around;
    padding: 8px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    z-index: 100;
}

.nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 16px;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--anim-fast);
    border-radius: var(--radius-md);
}

.nav-btn:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

.nav-icon {
    font-size: 22px;
}

.nav-label {
    font-size: 11px;
}

/* ========== æ¨¡æ€å±å¹•é€šç”¨æ ·å¼ ========== */
.modal-screen {
    background: var(--bg-primary);
    z-index: 200;
}

.modal-header {
    display: flex;
    align-items: center;
    padding: 16px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

.close-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 28px;
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: all var(--anim-fast);
}

.close-btn:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

.modal-title {
    flex: 1;
    text-align: center;
    font-family: var(--font-title);
    font-size: 18px;
    font-weight: 600;
}

/* ========== åœ°å›¾ç•Œé¢ ========== */
.map-container {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
}

.hand-drawn-map {
    position: relative;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 16px;
    margin-bottom: 16px;
}

.map-svg {
    width: 100%;
    height: auto;
}

.map-nodes {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.map-node {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    transform: translate(-50%, -50%);
}

.map-node .node-num {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: 50%;
    font-size: 12px;
    font-weight: 700;
}

.map-node .node-name {
    margin-top: 4px;
    font-size: 10px;
    color: var(--text-secondary);
    background: rgba(0, 0, 0, 0.6);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    white-space: nowrap;
}

.map-node.completed .node-num {
    background: var(--stamina);
    border-color: var(--stamina);
    color: var(--bg-primary);
}

.map-node.current .node-num {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: var(--bg-primary);
    animation: node-glow 2s ease-in-out infinite;
}

@keyframes node-glow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(201, 162, 39, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(201, 162, 39, 0); }
}

.map-node.locked .node-num {
    background: var(--bg-secondary);
    border-color: var(--text-muted);
    color: var(--text-muted);
}

.elevation-chart {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 16px;
}

.chart-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 12px;
    text-align: center;
}

.chart-bars {
    display: flex;
    justify-content: space-around;
    align-items: flex-end;
    height: 100px;
    gap: 8px;
}

.chart-bar {
    flex: 1;
    background: linear-gradient(to top, var(--accent-secondary), var(--accent-primary));
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    min-height: 20px;
    position: relative;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 4px;
}

.chart-bar span {
    font-size: 9px;
    color: var(--bg-primary);
    font-weight: 600;
    writing-mode: vertical-rl;
    text-orientation: mixed;
}

/* ========== èƒŒåŒ…ç•Œé¢ ========== */
.inventory-weight {
    font-size: 14px;
    color: var(--text-secondary);
}

.inventory-tabs {
    display: flex;
    padding: 12px;
    gap: 8px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

.inv-tab {
    flex: 1;
    padding: 10px;
    background: transparent;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    transition: all var(--anim-fast);
}

.inv-tab:hover {
    background: var(--bg-tertiary);
}

.inv-tab.active {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: var(--bg-primary);
    font-weight: 600;
}

.inventory-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    padding: 16px;
    overflow-y: auto;
}

.inv-slot {
    aspect-ratio: 1;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    cursor: pointer;
    transition: all var(--anim-fast);
    padding: 4px;
}

.inv-slot:hover {
    border-color: var(--border-accent);
    background: var(--bg-tertiary);
}

.inv-slot.selected {
    border-color: var(--accent-primary);
    background: rgba(201, 162, 39, 0.1);
}

.inv-slot.empty {
    background: var(--bg-secondary);
    border-style: dashed;
    cursor: default;
}

.inv-slot .item-icon {
    font-size: 24px;
}

.inv-slot .item-name {
    font-size: 9px;
    color: var(--text-secondary);
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

.inv-slot .item-weight {
    font-size: 8px;
    color: var(--text-muted);
}

.inventory-actions {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
}

.inv-action-btn {
    flex: 1;
    padding: 14px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--anim-fast);
}

.inv-action-btn:hover:not(:disabled) {
    background: var(--bg-card);
    border-color: var(--border-accent);
}

.inv-action-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.inv-action-btn.danger {
    background: rgba(199, 62, 62, 0.2);
    border-color: rgba(199, 62, 62, 0.3);
    color: var(--accent-danger);
}

.inv-action-btn.danger:hover:not(:disabled) {
    background: rgba(199, 62, 62, 0.3);
}

/* ========== äº‹ä»¶å¼¹çª— ========== */
.modal-overlay {
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(4px);
    z-index: 300;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 24px;
}

.modal-overlay.active {
    display: flex;
}

.event-card {
    width: 100%;
    max-width: 360px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 24px;
    animation: card-appear 0.3s ease;
}

@keyframes card-appear {
    0% { transform: scale(0.9); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

.event-visual {
    text-align: center;
    margin-bottom: 20px;
}

.event-icon-large {
    font-size: 64px;
    animation: event-icon-pulse 2s ease-in-out infinite;
}

@keyframes event-icon-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.event-title {
    font-family: var(--font-title);
    font-size: 22px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 12px;
    color: var(--text-primary);
}

.event-desc {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: 24px;
}

.event-choices {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.event-choice-btn {
    padding: 14px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
    transition: all var(--anim-fast);
}

.event-choice-btn:hover {
    background: var(--bg-tertiary);
    border-color: var(--border-accent);
}

.event-choice-btn.primary {
    background: rgba(201, 162, 39, 0.2);
    border-color: var(--accent-primary);
}

.event-choice-btn.danger {
    background: rgba(199, 62, 62, 0.2);
    border-color: rgba(199, 62, 62, 0.5);
    color: var(--accent-danger);
}

/* ========== ä¼‘æ¯ç•Œé¢ ========== */
.rest-content {
    flex: 1;
    padding: 16px;
}

.rest-visual {
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
}

.campfire {
    font-size: 60px;
    animation: fire-flicker 1s ease-in-out infinite alternate;
}

@keyframes fire-flicker {
    0% { transform: scale(1); filter: brightness(1); }
    100% { transform: scale(1.05); filter: brightness(1.2); }
}

.rest-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.rest-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
}

.rest-time {
    font-weight: 600;
    color: var(--text-primary);
}

.rest-effect {
    flex: 1;
    font-size: 13px;
    color: var(--text-secondary);
}

.rest-btn {
    padding: 8px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
    transition: all var(--anim-fast);
}

.rest-btn:hover {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: var(--bg-primary);
}

/* ========== ç§»åŠ¨é€‰æ‹©ç•Œé¢ ========== */
.route-options {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
}

.route-card {
    display: flex;
    gap: 16px;
    padding: 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    margin-bottom: 12px;
}

.route-image {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    font-size: 32px;
}

.route-info {
    flex: 1;
}

.route-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.route-desc {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.route-stats {
    display: flex;
    gap: 12px;
}

.route-stat {
    font-size: 12px;
    color: var(--text-muted);
}

.route-select-btn {
    padding: 10px 20px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
    transition: all var(--anim-fast);
    align-self: center;
}

.route-select-btn:hover {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: var(--bg-primary);
}

/* ========== æ¸¸æˆç»“æŸç•Œé¢ ========== */
#game-over-screen {
    background: var(--bg-primary);
}

.end-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.end-gradient {
    width: 100%;
    height: 100%;
    background: radial-gradient(
        ellipse at center top,
        rgba(201, 162, 39, 0.15) 0%,
        transparent 60%
    );
}

.end-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 24px;
    text-align: center;
}

.end-icon {
    font-size: 80px;
    margin-bottom: 24px;
    animation: end-icon-float 3s ease-in-out infinite;
}

@keyframes end-icon-float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.end-title {
    font-family: var(--font-title);
    font-size: 32px;
    font-weight: 700;
    color: var(--accent-primary);
    margin-bottom: 12px;
}

.end-desc {
    font-size: 15px;
    color: var(--text-secondary);
    margin-bottom: 32px;
    max-width: 300px;
}

.end-stats {
    display: flex;
    gap: 24px;
    margin-bottom: 40px;
}

.end-stat {
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

.end-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 280px;
}

/* ========== æˆå°±ç•Œé¢ ========== */
.achievements-list {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
}

.achievement-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    margin-bottom: 12px;
}

.achievement-item.unlocked {
    border-color: var(--accent-primary);
}

.achievement-item.locked {
    opacity: 0.5;
}

.achievement-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    font-size: 28px;
}

.achievement-item.unlocked .achievement-icon {
    background: rgba(201, 162, 39, 0.2);
}

.achievement-info {
    flex: 1;
}

.achievement-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.achievement-desc {
    font-size: 13px;
    color: var(--text-secondary);
}

.achievement-status {
    font-size: 20px;
}

/* ========== è®¾ç½®ç•Œé¢ ========== */
.settings-list {
    flex: 1;
    padding: 16px;
}

.setting-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    margin-bottom: 12px;
}

.setting-label {
    font-size: 15px;
    color: var(--text-primary);
}

/* å¼€å…³æ ·å¼ */
.toggle {
    position: relative;
    width: 48px;
    height: 26px;
}

.toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-tertiary);
    border-radius: var(--radius-xl);
    transition: background var(--anim-fast);
}

.toggle-slider::before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background: var(--text-secondary);
    border-radius: 50%;
    transition: transform var(--anim-fast), background var(--anim-fast);
}

.toggle input:checked + .toggle-slider {
    background: rgba(201, 162, 39, 0.3);
}

.toggle input:checked + .toggle-slider::before {
    transform: translateX(22px);
    background: var(--accent-primary);
}

/* ========== å…³äºç•Œé¢ ========== */
.about-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    text-align: center;
}

.about-logo {
    font-size: 64px;
    margin-bottom: 16px;
}

.about-game-name {
    font-family: var(--font-title);
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.about-version {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 24px;
}

.about-desc {
    font-size: 14px;
    line-height: 1.8;
    color: var(--text-secondary);
    margin-bottom: 24px;
    max-width: 300px;
}

.about-warning {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: rgba(201, 138, 39, 0.1);
    border: 1px solid rgba(201, 138, 39, 0.3);
    border-radius: var(--radius-md);
}

.warning-icon {
    font-size: 20px;
}

.about-warning p {
    font-size: 13px;
    color: var(--food);
    text-align: left;
    line-height: 1.6;
}

/* ========== æ»šåŠ¨æ¡æ ·å¼ ========== */
::-webkit-scrollbar {
    width: 4px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 2px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
}

/* ========== å“åº”å¼é€‚é… ========== */
@media (max-width: 380px) {
    html {
        font-size: 14px;
    }
    
    .game-title {
        font-size: 44px;
    }
    
    .game-subtitle {
        font-size: 38px;
    }
    
    .scene-viewer {
        height: 160px;
    }
    
    .scene-emoji {
        font-size: 60px;
    }
}

@media (min-width: 481px) {
    #game-container {
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
    }
}

/* ========== åŠ¨ç”»å·¥å…·ç±» ========== */
.fade-in {
    animation: fade-in var(--anim-normal) ease;
}

@keyframes fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
}

.slide-up {
    animation: slide-up var(--anim-normal) ease;
}

@keyframes slide-up {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.shake {
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
}
    </style>
</head>
<body>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        <!-- æ¸¸æˆæ ‡é¢˜ -->
            <h1>ğŸ”ï¸ é³Œå¤ªçº¿æ¨¡æ‹Ÿå™¨</h1>
            <p class="subtitle">ç§¦å²­é³Œå±±-å¤ªç™½å±±ç©¿è¶Šç”Ÿå­˜æŒ‘æˆ˜ v2.0</p>
        </header>

        <!-- ä¸»èœå• -->
        <div id="main-menu" class="screen active">
            <div class="menu-content">
                <div class="mountain-icon">â›°ï¸</div>
                <h2>å‡†å¤‡å¼€å§‹ä½ çš„é³Œå¤ªç©¿è¶Šä¹‹æ—…</h2>
                <p class="intro-text">
                    é³Œå¤ªçº¿æ˜¯ä¸­å›½æœ€å…·æŒ‘æˆ˜æ€§çš„å¾’æ­¥è·¯çº¿ä¹‹ä¸€ã€‚<br>
                    å…¨ç¨‹59å…¬é‡Œï¼Œç´¯è®¡çˆ¬å‡2075ç±³ï¼Œæœ€é«˜æµ·æ‹”3475ç±³ã€‚<br>
                    ä½ éœ€è¦ç®¡ç†ä½“åŠ›ã€é£Ÿç‰©å’Œæ°´æºï¼Œåº”å¯¹æ¶åŠ£å¤©æ°”ï¼Œ<br>
                    ç©¿è¶Š8ä¸ªå±é™©èŠ‚ç‚¹ï¼Œæœ€ç»ˆåˆ°è¾¾å¤ªç™½å±±æ™¯åŒºã€‚
                </p>
                <div class="danger-warning">
                    âš ï¸ è­¦å‘Šï¼šé³Œå¤ªçº¿å¹´å‡æ•°èµ·é‡éš¾äº‹æ•…ï¼Œè¯·è°¨æ…å†³ç­–ï¼
                </div>
                <div class="menu-buttons">
                    <button id="btn-new-game" class="btn btn-primary">ğŸ® å¼€å§‹æ–°æ¸¸æˆ</button>
                    <button id="btn-continue" class="btn btn-secondary" disabled>ğŸ“‚ ç»§ç»­æ¸¸æˆ</button>
                    <button id="btn-achievements" class="btn btn-warning">ğŸ† æˆå°±</button>
                    <button id="btn-help" class="btn btn-info">â“ æ¸¸æˆè¯´æ˜</button>
                </div>
            </div>
        </div>

        <!-- è£…å¤‡é€‰æ‹©ç•Œé¢ -->
        <div id="equipment-screen" class="screen">
            <h2>ğŸ’ é€‰æ‹©ä½ çš„è£…å¤‡</h2>
            <p class="hint">åˆç†æ­é…è£…å¤‡ï¼Œè´Ÿé‡ä¼šå½±å“ç§»åŠ¨æ¶ˆè€—ã€‚æ¶åŠ£å¤©æ°”éœ€è¦æ›´å¥½çš„è£…å¤‡ï¼</p>
            
            <div class="equipment-categories">
                <div class="category">
                    <h3>ğŸ’ èƒŒåŒ…</h3>
                    <div class="item-list" id="backpack-list"></div>
                </div>
                <div class="category">
                    <h3>ğŸ‘• è¡£ç‰©</h3>
                    <div class="item-list" id="clothing-list"></div>
                </div>
                <div class="category">
                    <h3>ğŸ”§ å·¥å…·</h3>
                    <div class="item-list" id="tool-list"></div>
                </div>
                <div class="category">
                    <h3>ğŸ– é£Ÿç‰©</h3>
                    <div class="item-list" id="food-list"></div>
                </div>
                <div class="category">
                    <h3>ğŸ’§ æ°´æº</h3>
                    <div class="item-list" id="water-list"></div>
                </div>
            </div>

            <div class="equipment-summary">
                <div class="stat-row">
                    <span>å·²é€‰è£…å¤‡:</span>
                    <span id="selected-count">0</span>
                </div>
                <div class="stat-row">
                    <span>æ€»è´Ÿé‡:</span>
                    <span id="total-weight">0</span> kg
                </div>
                <div class="stat-row">
                    <span>å‰©ä½™ç‚¹æ•°:</span>
                    <span id="remaining-points">100</span>
                </div>
            </div>

            <div class="action-buttons">
                <button id="btn-start-journey" class="btn btn-primary" disabled>ğŸš€ å¼€å§‹ç©¿è¶Š</button>
                <button id="btn-back-menu" class="btn btn-secondary">â†©ï¸ è¿”å›</button>
            </div>
        </div>

        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <div id="game-screen" class="screen">
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar">
                <div class="location-info">
                    <span class="location-icon">ğŸ“</span>
                    <span id="current-location">å¡˜å£æ‘</span>
                </div>
                <div class="day-info">
                    <span>ç¬¬ <span id="current-day">1</span> å¤©</span>
                    <span id="current-weather">â˜€ï¸ æ™´å¤© 15Â°C</span>
                </div>
            </div>

            <!-- è¯¦ç»†çŠ¶æ€é¢æ¿ -->
            <div class="detailed-status">
                <div class="status-row">
                    <div class="status-item">
                        <span class="status-label">ğŸŒ¡ï¸ ä½“æ¸©</span>
                        <span class="status-value" id="body-temp">37.0Â°C</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ğŸ’¦ æ¹¿èº«</span>
                        <span class="status-value" id="wetness">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ğŸ˜« ç–²åŠ³</span>
                        <span class="status-value" id="fatigue">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ğŸ§  ç†æ™º</span>
                        <span class="status-value" id="sanity">100%</span>
                    </div>
                </div>
                <div class="status-effects" id="status-effects">
                    <!-- çŠ¶æ€æ•ˆæœæ ‡ç­¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- èµ„æºé¢æ¿ -->
            <div class="resources-panel">
                <div class="resource-item">
                    <span class="resource-icon">ğŸ’ª</span>
                    <div class="resource-bar">
                        <div id="stamina-bar" class="bar-fill stamina" style="width: 100%"></div>
                    </div>
                    <span id="stamina-value">100</span>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">ğŸ–</span>
                    <div class="resource-bar">
                        <div id="food-bar" class="bar-fill food" style="width: 100%"></div>
                    </div>
                    <span id="food-value">100</span>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">ğŸ’§</span>
                    <div class="resource-bar">
                        <div id="water-bar" class="bar-fill water" style="width: 100%"></div>
                    </div>
                    <span id="water-value">100</span>
                </div>
                <div class="resource-item">
                    <span class="resource-icon">ğŸ˜Š</span>
                    <div class="resource-bar">
                        <div id="mood-bar" class="bar-fill mood" style="width: 100%"></div>
                    </div>
                    <span id="mood-value">50</span>
                </div>
            </div>

            <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
            <div class="game-main">
                <!-- åœ°å›¾åŒºåŸŸ -->
                <div class="map-section">
                    <h3>ğŸ—ºï¸ è·¯çº¿å›¾</h3>
                    <div id="map-container" class="map-container">
                        <!-- åœ°å›¾èŠ‚ç‚¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- äº‹ä»¶æ—¥å¿— -->
                <div class="log-section">
                    <h3>ğŸ“œ äº‹ä»¶æ—¥å¿—</h3>
                    <div id="event-log" class="event-log">
                        <div class="log-entry">æ¬¢è¿æ¥åˆ°é³Œå¤ªçº¿ï¼å‡†å¤‡å¥½å¼€å§‹ä½ çš„ç©¿è¶Šä¹‹æ—…äº†å—ï¼Ÿ</div>
                    </div>
                </div>
            </div>

            <!-- è¡ŒåŠ¨æŒ‰é’® -->
            <div class="action-panel">
                <button id="btn-move" class="btn btn-primary">ğŸš¶ å‰è¿›</button>
                <button id="btn-rest" class="btn btn-secondary">ğŸ˜´ ä¼‘æ¯</button>
                <button id="btn-eat" class="btn btn-success">ğŸ½ï¸ è¿›é£Ÿ</button>
                <button id="btn-drink" class="btn btn-info">ğŸ¥¤ å–æ°´</button>
                <button id="btn-inventory" class="btn btn-warning">ğŸ’ èƒŒåŒ…</button>
                <button id="btn-save" class="btn btn-save">ğŸ’¾ å­˜æ¡£</button>
            </div>
        </div>

        <!-- ç§»åŠ¨é€‰æ‹©ç•Œé¢ -->
        <div id="move-screen" class="screen modal">
            <div class="modal-content">
                <h3>é€‰æ‹©å‰è¿›è·¯çº¿</h3>
                <div id="route-options" class="route-options">
                    <!-- è·¯çº¿é€‰é¡¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button id="btn-cancel-move" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- äº‹ä»¶ç•Œé¢ -->
        <div id="event-screen" class="screen modal">
            <div class="modal-content">
                <div id="event-icon" class="event-icon">âš¡</div>
                <h3 id="event-title">äº‹ä»¶å‘ç”Ÿ</h3>
                <p id="event-description">äº‹ä»¶æè¿°...</p>
                <div id="event-choices" class="event-choices">
                    <!-- é€‰é¡¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- èƒŒåŒ…ç•Œé¢ -->
        <div id="inventory-screen" class="screen modal">
            <div class="modal-content">
                <h3>ğŸ’ èƒŒåŒ…</h3>
                <div id="inventory-list" class="inventory-list">
                    <!-- ç‰©å“åˆ—è¡¨ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button id="btn-close-inventory" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>

        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <div id="game-over-screen" class="screen modal">
            <div class="modal-content">
                <div id="end-icon" class="end-icon">ğŸ†</div>
                <h2 id="end-title">æ¸¸æˆç»“æŸ</h2>
                <p id="end-description">...</p>
                <div id="end-stats" class="end-stats">
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                </div>
                <div class="action-buttons">
                    <button id="btn-restart" class="btn btn-primary">ğŸ”„ é‡æ–°å¼€å§‹</button>
                    <button id="btn-main-menu" class="btn btn-secondary">ğŸ“‹ ä¸»èœå•</button>
                </div>
            </div>
        </div>

        <!-- å¸®åŠ©ç•Œé¢ -->
        <div id="help-screen" class="screen modal">
            <div class="modal-content">
                <h2>ğŸ“– æ¸¸æˆè¯´æ˜</h2>
                <div class="help-content">
                    <h4>ğŸ¯ æ¸¸æˆç›®æ ‡</h4>
                    <p>ä»å¡˜å£æ‘å‡ºå‘ï¼Œç©¿è¶Š8ä¸ªèŠ‚ç‚¹ï¼Œæœ€ç»ˆåˆ°è¾¾å¤ªç™½å±±æ™¯åŒºã€‚å…¨ç¨‹59å…¬é‡Œï¼Œæœ€é«˜æµ·æ‹”3475ç±³ã€‚</p>
                    
                    <h4>ğŸ“Š æ ¸å¿ƒå±æ€§</h4>
                    <ul>
                        <li><strong>ä½“åŠ›å€¼ï¼š</strong>ç§»åŠ¨å’Œåº”å¯¹äº‹ä»¶ä¼šæ¶ˆè€—ï¼Œä¼‘æ¯å¯æ¢å¤</li>
                        <li><strong>é¥±é£Ÿåº¦ï¼š</strong>æ¯å¤©è‡ªåŠ¨æ¶ˆè€—ï¼Œè¿›é£Ÿå¯è¡¥å……</li>
                        <li><strong>æ°´åˆ†å€¼ï¼š</strong>ç§»åŠ¨å’Œå¤©æ°”å½±å“æ¶ˆè€—ï¼Œå–æ°´å¯è¡¥å……</li>
                        <li><strong>å¿ƒæƒ…å€¼ï¼š</strong>å½±å“äº‹ä»¶ç»“æœï¼ŒæˆåŠŸç§»åŠ¨å’Œä¼‘æ¯å¯æå‡</li>
                        <li><strong>ä½“æ¸©ï¼š</strong>å—å¤©æ°”å’Œæ¹¿èº«å½±å“ï¼Œ35-42Â°Cä¸ºæ­£å¸¸èŒƒå›´</li>
                        <li><strong>æ¹¿èº«ç¨‹åº¦ï¼š</strong>é›¨å¤©æˆ–æ¶‰æ°´ä¼šå¢åŠ ï¼Œå¯¼è‡´ä½“æ¸©æµå¤±</li>
                        <li><strong>ç–²åŠ³åº¦ï¼š</strong>ç§»åŠ¨ç´¯ç§¯ï¼Œè¿‡é«˜ä¼šå½±å“åˆ¤æ–­åŠ›</li>
                        <li><strong>ç†æ™ºå€¼ï¼š</strong>ææ…Œæˆ–æ¶åŠ£ç¯å¢ƒä¼šé™ä½ï¼Œå½±å“å†³ç­–</li>
                    </ul>
                    
                    <h4>ğŸŒ¤ï¸ å¤©æ°”ç³»ç»Ÿ</h4>
                    <ul>
                        <li><strong>æ™´å¤©ï¼š</strong>æ­£å¸¸ç§»åŠ¨ï¼Œæ³¨æ„é˜²æ™’å’Œè¡¥æ°´</li>
                        <li><strong>å¤šäº‘ï¼š</strong>å¤©æ°”å‡‰çˆ½ï¼Œé€‚åˆè¡Œè¿›</li>
                        <li><strong>å°é›¨ï¼š</strong>ç§»åŠ¨æ¶ˆè€—+20%ï¼Œè·¯é¢æ¹¿æ»‘</li>
                        <li><strong>å¤§é›¨ï¼š</strong>ç§»åŠ¨æ¶ˆè€—+50%ï¼Œå¤±æ¸©é£é™©å¢åŠ </li>
                        <li><strong>å¤§é›¾ï¼š</strong>ææ˜“è¿·è·¯ï¼Œç§»åŠ¨æ¶ˆè€—+40%</li>
                        <li><strong>å°é›ªï¼š</strong>ç§»åŠ¨æ¶ˆè€—+60%ï¼Œå¯’å†·åˆºéª¨</li>
                        <li><strong>æš´é£é›ªï¼š</strong>æåº¦å±é™©ï¼Œç§»åŠ¨æ¶ˆè€—+150%ï¼Œå¯èƒ½è‡´å‘½</li>
                        <li><strong>é›·æš´ï¼š</strong>å±±è„Šæåº¦å±é™©ï¼Œæœ‰é›·å‡»é£é™©</li>
                    </ul>
                    
                    <h4>â›°ï¸ åœ°å½¢ç³»ç»Ÿ</h4>
                    <ul>
                        <li><strong>è‰ç”¸ï¼š</strong>å¹³å¦ï¼Œè¡Œèµ°èˆ’é€‚</li>
                        <li><strong>ç¢çŸ³å¡ï¼š</strong>å®¹æ˜“æ‰­ä¼¤ï¼Œç§»åŠ¨ç¼“æ…¢</li>
                        <li><strong>é™¡å³­å²©å£ï¼š</strong>éœ€è¦æ”€çˆ¬ï¼Œææ˜“æ»‘å </li>
                        <li><strong>å±±è„Šï¼š</strong>é£å¤§å¯’å†·ï¼Œæš´éœ²æ„Ÿå¼º</li>
                        <li><strong>çŒæœ¨ä¸›ï¼š</strong>å¯èƒ½æœ‰é‡ç”ŸåŠ¨ç‰©</li>
                        <li><strong>ç§¯é›ªåŒºï¼š</strong>æ·±é›ªéš¾è¡Œï¼Œå®¹æ˜“å¤±æ¸©</li>
                        <li><strong>æµçŸ³æ»©ï¼š</strong>ç¢çŸ³æµåŠ¨ï¼Œæåº¦å±é™©</li>
                    </ul>
                    
                    <h4>âš ï¸ çŠ¶æ€æ•ˆæœ</h4>
                    <ul>
                        <li><strong>ä¸­æš‘ï¼š</strong>ä½“æ¸©è¿‡é«˜ï¼Œåˆ¤æ–­åŠ›ä¸‹é™</li>
                        <li><strong>å¤±æ¸©ï¼š</strong>ä½“æ¸©è¿‡ä½ï¼Œå¯èƒ½è‡´å‘½</li>
                        <li><strong>é«˜åŸååº”ï¼š</strong>æµ·æ‹”3000mä»¥ä¸Šå¸¸è§</li>
                        <li><strong>å—ä¼¤ï¼š</strong>ç§»åŠ¨é€Ÿåº¦é™ä½</li>
                        <li><strong>ææ…Œï¼š</strong>åˆ¤æ–­åŠ›å¤§å¹…ä¸‹é™</li>
                        <li><strong>è„±æ°´ï¼š</strong>ä¸¥é‡ç¼ºæ°´</li>
                        <li><strong>å†»ä¼¤ï¼š</strong>è‚¢ä½“å†»ä¼¤ï¼Œè¡ŒåŠ¨å›°éš¾</li>
                        <li><strong>æ¹¿èº«ï¼š</strong>ä½“æ¸©æµå¤±åŠ å¿«</li>
                    </ul>
                    
                    <h4>ğŸ’ è£…å¤‡æ•ˆæœ</h4>
                    <ul>
                        <li><strong>èƒŒåŒ…ï¼š</strong>å¢åŠ æºå¸¦å®¹é‡</li>
                        <li><strong>è¡£ç‰©ï¼š</strong>ä¿æš–ã€é˜²é›¨ã€å½±å“æ¹¿èº«æ¢å¤</li>
                        <li><strong>ç™»å±±æ–ï¼š</strong>èŠ‚çœ20%ä½“åŠ›æ¶ˆè€—</li>
                        <li><strong>æŒ‡å—é’ˆ/GPSï¼š</strong>é™ä½è¿·è·¯æ¦‚ç‡</li>
                        <li><strong>æ€¥æ•‘åŒ…ï¼š</strong>æ²»ç–—ä¼¤åŠ¿</li>
                        <li><strong>ç»³ç´¢ï¼š</strong>é™ä½æ”€çˆ¬é£é™©</li>
                        <li><strong>å¤´ç¯ï¼š</strong>å¤œé—´è¡ŒåŠ¨</li>
                    </ul>
                    
                    <h4>ğŸ… æˆå°±ç³»ç»Ÿ</h4>
                    <p>å®Œæˆç‰¹å®šæŒ‘æˆ˜å¯è§£é”æˆå°±ï¼Œæˆå°±å°†æ°¸ä¹…ä¿å­˜ï¼š</p>
                    <ul>
                        <li><strong>ç”Ÿå­˜ç±»ï¼š</strong>æé€Ÿç©¿è¶Šã€è½»è£…ä¸Šé˜µã€é“äººæ¨¡å¼ã€ç”Ÿå­˜ä¸“å®¶</li>
                        <li><strong>æ¢ç´¢ç±»ï¼š</strong>æ‘„å½±å¸ˆã€æ¢ç´¢è€…ã€éœ²è¥å¤§å¸ˆ</li>
                        <li><strong>é“å¾·ç±»ï¼š</strong>åŠ©äººä¸ºä¹ã€æ•¬ç•è‡ªç„¶ã€ç¯ä¿å«å£«</li>
                        <li><strong>ç‰¹æ®Šç±»ï¼š</strong>æš´é£é›ªå¹¸å­˜è€…ã€å®Œç¾é€šå…³ã€å¹¸è¿å„¿ã€é‡å¤–åŒ»ç”Ÿã€å¯¼èˆªä¸“å®¶</li>
                    </ul>
                    
                    <h4>ğŸ’¡ ç”Ÿå­˜æŠ€å·§</h4>
                    <ul>
                        <li>åˆç†è§„åˆ’è·¯çº¿ï¼Œä¸è¦è´¸ç„¶å†’é™©</li>
                        <li>æ³¨æ„å¤©æ°”å˜åŒ–ï¼Œæ¶åŠ£å¤©æ°”æ—¶ä¼‘æ¯</li>
                        <li>ä¿æŒä½“æ¸©ï¼Œæ¹¿èº«æ—¶å°½å¿«æ›´æ¢è¡£ç‰©æˆ–ç”Ÿç«</li>
                        <li>é«˜æµ·æ‹”åœ°åŒºæ³¨æ„é«˜åŸååº”</li>
                        <li>ä¿æŒèµ„æºå¹³è¡¡ï¼Œä¸è¦è¿‡åº¦æ¶ˆè€—</li>
                        <li>è¥åœ°å¯ä»¥æ›´å¥½åœ°æ¢å¤ä½“åŠ›</li>
                        <li>å¸®åŠ©ä»–äººå¯èƒ½è·å¾—é“å¾·åŠ æˆ</li>
                    </ul>
                    
                    <h4>âš¡ è¿é”ååº”ç¤ºä¾‹</h4>
                    <p><strong>å¤§é›¾å¤©æ°” â†’ è¿·è·¯ â†’ é€‰æ‹©é”™è¯¯è·¯çº¿ â†’ è¿›å…¥å±é™©åœ°å½¢ â†’ æ»‘å  â†’ å—ä¼¤ â†’ ç§»åŠ¨é€Ÿåº¦ä¸‹é™ â†’ æ— æ³•åœ¨å¤©é»‘å‰åˆ°è¾¾è¥åœ° â†’ å¤œé—´è¢«è¿«æ‰è¥ â†’ å¤±æ¸©é£é™©å¢åŠ  â†’ ç”Ÿæ­»æŠ‰æ‹©</strong></p>
                    
                    <h4>ğŸ“· å®æ™¯æŸ¥çœ‹ä¸ç›¸å†Œç³»ç»Ÿ</h4>
                    <ul>
                        <li><strong>å®æ™¯æŸ¥çœ‹ï¼š</strong>ç‚¹å‡»"ğŸ“· å®æ™¯"æŒ‰é’®æŸ¥çœ‹å½“å‰èŠ‚ç‚¹çš„é£æ™¯ï¼Œæ¶ˆè€—15åˆ†é’Ÿï¼Œæ¢å¤5-15å¿ƒæƒ…å€¼</li>
                        <li><strong>æ‹ç…§ç•™å¿µï¼š</strong>åœ¨å®æ™¯æŸ¥çœ‹æ—¶æ‹ç…§ï¼Œä¿å­˜åˆ°ç›¸å†Œï¼Œè·å¾—é¢å¤–å¿ƒæƒ…å¥–åŠ±</li>
                        <li><strong>é£æ™¯ç›¸å†Œï¼š</strong>ä¸»èœå•å¯æŸ¥çœ‹æ”¶é›†çš„æ‰€æœ‰ç…§ç‰‡ï¼ŒæŒ‰èŠ‚ç‚¹åˆ†ç±»</li>
                        <li><strong>ç‰¹æ®Šæ™¯è§‚ï¼š</strong>ç‰¹å®šå¤©æ°”å’Œæ—¶é—´æ¡ä»¶ä¸‹å¯è§¦å‘ç‰¹æ®Šé£æ™¯äº‹ä»¶
                            <ul>
                                <li>â˜€ï¸ æ™´å¤©+é³Œå±±å¤§æ¢ = äº‘æµ·å¥‡è§‚</li>
                                <li>ğŸŒ  å¤œé—´+2900è¥åœ° = æµæ˜Ÿé›¨</li>
                                <li>ğŸŒ«ï¸ å¤§é›¾+å¯¼èˆªæ¶ = ç¥ç§˜æ°›å›´</li>
                                <li>â„ï¸ é›ªå¤©+è¯ç‹åº™ = é›ªä¸­å¤åº™</li>
                                <li>ğŸŒ… é»„æ˜+æ°´çªå­è¥åœ° = é‡‘è‰²å¤•é˜³</li>
                                <li>ğŸ¦… æ™´å¤©+éº¦ç§¸å²­ = é›„é¹°å±•ç¿…</li>
                            </ul>
                        </li>
                        <li><strong>æ‘„å½±å¸ˆæˆå°±ï¼š</strong>æ”¶é›†æ‰€æœ‰9ä¸ªèŠ‚ç‚¹çš„ç…§ç‰‡è§£é”</li>
                    </ul>
                </div>
                <button id="btn-close-help" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>

        <!-- æˆå°±ç•Œé¢ -->
        <div id="achievements-screen" class="screen modal">
            <div class="modal-content">
                <h2>ğŸ† æˆå°±</h2>
                <div id="achievements-list" class="achievements-list">
                    <!-- æˆå°±åˆ—è¡¨ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button id="btn-close-achievements" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="visuals.js"></script>
    <script src="game.js"></script>
    <script src="scenery.js"></script>
<script>
/**
 * é³Œå¤ªçº¿æ¨¡æ‹Ÿå™¨ - è§†è§‰å¢å¼ºç³»ç»Ÿ
 * åŒ…å«èŠ‚ç‚¹å®æ™¯ã€å¤©æ°”æ•ˆæœã€å®æ™¯æŸ¥çœ‹åŠŸèƒ½
 */

// ==================== èŠ‚ç‚¹å®æ™¯æ•°æ® ====================

const NODE_SCENERY = {
    0: {
        name: "å¡˜å£æ‘",
        emojiScene: "ğŸ˜ï¸ğŸŒ²ğŸ”ï¸",
        description: "ç§¦å²­è„šä¸‹çš„å®é™æ‘åº„ï¼Œé³Œå¤ªç©¿è¶Šçš„èµ·ç‚¹ã€‚æ‘å£ç«‹ç€ä¸€å—çŸ³ç¢‘ï¼Œä¸Šé¢å†™ç€'é³Œå¤ªçº¿å¾’æ­¥èµ·ç‚¹'ã€‚æ¸…æ™¨çš„è–„é›¾ç¬¼ç½©ç€è¿œå±±ï¼Œæ‘æ°‘ä»¬å·²ç»å¼€å§‹äº†ä¸€å¤©çš„åŠ³ä½œã€‚",
        features: ["èµ·ç‚¹çŸ³ç¢‘", "å†œå®¶å°é™¢", "è¡¥ç»™å•†åº—", "å±±é—´æ™¨é›¾"],
        atmosphere: "å®é™ç¥¥å’Œï¼Œå……æ»¡æœŸå¾…",
        specialEvent: "æ‘æ°‘ä¼šä¸ºä½ é€ä¸Šç¥ç¦"
    },
    1: {
        name: "ç«çƒ§å¡",
        emojiScene: "ğŸ”¥â›°ï¸ğŸŒ¿",
        description: "é™¡å³­çš„å±±å¡ä¸Šç•™æœ‰æ˜æ˜¾çš„ç«çƒ§ç—•è¿¹ï¼Œæ¯é»‘çš„æ ‘å¹²ä¸æ–°ç”Ÿç»¿æ„å½¢æˆé²œæ˜å¯¹æ¯”ã€‚è¿™é‡Œæ›¾æ˜¯å±±ç«è‚†è™çš„åœ°æ–¹ï¼Œå¦‚ä»Šé‡èŠ±ç‚¹ç¼€å…¶é—´ï¼Œå±•ç°ç€ç”Ÿå‘½çš„é¡½å¼ºã€‚",
        features: ["ç«çƒ§ç—•è¿¹", "é™¡å³­å±±å¡", "é‡èŠ±ç‚¹ç¼€", "å¼€é˜”è§†é‡"],
        atmosphere: "è‹å‡‰ä¸­å¸¦ç€ç”Ÿæœº",
        specialEvent: "å‘ç°å±±ç«åé‡ç”Ÿçš„é‡èŠ±"
    },
    2: {
        name: "2900è¥åœ°",
        emojiScene: "â›ºğŸŒ²âœ¨",
        description: "æµ·æ‹”2900ç±³çš„ç†æƒ³è¥åœ°ï¼Œå››å‘¨è¢«å†·æ‰ç¯ç»•ã€‚å¤œå¹•é™ä¸´ï¼Œæ»¡å¤©ç¹æ˜Ÿä»¿ä½›è§¦æ‰‹å¯åŠã€‚å¸ç¯·ç‚¹ç¼€å…¶é—´ï¼Œç¯ç«æ˜ ç…§ç€å¾’æ­¥è€…ä»¬ç–²æƒ«å´æ»¡è¶³çš„è„¸åºã€‚",
        features: ["å¹³å¦è¥åœ°", "å†·æ‰æ—", "æ˜Ÿç©ºå¤œæ™¯", "å±±æ³‰æ°´æº"],
        atmosphere: "é™è°§å®‰è¯¦ï¼Œæ˜Ÿç©ºç’€ç’¨",
        specialEvent: "æµæ˜Ÿé›¨åˆ’è¿‡å¤œç©º"
    },
    3: {
        name: "é³Œå±±å¤§æ¢",
        emojiScene: "ğŸ”ï¸â˜ï¸ğŸŒ¾",
        description: "è¡Œèµ°åœ¨é³Œå±±ä¸»è„Šä¹‹ä¸Šï¼Œä¸¤ä¾§æ˜¯é™¡å³­çš„æ‚¬å´–ã€‚é«˜å±±è‰ç”¸åœ¨è„šä¸‹é“ºå±•ï¼Œäº‘æµ·åœ¨èº«æ—ç¿»æ¶Œã€‚è¿™é‡Œæ˜¯é³Œå¤ªçº¿æœ€å£®ä¸½çš„æ®µè½ï¼Œä¹Ÿæ˜¯æœ€å…·æŒ‘æˆ˜çš„è·¯æ®µã€‚",
        features: ["é«˜å±±è‰ç”¸", "äº‘æµ·ç¿»æ¶Œ", "æ‚¬å´–å³­å£", "å±±è„Šè¡Œèµ°"],
        atmosphere: "å£®é˜”éœ‡æ’¼ï¼Œå±æœºå››ä¼",
        specialEvent: "äº‘æµ·çªç„¶æ•£å¼€ï¼Œéœ²å‡ºä¸‡ä¸ˆæ·±æ¸Š"
    },
    4: {
        name: "å¯¼èˆªæ¶",
        emojiScene: "ğŸ—¼ğŸ“ğŸŒ«ï¸",
        description: "æ ‡å¿—æ€§çš„å¯¼èˆªæ¶çŸ—ç«‹åœ¨å±±é¡¶ï¼Œæ˜¯é³Œå¤ªçº¿æœ€è‘—åçš„åœ°æ ‡ã€‚è¿™åº§é‡‘å±æ¶æ˜¯æ•‘æ´å¯¼èˆªçš„é‡è¦æ ‡å¿—ï¼Œä¹Ÿæ˜¯æ¯ä¸€ä½ç©¿è¶Šè€…å¿…æ‰“å¡çš„åœ°ç‚¹ã€‚å‘¨å›´å¸¸æœ‰å¤§é›¾å¼¥æ¼«ã€‚",
        features: ["é‡‘å±å¯¼èˆªæ¶", "åœ°æ ‡æ‰“å¡", "360åº¦è§‚æ™¯", "å¸¸å¹´å¤§é›¾"],
        atmosphere: "ç¥ç§˜è«æµ‹ï¼Œæ ‡å¿—æ€§åœ°ç‚¹",
        specialEvent: "åœ¨å¯¼èˆªæ¶ä¸‹å‘ç°å‰äººç•™ä¸‹çš„çºªå¿µç‰Œ"
    },
    5: {
        name: "è¯ç‹åº™",
        emojiScene: "â›©ï¸ğŸ—¿ğŸ‚",
        description: "åºŸå¼ƒçš„è¯ç‹åº™ä¾›å¥‰ç€è¯ç‹å­™æ€é‚ˆï¼Œæ–‘é©³çš„å¢™å£è¯‰è¯´ç€å²æœˆæ²§æ¡‘ã€‚çŸ³ç¢‘ä¸Šåˆ»ç€çš„å­—è¿¹å·²ç»æ¨¡ç³Šï¼Œä½†é¦™ç«ç—•è¿¹æ˜¾ç¤ºä»æœ‰äººå‰æ¥ç¥­æ‹œã€‚è¿™é‡Œæ˜¯éš¾å¾—çš„é¿é£å¤„ã€‚",
        features: ["åºŸå¼ƒåº™å®‡", "è¯ç‹çŸ³ç¢‘", "é¿é£å¤„", "å†å²ç—•è¿¹"],
        atmosphere: "å¤æœ´ç¥ç§˜ï¼Œåº„ä¸¥è‚ƒç©†",
        specialEvent: "å‘ç°å¤è€çš„è¯æå›¾è°±"
    },
    6: {
        name: "éº¦ç§¸å²­",
        emojiScene: "ğŸ§—â€â™‚ï¸â›°ï¸ğŸ¦…",
        description: "é™¡å³­çš„å²©å£å¦‚åŒéº¦ç§¸èˆ¬è€¸ç«‹ï¼Œéœ€è¦æ‰‹è„šå¹¶ç”¨æ‰èƒ½æ”€çˆ¬ã€‚è¿™é‡Œæ˜¯é³Œå¤ªçº¿æœ€é™©å³»çš„è·¯æ®µä¹‹ä¸€ï¼Œå²©çŸ³è£¸éœ²ï¼Œå°‘æœ‰æ¤è¢«ã€‚æŠ¬å¤´å¯è§é›„é¹°åœ¨å¤´é¡¶ç›˜æ—‹ã€‚",
        features: ["é™¡å³­å²©å£", "éœ€è¦æ”€çˆ¬", "è£¸éœ²å²©çŸ³", "é›„é¹°ç›˜æ—‹"],
        atmosphere: "é™©å³»åˆºæ¿€ï¼Œè‚¾ä¸Šè…ºç´ é£™å‡",
        specialEvent: "å‘ç°å²©å£ä¸Šçš„å¤è€å²©ç”»"
    },
    7: {
        name: "æ°´çªå­è¥åœ°",
        emojiScene: "ğŸ’§â›ºğŸ•ï¸",
        description: "é³Œå¤ªçº¿ä¸Šæœ€ä¼˜è´¨çš„è¥åœ°ï¼Œæ°´æºå……è¶³ä¸”æ¸…æ¾ˆç”˜ç”œã€‚å‘¨å›´åœ°åŠ¿å¹³å¦ï¼Œé¿é£è‰¯å¥½ã€‚å‚æ™šæ—¶åˆ†ï¼Œå¤•é˜³å°†æ•´ç‰‡è¥åœ°æŸ“æˆé‡‘è‰²ï¼Œæ˜¯å…¨ç¨‹æœ€ç¾çš„éœ²è¥åœ°ç‚¹ã€‚",
        features: ["ä¼˜è´¨æ°´æº", "å¹³å¦è¥åœ°", "é¿é£ä½ç½®", "é‡‘è‰²å¤•é˜³"],
        atmosphere: "èˆ’é€‚æƒ¬æ„ï¼Œè¡¥ç»™å……è¶³",
        specialEvent: "å‘ç°æ¸©æ³‰çœ¼ï¼Œå¯ä»¥æ³¡è„šæ”¾æ¾"
    },
    8: {
        name: "å¤ªç™½å±±æ™¯åŒº",
        emojiScene: "ğŸğŸ‰ğŸ”ï¸",
        description: "ç»ˆç‚¹ï¼å¤ªç™½å±±æ™¯åŒºçš„å…¥å£å°±åœ¨å‰æ–¹ã€‚æ¸¸å®¢ä¸­å¿ƒçš„å»ºç­‘æ¸…æ™°å¯è§ï¼Œä½ çš„é³Œå¤ªç©¿è¶Šä¹‹æ—…å³å°†ç”»ä¸Šåœ†æ»¡çš„å¥å·ã€‚å›é¦–æ¥è·¯ï¼Œæˆå°±æ„Ÿæ²¹ç„¶è€Œç”Ÿã€‚",
        features: ["æ¸¸å®¢ä¸­å¿ƒ", "ç»ˆç‚¹æ ‡å¿—", "å®Œå–„è®¾æ–½", "èƒœåˆ©åœ¨æœ›"],
        atmosphere: "å–œæ‚¦æ¿€åŠ¨ï¼Œæˆå°±æ„Ÿæ»¡æ»¡",
        specialEvent: "è·å¾—ç©¿è¶Šè¯ä¹¦ï¼Œåˆå½±ç•™å¿µ"
    }
};

// ==================== å¤©æ°”è§†è§‰é…ç½® ====================

const WEATHER_VISUALS = {
    sunny: {
        name: "æ™´å¤©",
        icon: "â˜€ï¸",
        bgGradient: "linear-gradient(180deg, #4a90d9 0%, #87ceeb 50%, #e8f4f8 100%)",
        animation: "sunshine",
        particleEffect: null,
        visibility: "excellent",
        moodBonus: 5
    },
    cloudy: {
        name: "å¤šäº‘",
        icon: "â˜ï¸",
        bgGradient: "linear-gradient(180deg, #5a6c7d 0%, #8fa3b8 50%, #c5d1db 100%)",
        animation: "clouds",
        particleEffect: "cloud",
        visibility: "good",
        moodBonus: 0
    },
    light_rain: {
        name: "å°é›¨",
        icon: "ğŸŒ¦ï¸",
        bgGradient: "linear-gradient(180deg, #3d4f5f 0%, #5a6c7d 50%, #7a8fa3 100%)",
        animation: "rain",
        particleEffect: "rain-light",
        visibility: "normal",
        moodBonus: -2
    },
    heavy_rain: {
        name: "å¤§é›¨",
        icon: "ğŸŒ§ï¸",
        bgGradient: "linear-gradient(180deg, #2a3a4a 0%, #3d4f5f 50%, #4a5a6a 100%)",
        animation: "rain-heavy",
        particleEffect: "rain-heavy",
        visibility: "poor",
        moodBonus: -5
    },
    fog: {
        name: "å¤§é›¾",
        icon: "ğŸŒ«ï¸",
        bgGradient: "linear-gradient(180deg, #6a7a8a 0%, #8a9aaa 50%, #aabaca 100%)",
        animation: "fog",
        particleEffect: "fog",
        visibility: "very-poor",
        moodBonus: -3
    },
    snowstorm: {
        name: "æš´é£é›ª",
        icon: "â„ï¸",
        bgGradient: "linear-gradient(180deg, #4a5a6a 0%, #6a7a8a 50%, #8a9aaa 100%)",
        animation: "snow",
        particleEffect: "snow",
        visibility: "none",
        moodBonus: -8
    }
};

// ==================== å®æ™¯æŸ¥çœ‹ç³»ç»Ÿ ====================

let sceneryViewActive = false;

/**
 * åˆå§‹åŒ–è§†è§‰ç³»ç»Ÿ
 */
function initVisualSystem() {
    createWeatherEffects();
    createSceneryModal();
    addSceneryViewButton();
}

/**
 * åˆ›å»ºå¤©æ°”æ•ˆæœå®¹å™¨
 */
function createWeatherEffects() {
    // åˆ›å»ºå¤©æ°”ç²’å­å®¹å™¨
    const particleContainer = document.createElement('div');
    particleContainer.id = 'weather-particles';
    particleContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
        overflow: hidden;
    `;
    document.body.appendChild(particleContainer);
    
    // åˆ›å»ºå¤©æ°”é®ç½©å±‚
    const weatherOverlay = document.createElement('div');
    weatherOverlay.id = 'weather-overlay';
    weatherOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 4;
        transition: all 0.5s ease;
    `;
    document.body.appendChild(weatherOverlay);
}

/**
 * åˆ›å»ºå®æ™¯æŸ¥çœ‹å¼¹çª—
 */
function createSceneryModal() {
    const modal = document.createElement('div');
    modal.id = 'scenery-modal';
    modal.className = 'screen modal';
    modal.innerHTML = `
        <div class="modal-content scenery-content">
            <div class="scenery-header">
                <h3 id="scenery-title">èŠ‚ç‚¹å®æ™¯</h3>
                <button class="btn-close" onclick="closeSceneryView()">âœ•</button>
            </div>
            <div class="scenery-scene" id="scenery-scene">
                <div class="emoji-scene" id="emoji-scene"></div>
                <div class="scene-effects" id="scene-effects"></div>
            </div>
            <div class="scenery-description" id="scenery-description"></div>
            <div class="scenery-features" id="scenery-features"></div>
            <div class="scenery-atmosphere" id="scenery-atmosphere"></div>
            <div class="scenery-actions">
                <button id="btn-take-photo" class="btn btn-primary">ğŸ“¸ æ‹ç…§ç•™å¿µ</button>
                <button id="btn-explore" class="btn btn-success">ğŸ” ä»”ç»†æ¢ç´¢</button>
                <button class="btn btn-secondary" onclick="closeSceneryView()">è¿”å›</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬
    document.getElementById('btn-take-photo').addEventListener('click', takePhoto);
    document.getElementById('btn-explore').addEventListener('click', exploreScenery);
}

/**
 * æ·»åŠ å®æ™¯æŸ¥çœ‹æŒ‰é’®åˆ°æ¸¸æˆç•Œé¢
 */
function addSceneryViewButton() {
    const actionPanel = document.querySelector('.action-panel');
    if (actionPanel) {
        const sceneryBtn = document.createElement('button');
        sceneryBtn.id = 'btn-scenery';
        sceneryBtn.className = 'btn btn-info';
        sceneryBtn.innerHTML = 'ğŸ“· å®æ™¯';
        sceneryBtn.addEventListener('click', openSceneryView);
        actionPanel.appendChild(sceneryBtn);
    }
}

/**
 * æ‰“å¼€å®æ™¯æŸ¥çœ‹
 */
function openSceneryView() {
    if (sceneryViewActive) return;
    
    const nodeId = gameState.currentNode;
    const scenery = NODE_SCENERY[nodeId];
    
    if (!scenery) return;
    
    sceneryViewActive = true;
    
    // å¡«å……å†…å®¹
    document.getElementById('scenery-title').textContent = scenery.name;
    document.getElementById('emoji-scene').textContent = scenery.emojiScene;
    document.getElementById('scenery-description').textContent = scenery.description;
    
    // ç‰¹è‰²æ ‡ç­¾
    const featuresContainer = document.getElementById('scenery-features');
    featuresContainer.innerHTML = scenery.features.map(f => 
        `<span class="feature-tag">${f}</span>`
    ).join('');
    
    // æ°›å›´æè¿°
    document.getElementById('scenery-atmosphere').innerHTML = 
        `<span class="atmosphere-label">æ°›å›´ï¼š</span>${scenery.atmosphere}`;
    
    // æ·»åŠ å¤©æ°”æ•ˆæœåˆ°åœºæ™¯
    applyWeatherToScenery();
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('scenery-modal').classList.add('active');
    
    // æ¶ˆè€—å°‘é‡æ—¶é—´
    gameState.stamina = Math.max(0, gameState.stamina - 2);
    
    logEvent(`æ¬£èµäº†${scenery.name}çš„å®æ™¯`);
    updateUI();
}

/**
 * å…³é—­å®æ™¯æŸ¥çœ‹
 */
function closeSceneryView() {
    document.getElementById('scenery-modal').classList.remove('active');
    sceneryViewActive = false;
}

/**
 * æ‹ç…§ç•™å¿µ
 */
function takePhoto() {
    const nodeId = gameState.currentNode;
    const scenery = NODE_SCENERY[nodeId];
    
    // æ¢å¤å¿ƒæƒ…å€¼
    const moodRecovery = 15;
    gameState.mood = Math.min(100, gameState.mood + moodRecovery);
    
    // æ¶ˆè€—ä½“åŠ›
    gameState.stamina = Math.max(0, gameState.stamina - 3);
    
    logEvent(`åœ¨${scenery.name}æ‹ç…§ç•™å¿µï¼Œå¿ƒæƒ…å¤§å¥½ï¼(+${moodRecovery}å¿ƒæƒ…)`);
    
    // è§¦å‘ç‰¹æ®Šäº‹ä»¶æ¦‚ç‡
    if (Math.random() < 0.3) {
        setTimeout(() => {
            triggerSceneryEvent(nodeId);
        }, 500);
    }
    
    closeSceneryView();
    updateUI();
}

/**
 * ä»”ç»†æ¢ç´¢
 */
function exploreScenery() {
    const nodeId = gameState.currentNode;
    const scenery = NODE_SCENERY[nodeId];
    
    // æ¶ˆè€—æ›´å¤šä½“åŠ›å’Œæ—¶é—´
    gameState.stamina = Math.max(0, gameState.stamina - 8);
    
    // å¯èƒ½å‘ç°ç‰©å“æˆ–è§¦å‘äº‹ä»¶
    const rand = Math.random();
    
    if (rand < 0.2) {
        // å‘ç°è¡¥ç»™
        const foodGain = 10;
        const waterGain = 10;
        gameState.food = Math.min(100, gameState.food + foodGain);
        gameState.water = Math.min(100, gameState.water + waterGain);
        logEvent(`åœ¨${scenery.name}æ¢ç´¢æ—¶å‘ç°äº†è¡¥ç»™ï¼(+${foodGain}é£Ÿç‰©, +${waterGain}æ°´)`);
    } else if (rand < 0.4) {
        // è§¦å‘ç‰¹æ®Šäº‹ä»¶
        triggerSceneryEvent(nodeId);
    } else {
        // æ™®é€šæ¢ç´¢ç»“æœ
        const moodGain = 5;
        gameState.mood = Math.min(100, gameState.mood + moodGain);
        logEvent(`ä»”ç»†æ¢ç´¢äº†${scenery.name}ï¼Œå¯¹è¿™é‡Œæœ‰äº†æ›´æ·±çš„äº†è§£ã€‚(+${moodGain}å¿ƒæƒ…)`);
    }
    
    closeSceneryView();
    updateUI();
}

/**
 * è§¦å‘èŠ‚ç‚¹ç‰¹æ®Šäº‹ä»¶
 */
function triggerSceneryEvent(nodeId) {
    const scenery = NODE_SCENERY[nodeId];
    if (!scenery || !scenery.specialEvent) return;
    
    logEvent(`ğŸ‰ ç‰¹æ®Šäº‹ä»¶ï¼š${scenery.specialEvent}`);
    
    // æ ¹æ®èŠ‚ç‚¹ç»™äºˆä¸åŒå¥–åŠ±
    switch(nodeId) {
        case 0: // å¡˜å£æ‘
            gameState.food = Math.min(100, gameState.food + 15);
            gameState.water = Math.min(100, gameState.water + 15);
            showNotification("æ‘æ°‘èµ é€äº†é£Ÿç‰©å’Œæ°´ï¼", "success");
            break;
        case 2: // 2900è¥åœ°
        case 7: // æ°´çªå­è¥åœ°
            gameState.stamina = Math.min(100, gameState.stamina + 20);
            gameState.mood = Math.min(100, gameState.mood + 15);
            showNotification("è¥åœ°ä¼‘æ¯æ•ˆæœåŠ å€ï¼", "success");
            break;
        case 3: // é³Œå±±å¤§æ¢
            gameState.mood = Math.min(100, gameState.mood + 25);
            showNotification("äº‘æµ·æ—¥å‡ºï¼Œç»ˆç”Ÿéš¾å¿˜ï¼", "success");
            break;
        case 4: // å¯¼èˆªæ¶
            gameState.mood = Math.min(100, gameState.mood + 20);
            showNotification("æ‰“å¡æˆåŠŸï¼ç•™ä¸‹çè´µå›å¿†", "success");
            break;
        case 5: // è¯ç‹åº™
            gameState.stamina = Math.min(100, gameState.stamina + 15);
            showNotification("è¯ç‹åº‡ä½‘ï¼Œä½“åŠ›æ¢å¤ï¼", "success");
            break;
        case 8: // å¤ªç™½å±±æ™¯åŒº
            gameState.mood = Math.min(100, gameState.mood + 30);
            showNotification("ç©¿è¶ŠæˆåŠŸï¼è·å¾—è£èª‰è¯ä¹¦ï¼", "success");
            break;
        default:
            gameState.mood = Math.min(100, gameState.mood + 10);
    }
}

/**
 * æ›´æ–°å¤©æ°”è§†è§‰æ•ˆæœ
 */
function updateWeatherVisuals() {
    const weatherId = gameState.weather ? gameState.weather.id : 'sunny';
    const visual = WEATHER_VISUALS[weatherId];
    
    if (!visual) return;
    
    // æ›´æ–°èƒŒæ™¯æ¸å˜
    const overlay = document.getElementById('weather-overlay');
    if (overlay) {
        overlay.style.background = visual.bgGradient;
        overlay.style.opacity = '0.3';
    }
    
    // æ›´æ–°ç²’å­æ•ˆæœ
    updateParticleEffect(visual.particleEffect);
    
    // æ›´æ–°æ¸¸æˆå®¹å™¨èƒŒæ™¯
    const gameContainer = document.getElementById('game-container');
    if (gameContainer) {
        gameContainer.style.background = `linear-gradient(135deg, rgba(26,26,46,0.9) 0%, rgba(22,33,62,0.9) 100%), ${visual.bgGradient}`;
        gameContainer.style.backgroundBlendMode = 'overlay';
    }
}

/**
 * æ›´æ–°ç²’å­æ•ˆæœ
 */
function updateParticleEffect(effectType) {
    const container = document.getElementById('weather-particles');
    if (!container) return;
    
    // æ¸…é™¤ç°æœ‰ç²’å­
    container.innerHTML = '';
    
    if (!effectType) return;
    
    // æ ¹æ®æ•ˆæœç±»å‹åˆ›å»ºç²’å­
    switch(effectType) {
        case 'rain-light':
            createRainParticles(container, 50, 'light');
            break;
        case 'rain-heavy':
            createRainParticles(container, 150, 'heavy');
            break;
        case 'snow':
            createSnowParticles(container, 80);
            break;
        case 'fog':
            createFogEffect(container);
            break;
        case 'cloud':
            createCloudEffect(container);
            break;
    }
}

/**
 * åˆ›å»ºé›¨æ»´ç²’å­
 */
function createRainParticles(container, count, intensity) {
    for (let i = 0; i < count; i++) {
        const drop = document.createElement('div');
        drop.className = `rain-drop ${intensity}`;
        drop.style.cssText = `
            position: absolute;
            width: ${intensity === 'heavy' ? '3px' : '2px'};
            height: ${intensity === 'heavy' ? '20px' : '15px'};
            background: linear-gradient(to bottom, transparent, rgba(174,194,224,0.6));
            left: ${Math.random() * 100}%;
            top: -20px;
            animation: rain-fall ${0.5 + Math.random() * 0.5}s linear infinite;
            animation-delay: ${Math.random() * 2}s;
        `;
        container.appendChild(drop);
    }
}

/**
 * åˆ›å»ºé›ªèŠ±ç²’å­
 */
function createSnowParticles(container, count) {
    for (let i = 0; i < count; i++) {
        const flake = document.createElement('div');
        flake.className = 'snow-flake';
        const size = 3 + Math.random() * 5;
        flake.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            left: ${Math.random() * 100}%;
            top: -10px;
            animation: snow-fall ${3 + Math.random() * 4}s linear infinite;
            animation-delay: ${Math.random() * 5}s;
            filter: blur(${Math.random() > 0.5 ? '1px' : '0px'});
        `;
        container.appendChild(flake);
    }
}

/**
 * åˆ›å»ºé›¾æ•ˆæœ
 */
function createFogEffect(container) {
    for (let i = 0; i < 5; i++) {
        const fog = document.createElement('div');
        fog.className = 'fog-layer';
        fog.style.cssText = `
            position: absolute;
            width: 200%;
            height: 100px;
            background: linear-gradient(to right, 
                transparent, 
                rgba(200,210,220,0.3), 
                rgba(200,210,220,0.5), 
                rgba(200,210,220,0.3), 
                transparent);
            left: -50%;
            top: ${20 + i * 15}%;
            animation: fog-move ${20 + i * 5}s linear infinite;
            animation-delay: ${i * 2}s;
        `;
        container.appendChild(fog);
    }
}

/**
 * åˆ›å»ºäº‘æ•ˆæœ
 */
function createCloudEffect(container) {
    for (let i = 0; i < 3; i++) {
        const cloud = document.createElement('div');
        cloud.className = 'cloud-layer';
        cloud.innerHTML = 'â˜ï¸';
        cloud.style.cssText = `
            position: absolute;
            font-size: ${80 + Math.random() * 60}px;
            opacity: 0.4;
            left: ${Math.random() * 100}%;
            top: ${5 + Math.random() * 20}%;
            animation: cloud-float ${30 + Math.random() * 20}s linear infinite;
            animation-delay: ${i * 5}s;
        `;
        container.appendChild(cloud);
    }
}

/**
 * åº”ç”¨å¤©æ°”æ•ˆæœåˆ°å®æ™¯
 */
function applyWeatherToScenery() {
    const sceneEffects = document.getElementById('scene-effects');
    if (!sceneEffects) return;
    
    sceneEffects.innerHTML = '';
    
    const weatherId = gameState.weather ? gameState.weather.id : 'sunny';
    const visual = WEATHER_VISUALS[weatherId];
    
    if (visual && visual.particleEffect) {
        // åœ¨å®æ™¯ä¸­å¤åˆ¶å¤©æ°”æ•ˆæœ
        switch(visual.particleEffect) {
            case 'rain-light':
            case 'rain-heavy':
                createRainParticles(sceneEffects, 30, 'light');
                break;
            case 'snow':
                createSnowParticles(sceneEffects, 40);
                break;
            case 'fog':
                sceneEffects.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(200,210,220,0.3);
                    backdrop-filter: blur(2px);
                `;
                break;
        }
    }
}

/**
 * æ˜¾ç¤ºé€šçŸ¥
 */
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: ${type === 'success' ? 'rgba(39,174,96,0.9)' : 'rgba(52,152,219,0.9)'};
        color: white;
        border-radius: 8px;
        z-index: 10000;
        animation: notification-slide 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'notification-fade 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
    }, 2500);
}

// ==================== çŠ¶æ€å˜åŒ–è§†è§‰åé¦ˆ ====================

/**
 * æ˜¾ç¤ºèµ„æºå˜åŒ–åŠ¨ç”»
 */
function showResourceChange(type, amount) {
    const bar = document.getElementById(`${type}-bar`);
    if (!bar) return;
    
    const indicator = document.createElement('div');
    indicator.className = 'resource-change-indicator';
    indicator.textContent = amount > 0 ? `+${amount}` : `${amount}`;
    indicator.style.cssText = `
        position: absolute;
        right: -40px;
        top: 50%;
        transform: translateY(-50%);
        color: ${amount > 0 ? '#27ae60' : '#e74c3c'};
        font-weight: bold;
        font-size: 0.9rem;
        animation: indicator-float 1s ease forwards;
        pointer-events: none;
    `;
    
    bar.parentElement.style.position = 'relative';
    bar.parentElement.appendChild(indicator);
    
    setTimeout(() => indicator.remove(), 1000);
}

/**
 * æ·»åŠ CSSåŠ¨ç”»æ ·å¼
 */
function addVisualStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* å¤©æ°”åŠ¨ç”» */
        @keyframes rain-fall {
            to {
                transform: translateY(100vh);
            }
        }
        
        @keyframes snow-fall {
            to {
                transform: translateY(100vh) translateX(20px);
            }
        }
        
        @keyframes fog-move {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(50%); }
        }
        
        @keyframes cloud-float {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(calc(100vw + 100px)); }
        }
        
        /* é€šçŸ¥åŠ¨ç”» */
        @keyframes notification-slide {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @keyframes notification-fade {
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }
        
        /* èµ„æºå˜åŒ–æŒ‡ç¤ºå™¨åŠ¨ç”» */
        @keyframes indicator-float {
            0% {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100%) translateX(0);
            }
        }
        
        /* å®æ™¯å¼¹çª—æ ·å¼ */
        .scenery-content {
            max-width: 600px;
            padding: 0;
            overflow: hidden;
        }
        
        .scenery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #2c5f2d, #4a7c4b);
            color: white;
        }
        
        .scenery-header h3 {
            margin: 0;
            color: white;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scenery-scene {
            position: relative;
            height: 200px;
            background: linear-gradient(180deg, #87ceeb 0%, #e8f4f8 50%, #c5d1db 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .emoji-scene {
            font-size: 5rem;
            z-index: 2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            animation: scene-float 3s ease-in-out infinite;
        }
        
        @keyframes scene-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .scene-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }
        
        .scenery-description {
            padding: 20px;
            line-height: 1.8;
            color: #eaeaea;
            font-size: 0.95rem;
        }
        
        .scenery-features {
            padding: 0 20px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .feature-tag {
            background: rgba(151,188,98,0.2);
            border: 1px solid #97bc62;
            color: #97bc62;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .scenery-atmosphere {
            padding: 0 20px 15px;
            color: #a0a0a0;
            font-size: 0.9rem;
        }
        
        .atmosphere-label {
            color: #d4a574;
        }
        
        .scenery-actions {
            padding: 15px 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* å¤©æ°”å›¾æ ‡åŠ¨ç”» */
        .weather-icon-anim {
            display: inline-block;
            animation: weather-bounce 2s ease-in-out infinite;
        }
        
        @keyframes weather-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        /* åœ°å›¾èŠ‚ç‚¹å¢å¼º */
        .map-node {
            position: relative;
            overflow: hidden;
        }
        
        .map-node.current::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(151,188,98,0.2), transparent);
            animation: node-glow 2s ease-in-out infinite;
        }
        
        @keyframes node-glow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* èµ„æºæ¡è¿‡æ¸¡æ•ˆæœ */
        .resource-bar {
            position: relative;
            overflow: visible;
        }
        
        .bar-fill {
            transition: width 0.5s ease, background-color 0.3s ease;
        }
        
        /* æŒ‰é’®æ‚¬åœæ•ˆæœå¢å¼º */
        .btn {
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .btn:active::after {
            width: 200px;
            height: 200px;
        }
    `;
    document.head.appendChild(style);
}

// ==================== åˆå§‹åŒ– ====================

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è§†è§‰ç³»ç»Ÿ
document.addEventListener('DOMContentLoaded', () => {
    addVisualStyles();
    initVisualSystem();
});
/**
 * é³Œå¤ªçº¿æ¨¡æ‹Ÿå™¨ - éŸ³æ•ˆç³»ç»Ÿ
 * ä½¿ç”¨ Web Audio API å®ç°è½»é‡çº§éŸ³æ•ˆ
 */

// ==================== éŸ³æ•ˆç³»ç»Ÿé…ç½® ====================

const AudioSystem = {
    // éŸ³é¢‘ä¸Šä¸‹æ–‡
    ctx: null,
    
    // ä¸»éŸ³é‡æ§åˆ¶
    masterVolume: 0.7,
    
    // ç¯å¢ƒéŸ³æ•ˆéŸ³é‡
    ambientVolume: 0.5,
    
    // å½“å‰æ’­æ”¾çš„ç¯å¢ƒéŸ³æ•ˆ
    currentAmbient: null,
    
    // éŸ³æ•ˆå¼€å…³
    enabled: true,
    
    // åˆå§‹åŒ–çŠ¶æ€
    initialized: false,
    
    // ==================== åˆå§‹åŒ– ====================
    
    /**
     * åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
     */
    init() {
        if (this.initialized) return;
        
        try {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.initialized = true;
            console.log('éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
        } catch (e) {
            console.warn('Web Audio API ä¸æ”¯æŒï¼ŒéŸ³æ•ˆç³»ç»Ÿç¦ç”¨');
            this.enabled = false;
        }
    },
    
    /**
     * æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆæµè§ˆå™¨è‡ªåŠ¨æš‚åœåï¼‰
     */
    resume() {
        if (this.ctx && this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    },
    
    // ==================== éŸ³æ•ˆæ’­æ”¾å·¥å…·å‡½æ•° ====================
    
    /**
     * æ’­æ”¾ç®€å•çš„èœ‚é¸£éŸ³
     * @param {number} frequency - é¢‘ç‡(Hz)
     * @param {number} duration - æŒç»­æ—¶é—´(ms)
     * @param {string} type - æ³¢å½¢ç±»å‹
     * @param {number} volume - éŸ³é‡(0-1)
     */
    playTone(frequency, duration, type = 'sine', volume = 0.5) {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = type;
        osc.frequency.setValueAtTime(frequency, this.ctx.currentTime);
        
        gain.gain.setValueAtTime(volume * this.masterVolume, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration / 1000);
        
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.start(this.ctx.currentTime);
        osc.stop(this.ctx.currentTime + duration / 1000);
    },
    
    /**
     * æ’­æ”¾æ»‘åŠ¨éŸ³ï¼ˆç”¨äºUIæ•ˆæœï¼‰
     * @param {number} startFreq - èµ·å§‹é¢‘ç‡
     * @param {number} endFreq - ç»“æŸé¢‘ç‡
     * @param {number} duration - æŒç»­æ—¶é—´(ms)
     * @param {number} volume - éŸ³é‡
     */
    playSlide(startFreq, endFreq, duration, volume = 0.3) {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(startFreq, this.ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(endFreq, this.ctx.currentTime + duration / 1000);
        
        gain.gain.setValueAtTime(volume * this.masterVolume, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + duration / 1000);
        
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.start(this.ctx.currentTime);
        osc.stop(this.ctx.currentTime + duration / 1000);
    },
    
    /**
     * æ’­æ”¾å™ªå£°ï¼ˆç”¨äºç¯å¢ƒéŸ³æ•ˆï¼‰
     * @param {number} duration - æŒç»­æ—¶é—´(ms)
     * @param {number} volume - éŸ³é‡
     * @param {string} filterType - æ»¤æ³¢å™¨ç±»å‹
     * @param {number} frequency - æ»¤æ³¢é¢‘ç‡
     */
    playNoise(duration, volume = 0.3, filterType = 'lowpass', frequency = 1000) {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        const bufferSize = this.ctx.sampleRate * (duration / 1000);
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        
        for (let i = 0; i < bufferSize; i++) {
            data[i] = Math.random() * 2 - 1;
        }
        
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        
        const filter = this.ctx.createBiquadFilter();
        filter.type = filterType;
        filter.frequency.value = frequency;
        
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(volume * this.ambientVolume * this.masterVolume, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration / 1000);
        
        noise.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        
        noise.start(this.ctx.currentTime);
        noise.stop(this.ctx.currentTime + duration / 1000);
    },
    
    // ==================== UIéŸ³æ•ˆ ====================
    
    /**
     * æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
     */
    playButtonClick() {
        this.playTone(800, 80, 'sine', 0.3);
        setTimeout(() => this.playTone(1200, 60, 'sine', 0.2), 40);
    },
    
    /**
     * å¼¹çª—æ‰“å¼€éŸ³æ•ˆ
     */
    playModalOpen() {
        this.playSlide(400, 600, 150, 0.25);
    },
    
    /**
     * å¼¹çª—å…³é—­éŸ³æ•ˆ
     */
    playModalClose() {
        this.playSlide(600, 400, 150, 0.25);
    },
    
    /**
     * çŠ¶æ€å˜åŒ–æç¤ºéŸ³
     */
    playStatusChange() {
        this.playTone(1000, 100, 'sine', 0.2);
        setTimeout(() => this.playTone(1500, 80, 'sine', 0.15), 50);
    },
    
    /**
     * é”™è¯¯/è­¦å‘Šæç¤ºéŸ³
     */
    playError() {
        this.playTone(200, 200, 'sawtooth', 0.3);
        setTimeout(() => this.playTone(150, 200, 'sawtooth', 0.3), 100);
    },
    
    // ==================== åŠ¨ä½œéŸ³æ•ˆ ====================
    
    /**
     * è„šæ­¥å£°ï¼ˆæ ¹æ®åœ°å½¢å’Œå¤©æ°”è°ƒæ•´ï¼‰
     * @param {string} terrain - åœ°å½¢ç±»å‹
     * @param {string} weather - å¤©æ°”ç±»å‹
     */
    playFootstep(terrain = 'normal', weather = 'sunny') {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        let frequency = 150;
        let volume = 0.2;
        let duration = 100;
        
        // æ ¹æ®åœ°å½¢è°ƒæ•´
        switch (terrain) {
            case 'rock': // å²©çŸ³
                frequency = 300;
                volume = 0.25;
                break;
            case 'snow': // é›ªåœ°
                frequency = 100;
                volume = 0.15;
                duration = 150;
                break;
            case 'mud': // æ³¥æ³
                frequency = 80;
                volume = 0.2;
                duration = 120;
                break;
            default: // æ™®é€šå±±è·¯
                frequency = 150;
                volume = 0.2;
        }
        
        // æ¶åŠ£å¤©æ°”å¢åŠ æ²‰é—·æ„Ÿ
        if (weather === 'heavy_rain' || weather === 'snowstorm') {
            frequency *= 0.8;
            volume *= 0.9;
        }
        
        // ä½¿ç”¨å™ªå£°æ¨¡æ‹Ÿè„šæ­¥å£°
        this.playNoise(duration, volume, 'lowpass', frequency * 3);
        
        // æ·»åŠ ä½é¢‘å†²å‡»
        setTimeout(() => {
            this.playTone(frequency, duration, 'triangle', volume * 0.5);
        }, 10);
    },
    
    /**
     * è¿ç»­è„šæ­¥å£°ï¼ˆç§»åŠ¨æ—¶ï¼‰
     * @param {number} steps - æ­¥æ•°
     * @param {string} weather - å¤©æ°”
     */
    playFootsteps(steps = 3, weather = 'sunny') {
        for (let i = 0; i < steps; i++) {
            setTimeout(() => {
                this.playFootstep('normal', weather);
            }, i * 300);
        }
    },
    
    /**
     * ä¼‘æ¯æ—¶çš„å‘¼å¸å£°
     * @param {number} intensity - å‘¼å¸å¼ºåº¦(1-3)
     */
    playBreathing(intensity = 1) {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        const duration = 2000 * intensity;
        const volume = 0.15 * intensity;
        
        // åˆ›å»ºå‘¼å¸èŠ‚å¥
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        const filter = this.ctx.createBiquadFilter();
        
        osc.type = 'sine';
        filter.type = 'lowpass';
        filter.frequency.value = 400;
        
        // å‘¼å¸é¢‘ç‡
        const breathRate = 0.5 / intensity; // Hz
        
        gain.gain.setValueAtTime(0, this.ctx.currentTime);
        
        // æ¨¡æ‹Ÿå‡ æ¬¡å‘¼å¸
        for (let i = 0; i < 3; i++) {
            const t = this.ctx.currentTime + i * (2 / breathRate);
            gain.gain.linearRampToValueAtTime(volume * this.masterVolume, t + 0.3);
            gain.gain.linearRampToValueAtTime(0, t + 1);
        }
        
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.frequency.setValueAtTime(200, this.ctx.currentTime);
        osc.start(this.ctx.currentTime);
        osc.stop(this.ctx.currentTime + duration / 1000);
    },
    
    /**
     * åƒä¸œè¥¿éŸ³æ•ˆ
     */
    playEating() {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        // å’€åš¼å£° - çŸ­ä¿ƒçš„å™ªå£°
        for (let i = 0; i < 4; i++) {
            setTimeout(() => {
                this.playNoise(100, 0.15, 'bandpass', 800);
            }, i * 200);
        }
        
        // åå’½å£°
        setTimeout(() => {
            this.playTone(150, 150, 'sine', 0.2);
        }, 900);
    },
    
    /**
     * å–æ°´éŸ³æ•ˆ
     */
    playDrinking() {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        // å€’æ°´/å–æ°´å£°
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                this.playNoise(200, 0.12, 'lowpass', 600);
            }, i * 250);
        }
        
        // å–å®Œçš„"å•Š"å£°
        setTimeout(() => {
            this.playSlide(300, 250, 300, 0.15);
        }, 800);
    },
    
    /**
     * è£…å¤‡ä½¿ç”¨éŸ³æ•ˆ
     */
    playEquipSound() {
        this.playTone(600, 100, 'sine', 0.25);
        setTimeout(() => this.playTone(800, 150, 'sine', 0.2), 80);
    },
    
    // ==================== ç¯å¢ƒéŸ³æ•ˆ ====================
    
    /**
     * é£å£°ï¼ˆæ ¹æ®å¼ºåº¦ï¼‰
     * @param {number} intensity - é£å¼ºåº¦(0-1)
     * @param {number} duration - æŒç»­æ—¶é—´(ms)
     */
    playWind(intensity = 0.5, duration = 3000) {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        const bufferSize = this.ctx.sampleRate * (duration / 1000);
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        
        // ç”Ÿæˆé£å£° - å¸¦è°ƒåˆ¶çš„å™ªå£°
        for (let i = 0; i < bufferSize; i++) {
            const t = i / this.ctx.sampleRate;
            // ä½é¢‘è°ƒåˆ¶æ¨¡æ‹Ÿé£çš„èµ·ä¼
            const modulation = Math.sin(2 * Math.PI * 0.5 * t) * 0.5 + 0.5;
            data[i] = (Math.random() * 2 - 1) * modulation * intensity;
        }
        
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 300 + intensity * 700;
        filter.Q.value = 0.5;
        
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(0, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(this.ambientVolume * intensity * this.masterVolume, this.ctx.currentTime + 0.5);
        gain.gain.setValueAtTime(this.ambientVolume * intensity * this.masterVolume, this.ctx.currentTime + duration / 1000 - 0.5);
        gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + duration / 1000);
        
        noise.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        
        noise.start(this.ctx.currentTime);
        noise.stop(this.ctx.currentTime + duration / 1000);
    },
    
    /**
     * é›¨å£°
     * @param {number} intensity - é›¨å¼ºåº¦(0-1)
     * @param {number} duration - æŒç»­æ—¶é—´(ms)
     */
    playRain(intensity = 0.5, duration = 3000) {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        const bufferSize = this.ctx.sampleRate * (duration / 1000);
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        
        // ç”Ÿæˆé›¨å£°
        for (let i = 0; i < bufferSize; i++) {
            data[i] = (Math.random() * 2 - 1) * intensity;
        }
        
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 800 + intensity * 2000;
        
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(this.ambientVolume * intensity * 0.6 * this.masterVolume, this.ctx.currentTime);
        
        noise.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        
        noise.start(this.ctx.currentTime);
        noise.stop(this.ctx.currentTime + duration / 1000);
    },
    
    /**
     * é›ªå£°ï¼ˆè½»æŸ”çš„æ²™æ²™å£°ï¼‰
     * @param {number} duration - æŒç»­æ—¶é—´(ms)
     */
    playSnow(duration = 3000) {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        const bufferSize = this.ctx.sampleRate * (duration / 1000);
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        
        // ç”ŸæˆæŸ”å’Œçš„æ²™æ²™å£°
        for (let i = 0; i < bufferSize; i++) {
            data[i] = (Math.random() * 2 - 1) * 0.3;
        }
        
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        
        const filter = this.ctx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 400;
        
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(0, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(this.ambientVolume * 0.4 * this.masterVolume, this.ctx.currentTime + 0.5);
        gain.gain.setValueAtTime(this.ambientVolume * 0.4 * this.masterVolume, this.ctx.currentTime + duration / 1000 - 0.5);
        gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + duration / 1000);
        
        noise.connect(filter);
        filter.connect(gain);
        gain.connect(this.ctx.destination);
        
        noise.start(this.ctx.currentTime);
        noise.stop(this.ctx.currentTime + duration / 1000);
    },
    
    /**
     * é¸Ÿé¸£ï¼ˆæ™´å¤©æ—¶ï¼‰
     */
    playBirdChirp() {
        if (!this.enabled || !this.ctx) return;
        
        this.resume();
        
        // éšæœºé¸Ÿé¸£å‚æ•°
        const baseFreq = 2000 + Math.random() * 1500;
        const chirpCount = 2 + Math.floor(Math.random() * 3);
        
        for (let i = 0; i < chirpCount; i++) {
            setTimeout(() => {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(baseFreq, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.5, this.ctx.currentTime + 0.05);
                
                gain.gain.setValueAtTime(0.1 * this.ambientVolume * this.masterVolume, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.start(this.ctx.currentTime);
                osc.stop(this.ctx.currentTime + 0.1);
            }, i * 150);
        }
    },
    
    /**
     * æ ¹æ®å¤©æ°”æ’­æ”¾ç¯å¢ƒéŸ³æ•ˆ
     * @param {string} weatherId - å¤©æ°”ID
     */
    playWeatherAmbient(weatherId) {
        // åœæ­¢å½“å‰ç¯å¢ƒéŸ³æ•ˆ
        this.stopAmbient();
        
        switch (weatherId) {
            case 'sunny':
                // æ™´å¤©å¶å°”æœ‰é¸Ÿé¸£
                this.scheduleBirdChirps();
                break;
            case 'cloudy':
                // å¤šäº‘æœ‰è½»å¾®é£å£°
                this.playWind(0.3, 4000);
                break;
            case 'light_rain':
                // å°é›¨å£°
                this.playRain(0.4, 5000);
                break;
            case 'heavy_rain':
                // å¤§é›¨å£°
                this.playRain(0.8, 5000);
                break;
            case 'fog':
                // é›¾å¤©æœ‰è½»å¾®é£å£°
                this.playWind(0.2, 4000);
                break;
            case 'snowstorm':
                // æš´é£é›ª
                this.playWind(0.9, 5000);
                setTimeout(() => this.playSnow(4000), 500);
                break;
        }
    },
    
    /**
     * å®‰æ’é¸Ÿé¸£ï¼ˆå®šæ—¶æ’­æ”¾ï¼‰
     */
    scheduleBirdChirps() {
        if (!this.enabled) return;
        
        // éšæœºæ’­æ”¾é¸Ÿé¸£
        const scheduleNext = () => {
            if (!this.enabled) return;
            const delay = 3000 + Math.random() * 7000;
            setTimeout(() => {
                if (Math.random() < 0.7) {
                    this.playBirdChirp();
                }
                scheduleNext();
            }, delay);
        };
        
        scheduleNext();
    },
    
    /**
     * åœæ­¢ç¯å¢ƒéŸ³æ•ˆ
     */
    stopAmbient() {
        // ç¯å¢ƒéŸ³æ•ˆä¼šè‡ªåŠ¨ç»“æŸï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„æ¸…ç†é€»è¾‘
        this.currentAmbient = null;
    },
    
    // ==================== äº‹ä»¶éŸ³æ•ˆ ====================
    
    /**
     * æˆå°±è§£é”éŸ³æ•ˆ
     */
    playAchievement() {
        // æ¬¢å¿«çš„ä¸Šå‡éŸ³é˜¶
        const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
        notes.forEach((freq, i) => {
            setTimeout(() => {
                this.playTone(freq, 150, 'sine', 0.3);
            }, i * 100);
        });
    },
    
    /**
     * å±é™©è­¦å‘ŠéŸ³æ•ˆ
     */
    playWarning() {
        // è­¦æŠ¥å£°
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                this.playTone(800, 200, 'sawtooth', 0.3);
                setTimeout(() => {
                    this.playTone(600, 200, 'sawtooth', 0.3);
                }, 200);
            }, i * 500);
        }
    },
    
    /**
     * æˆåŠŸéŸ³æ•ˆ
     */
    playSuccess() {
        this.playTone(523.25, 100, 'sine', 0.3);
        setTimeout(() => this.playTone(659.25, 100, 'sine', 0.3), 100);
        setTimeout(() => this.playTone(783.99, 200, 'sine', 0.3), 200);
    },
    
    /**
     * å¤±è´¥éŸ³æ•ˆ
     */
    playFailure() {
        this.playTone(300, 200, 'sawtooth', 0.3);
        setTimeout(() => this.playTone(250, 300, 'sawtooth', 0.3), 200);
    },
    
    /**
     * æ¸¸æˆèƒœåˆ©éŸ³æ•ˆ
     */
    playVictory() {
        // èƒœåˆ©å·è§’
        const melody = [
            { f: 523.25, d: 200 },
            { f: 523.25, d: 200 },
            { f: 523.25, d: 200 },
            { f: 659.25, d: 400 },
            { f: 783.99, d: 200 },
            { f: 659.25, d: 400 }
        ];
        
        let time = 0;
        melody.forEach(note => {
            setTimeout(() => {
                this.playTone(note.f, note.d, 'sine', 0.4);
            }, time);
            time += note.d;
        });
    },
    
    /**
     * æ¸¸æˆç»“æŸéŸ³æ•ˆ
     */
    playGameOver() {
        // æ‚²ä¼¤çš„ä¸‹é™éŸ³é˜¶
        const notes = [392.00, 349.23, 311.13, 293.66]; // G4, F4, Eb4, D4
        notes.forEach((freq, i) => {
            setTimeout(() => {
                this.playTone(freq, 300, 'sine', 0.3);
            }, i * 300);
        });
    },
    
    /**
     * è·å¾—ç‰©å“éŸ³æ•ˆ
     */
    playItemGet() {
        this.playTone(880, 80, 'sine', 0.25);
        setTimeout(() => this.playTone(1100, 120, 'sine', 0.2), 80);
    },
    
    /**
     * èµ„æºå‡å°‘è­¦å‘Š
     */
    playResourceLow() {
        this.playTone(400, 150, 'sine', 0.2);
        setTimeout(() => this.playTone(350, 150, 'sine', 0.2), 150);
    },
    
    // ==================== éŸ³é‡æ§åˆ¶ ====================
    
    /**
     * è®¾ç½®ä¸»éŸ³é‡
     * @param {number} volume - éŸ³é‡(0-1)
     */
    setMasterVolume(volume) {
        this.masterVolume = Math.max(0, Math.min(1, volume));
    },
    
    /**
     * è®¾ç½®ç¯å¢ƒéŸ³æ•ˆéŸ³é‡
     * @param {number} volume - éŸ³é‡(0-1)
     */
    setAmbientVolume(volume) {
        this.ambientVolume = Math.max(0, Math.min(1, volume));
    },
    
    /**
     * å¼€å…³éŸ³æ•ˆ
     * @param {boolean} enabled - æ˜¯å¦å¯ç”¨
     */
    toggle(enabled) {
        this.enabled = enabled;
    },
    
    /**
     * é™éŸ³/å–æ¶ˆé™éŸ³
     */
    mute() {
        this.enabled = !this.enabled;
        return this.enabled;
    }
};

// ==================== å¯¼å‡ºéŸ³æ•ˆç³»ç»Ÿ ====================

// åœ¨æ¨¡å—ç³»ç»Ÿä¸­å¯¼å‡º
if (typeof module !== 'undefined' && module.exports) {
    module.exports = AudioSystem;
}
/**
 * é³Œå¤ªçº¿æ¨¡æ‹Ÿå™¨ - å®æ™¯æŸ¥çœ‹ä¸ç›¸å†Œç³»ç»Ÿ
 * åŒ…å«èŠ‚ç‚¹å®æ™¯æŸ¥çœ‹ã€æ‹ç…§æ”¶é›†ã€ç›¸å†Œç®¡ç†ã€ç‰¹æ®Šé£æ™¯äº‹ä»¶
 * 
 * ä¾èµ–: visuals.js (æä¾› NODE_SCENERY, WEATHER_VISUALS æ•°æ®)
 *       game.js (æä¾› gameState, logEvent, updateUI, showNotification ç­‰)
 */

// ==================== ç…§ç‰‡æ•°æ®ç»“æ„ ====================

// ç…§ç‰‡æ¨¡æ¿ - æ¯ä¸ªèŠ‚ç‚¹çš„é»˜è®¤ç…§ç‰‡æ•°æ®
const PHOTO_TEMPLATES = {
    0: {
        title: "ç©¿è¶Šèµ·ç‚¹",
        defaultTitle: "å¡˜å£æ‘å‡ºå‘çºªå¿µ",
        description: "ç§¦å²­è„šä¸‹çš„å®é™æ‘åº„ï¼Œé³Œå¤ªç©¿è¶Šä»è¿™é‡Œå¼€å§‹",
        moodBonus: 5
    },
    1: {
        title: "ç«çƒ§å¡é—è¿¹",
        defaultTitle: "ç«çƒ§å¡æ å½±",
        description: "ç„¦é»‘çš„æ ‘å¹²ä¸æ–°ç”Ÿç»¿æ„ï¼Œå±•ç°ç”Ÿå‘½çš„é¡½å¼º",
        moodBonus: 8
    },
    2: {
        title: "æ˜Ÿç©ºè¥åœ°",
        defaultTitle: "2900è¥åœ°å¤œæ™¯",
        description: "æµ·æ‹”2900ç±³çš„ç†æƒ³è¥åœ°ï¼Œæ»¡å¤©ç¹æ˜Ÿè§¦æ‰‹å¯åŠ",
        moodBonus: 12
    },
    3: {
        title: "äº‘ç«¯æ¼«æ­¥",
        defaultTitle: "é³Œå±±å¤§æ¢é£å…‰",
        description: "è¡Œèµ°åœ¨ä¸»è„Šä¹‹ä¸Šï¼Œäº‘æµ·åœ¨èº«æ—ç¿»æ¶Œ",
        moodBonus: 15
    },
    4: {
        title: "åœ°æ ‡æ‰“å¡",
        defaultTitle: "å¯¼èˆªæ¶ç•™å¿µ",
        description: "é³Œå¤ªçº¿æœ€è‘—åçš„åœ°æ ‡ï¼Œæ¯ä¸€ä½ç©¿è¶Šè€…çš„å¿…åˆ°ä¹‹å¤„",
        moodBonus: 10
    },
    5: {
        title: "å¤åº™å¯»è¸ª",
        defaultTitle: "è¯ç‹åº™æ¢è®¿",
        description: "åºŸå¼ƒçš„è¯ç‹åº™ï¼Œæ–‘é©³çš„å¢™å£è¯‰è¯´ç€å²æœˆæ²§æ¡‘",
        moodBonus: 8
    },
    6: {
        title: "å³­å£æ”€ç™»",
        defaultTitle: "éº¦ç§¸å²­æŒ‘æˆ˜",
        description: "é™¡å³­å²©å£å¦‚åŒéº¦ç§¸èˆ¬è€¸ç«‹ï¼Œéœ€è¦æ‰‹è„šå¹¶ç”¨",
        moodBonus: 10
    },
    7: {
        title: "é‡‘è‰²è¥åœ°",
        defaultTitle: "æ°´çªå­è¥åœ°å¤•ç…§",
        description: "é³Œå¤ªçº¿ä¸Šæœ€ä¼˜è´¨çš„è¥åœ°ï¼Œå¤•é˜³å°†æ•´ç‰‡è¥åœ°æŸ“æˆé‡‘è‰²",
        moodBonus: 12
    },
    8: {
        title: "èƒœåˆ©ç»ˆç‚¹",
        defaultTitle: "å¤ªç™½å±±æ™¯åŒºåˆ°è¾¾",
        description: "ç»ˆç‚¹ï¼é³Œå¤ªç©¿è¶Šä¹‹æ—…ç”»ä¸Šåœ†æ»¡å¥å·",
        moodBonus: 15
    }
};

// ç‰¹æ®Šé£æ™¯äº‹ä»¶é…ç½®
const SPECIAL_SCENERY_EVENTS = {
    sea_of_clouds: {
        id: "sea_of_clouds",
        name: "äº‘æµ·å¥‡è§‚",
        icon: "â˜ï¸ğŸ”ï¸â˜ï¸",
        description: "æ™´ç©ºä¹‹ä¸‹ï¼Œé³Œå±±å¤§æ¢å‘¨å›´çªç„¶æ¶Œç°å‡ºå£®è§‚çš„äº‘æµ·ã€‚äº‘å±‚å¦‚æµ·æµªèˆ¬ç¿»æ¶Œï¼Œå±±å³°å¦‚å²›å±¿èˆ¬çŸ—ç«‹ï¼Œä»¿ä½›ç½®èº«ä»™å¢ƒã€‚",
        condition: {
            nodeId: 3, // é³Œå±±å¤§æ¢
            weather: ["sunny", "cloudy"],
            probability: 0.4
        },
        moodBonus: 25,
        specialTitle: "äº‘æµ·ä»™å¢ƒ",
        achievement: "äº‘æµ·è§è¯è€…"
    },
    meteor_shower: {
        id: "meteor_shower",
        name: "æµæ˜Ÿé›¨",
        icon: "ğŸŒ âœ¨ğŸŒŒ",
        description: "å¤œå¹•é™ä¸´ï¼Œ2900è¥åœ°ä¸Šç©ºçªç„¶åˆ’è¿‡ä¸€é“é“æµæ˜Ÿã€‚ç’€ç’¨çš„å…‰èŠ’åˆ’ç ´å¤œç©ºï¼Œä½ èµ¶ç´§è®¸ä¸‹å¿ƒæ„¿...",
        condition: {
            nodeId: 2, // 2900è¥åœ°
            time: "night", // å¤œé—´
            probability: 0.3
        },
        moodBonus: 30,
        specialTitle: "æµæ˜Ÿè®¸æ„¿",
        achievement: "æ˜Ÿç©ºæ‘„å½±å¸ˆ"
    },
    mysterious_fog: {
        id: "mysterious_fog",
        name: "è¿·é›¾å¯¼èˆªæ¶",
        icon: "ğŸŒ«ï¸ğŸ—¼ğŸŒ«ï¸",
        description: "å¤§é›¾ä¸­çš„å¯¼èˆªæ¶è‹¥éšè‹¥ç°ï¼Œé‡‘å±æ¶åœ¨é›¾ä¸­æ³›ç€å¹½å¹½çš„å…‰ã€‚å‘¨å›´ä¸€ç‰‡å¯‚é™ï¼Œä»¿ä½›è¿›å…¥äº†å¦ä¸€ä¸ªä¸–ç•Œ...",
        condition: {
            nodeId: 4, // å¯¼èˆªæ¶
            weather: ["fog"],
            probability: 0.5
        },
        moodBonus: 20,
        specialTitle: "è¿·é›¾åœ°æ ‡",
        achievement: "è¿·é›¾æ¢ç´¢è€…"
    },
    snowy_temple: {
        id: "snowy_temple",
        name: "é›ªä¸­å¤åº™",
        icon: "â„ï¸â›©ï¸â„ï¸",
        description: "é›ªèŠ±è½»è½»é£˜è½åœ¨è¯ç‹åº™çš„å±‹æªä¸Šï¼Œå¤è€çš„åº™å®‡åœ¨ç™½é›ªçš„è¦†ç›–ä¸‹æ›´æ˜¾åº„ä¸¥è‚ƒç©†ã€‚ä¸€ç‰‡é“¶è£…ç´ è£¹ï¼Œç¾ä¸èƒœæ”¶ã€‚",
        condition: {
            nodeId: 5, // è¯ç‹åº™
            weather: ["snow", "snowstorm"],
            probability: 0.6
        },
        moodBonus: 22,
        specialTitle: "é›ªè¦†å¤åº™",
        achievement: "é›ªä¸­è¡Œè€…"
    },
    golden_sunset: {
        id: "golden_sunset",
        name: "é‡‘è‰²å¤•é˜³",
        icon: "ğŸŒ…â›ºğŸŒ…",
        description: "å¤•é˜³è¥¿ä¸‹ï¼Œæ°´çªå­è¥åœ°è¢«æŸ“æˆä¸€ç‰‡é‡‘è‰²ã€‚è¿œå¤„çš„å±±å³°é•€ä¸Šäº†é‡‘è¾¹ï¼Œè¿™æ˜¯å…¨ç¨‹æœ€ç¾çš„æ—¶åˆ»ã€‚",
        condition: {
            nodeId: 7, // æ°´çªå­è¥åœ°
            time: "dusk", // é»„æ˜
            probability: 0.5
        },
        moodBonus: 20,
        specialTitle: "é‡‘è‰²æ—¶åˆ»",
        achievement: "è¿½å…‰è€…"
    },
    eagle_sight: {
        id: "eagle_sight",
        name: "é›„é¹°å±•ç¿…",
        icon: "ğŸ¦…â›°ï¸ğŸ¦…",
        description: "ä¸€åªé›„é¹°åœ¨éº¦ç§¸å²­ä¸Šç©ºç›˜æ—‹ï¼Œç¿…è†€å±•å¼€è¶³æœ‰ä¸¤ç±³ã€‚å®ƒä¼˜é›…åœ°æ»‘ç¿”ï¼Œä»¿ä½›åœ¨å·¡è§†è‡ªå·±çš„é¢†åœ°ã€‚",
        condition: {
            nodeId: 6, // éº¦ç§¸å²­
            weather: ["sunny", "cloudy"],
            probability: 0.35
        },
        moodBonus: 18,
        specialTitle: "é›„é¹°ä¹‹çœ¼",
        achievement: "å¤©ç©ºè§‚å¯Ÿè€…"
    }
};

// ==================== ç›¸å†Œæ•°æ®ç®¡ç† ====================

// ç›¸å†Œæ•°æ®å­˜å‚¨
let photoAlbum = {
    photos: [], // æ‰€æœ‰ç…§ç‰‡
    nodePhotos: {}, // æŒ‰èŠ‚ç‚¹åˆ†ç±» {nodeId: [photoIds]}
    specialEventsTriggered: [], // å·²è§¦å‘çš„ç‰¹æ®Šäº‹ä»¶
    totalViewTime: 0, // æ€»è§‚æ™¯æ—¶é—´(åˆ†é’Ÿ)
    photosTaken: 0 // æ‹ç…§æ¬¡æ•°
};

// ä»localStorageåŠ è½½ç›¸å†Œæ•°æ®
function loadPhotoAlbum() {
    const saved = localStorage.getItem("aotai_photo_album");
    if (saved) {
        photoAlbum = JSON.parse(saved);
    }
}

// ä¿å­˜ç›¸å†Œæ•°æ®åˆ°localStorage
function savePhotoAlbum() {
    localStorage.setItem("aotai_photo_album", JSON.stringify(photoAlbum));
}

// ==================== å®æ™¯æŸ¥çœ‹ç³»ç»Ÿ ====================

let sceneryViewActive = false;
let currentSceneryData = null;

/**
 * åˆå§‹åŒ–å®æ™¯æŸ¥çœ‹ç³»ç»Ÿ
 */
function initScenerySystem() {
    loadPhotoAlbum();
    createSceneryModal();
    createAlbumModal();
    addSceneryViewButton();
    addAlbumButton();
}

/**
 * åˆ›å»ºå®æ™¯æŸ¥çœ‹å¼¹çª—
 */
function createSceneryModal() {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (document.getElementById('scenery-modal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'scenery-modal';
    modal.className = 'screen modal';
    modal.innerHTML = `
        <div class="modal-content scenery-content">
            <div class="scenery-header">
                <h3 id="scenery-title">èŠ‚ç‚¹å®æ™¯</h3>
                <button class="btn-close" onclick="closeSceneryView()">âœ•</button>
            </div>
            <div class="scenery-scene" id="scenery-scene">
                <div class="emoji-scene" id="emoji-scene"></div>
                <div class="scene-weather-overlay" id="scene-weather-overlay"></div>
                <div class="scene-effects" id="scene-effects"></div>
                <div class="special-event-overlay" id="special-event-overlay"></div>
            </div>
            <div class="scenery-info">
                <div class="scenery-description" id="scenery-description"></div>
                <div class="scenery-features" id="scenery-features"></div>
                <div class="scenery-atmosphere" id="scenery-atmosphere"></div>
                <div class="special-event-info" id="special-event-info" style="display:none;">
                    <div class="special-event-badge">âœ¨ ç‰¹æ®Šæ™¯è§‚</div>
                    <div class="special-event-name" id="special-event-name"></div>
                    <div class="special-event-desc" id="special-event-desc"></div>
                </div>
            </div>
            <div class="scenery-actions">
                <button id="btn-take-photo" class="btn btn-primary">ğŸ“¸ æ‹ç…§ç•™å¿µ</button>
                <button id="btn-explore-scenery" class="btn btn-success">ğŸ” ä»”ç»†æ¢ç´¢</button>
                <button class="btn btn-secondary" onclick="closeSceneryView()">è¿”å›</button>
            </div>
            <div class="view-time-hint" id="view-time-hint">é¢„è®¡è€—æ—¶: 15åˆ†é’Ÿ</div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬
    document.getElementById('btn-take-photo').addEventListener('click', takePhoto);
    document.getElementById('btn-explore-scenery').addEventListener('click', exploreScenery);
}

/**
 * åˆ›å»ºç›¸å†Œå¼¹çª—
 */
function createAlbumModal() {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (document.getElementById('album-modal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'album-modal';
    modal.className = 'screen modal';
    modal.innerHTML = `
        <div class="modal-content album-content">
            <div class="album-header">
                <h3>ğŸ“· é£æ™¯ç›¸å†Œ</h3>
                <div class="album-stats">
                    <span id="album-progress">æ”¶é›†è¿›åº¦: 0/9</span>
                    <span id="album-special">ç‰¹æ®Šæ™¯è§‚: 0</span>
                </div>
                <button class="btn-close" onclick="closeAlbum()">âœ•</button>
            </div>
            <div class="album-tabs">
                <button class="tab-btn active" data-tab="all">å…¨éƒ¨ç…§ç‰‡</button>
                <button class="tab-btn" data-tab="nodes">æŒ‰èŠ‚ç‚¹</button>
                <button class="tab-btn" data-tab="special">ç‰¹æ®Šæ™¯è§‚</button>
            </div>
            <div class="album-body">
                <div class="album-grid" id="album-grid">
                    <!-- ç…§ç‰‡ç½‘æ ¼ -->
                </div>
                <div class="album-nodes" id="album-nodes" style="display:none;">
                    <!-- æŒ‰èŠ‚ç‚¹åˆ†ç±» -->
                </div>
                <div class="album-special-events" id="album-special-events" style="display:none;">
                    <!-- ç‰¹æ®Šæ™¯è§‚ -->
                </div>
            </div>
            <div class="album-actions">
                <button class="btn btn-secondary" onclick="closeAlbum()">å…³é—­</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // æ·»åŠ æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
    modal.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchAlbumTab(btn.dataset.tab));
    });
}

/**
 * æ·»åŠ å®æ™¯æŸ¥çœ‹æŒ‰é’®åˆ°æ¸¸æˆç•Œé¢
 */
function addSceneryViewButton() {
    const actionPanel = document.querySelector('.action-panel');
    if (!actionPanel) return;
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (document.getElementById('btn-scenery')) return;
    
    const sceneryBtn = document.createElement('button');
    sceneryBtn.id = 'btn-scenery';
    sceneryBtn.className = 'btn btn-info';
    sceneryBtn.innerHTML = 'ğŸ“· å®æ™¯';
    sceneryBtn.title = 'æŸ¥çœ‹å½“å‰èŠ‚ç‚¹å®æ™¯';
    sceneryBtn.addEventListener('click', openSceneryView);
    
    // æ’å…¥åˆ°å­˜æ¡£æŒ‰é’®ä¹‹å‰
    const saveBtn = document.getElementById('btn-save');
    if (saveBtn) {
        actionPanel.insertBefore(sceneryBtn, saveBtn);
    } else {
        actionPanel.appendChild(sceneryBtn);
    }
}

/**
 * æ·»åŠ ç›¸å†ŒæŒ‰é’®åˆ°ä¸»èœå•
 */
function addAlbumButton() {
    const menuButtons = document.querySelector('.menu-buttons');
    if (!menuButtons) return;
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (document.getElementById('btn-album')) return;
    
    const albumBtn = document.createElement('button');
    albumBtn.id = 'btn-album';
    albumBtn.className = 'btn btn-info';
    albumBtn.innerHTML = 'ğŸ“· é£æ™¯ç›¸å†Œ';
    albumBtn.addEventListener('click', openAlbum);
    
    // æ’å…¥åˆ°å¸®åŠ©æŒ‰é’®ä¹‹å‰
    const helpBtn = document.getElementById('btn-help');
    if (helpBtn) {
        menuButtons.insertBefore(albumBtn, helpBtn);
    } else {
        menuButtons.appendChild(albumBtn);
    }
}

/**
 * æ‰“å¼€å®æ™¯æŸ¥çœ‹
 */
function openSceneryView() {
    if (sceneryViewActive) return;
    if (typeof gameState === 'undefined' || !gameState.currentNode !== undefined && gameState.currentNode === undefined) {
        showNotification("æ¸¸æˆå°šæœªå¼€å§‹ï¼", "error");
        return;
    }
    
    const nodeId = gameState.currentNode;
    const scenery = NODE_SCENERY[nodeId];
    
    if (!scenery) {
        showNotification("å½“å‰ä½ç½®æ²¡æœ‰å®æ™¯æ•°æ®", "error");
        return;
    }
    
    sceneryViewActive = true;
    currentSceneryData = {
        nodeId: nodeId,
        scenery: scenery,
        specialEvent: null
    };
    
    // å¡«å……å†…å®¹
    document.getElementById('scenery-title').textContent = scenery.name;
    document.getElementById('emoji-scene').textContent = scenery.emojiScene;
    document.getElementById('scenery-description').textContent = scenery.description;
    
    // ç‰¹è‰²æ ‡ç­¾
    const featuresContainer = document.getElementById('scenery-features');
    featuresContainer.innerHTML = scenery.features.map(f => 
        `<span class="feature-tag">${f}</span>`
    ).join('');
    
    // æ°›å›´æè¿°
    document.getElementById('scenery-atmosphere').innerHTML = 
        `<span class="atmosphere-label">æ°›å›´ï¼š</span>${scenery.atmosphere}`;
    
    // æ£€æŸ¥å¹¶åº”ç”¨ç‰¹æ®Šé£æ™¯äº‹ä»¶
    checkSpecialSceneryEvent(nodeId);
    
    // åº”ç”¨å¤©æ°”æ•ˆæœåˆ°åœºæ™¯
    applyWeatherToScenery();
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('scenery-modal').classList.add('active');
    
    // è®°å½•è§‚æ™¯æ—¶é—´
    photoAlbum.totalViewTime += 15;
    savePhotoAlbum();
    
    // æ¶ˆè€—å°‘é‡æ—¶é—´å’Œä½“åŠ›
    if (typeof gameState !== 'undefined') {
        gameState.stamina = Math.max(0, gameState.stamina - 2);
        
        // æ¢å¤å°‘é‡å¿ƒæƒ…
        const moodRecovery = 5 + Math.floor(Math.random() * 6); // 5-10
        gameState.mood = Math.min(100, gameState.mood + moodRecovery);
        
        if (typeof logEvent === 'function') {
            logEvent(`æ¬£èµäº†${scenery.name}çš„å®æ™¯ï¼Œå¿ƒæƒ…æœ‰æ‰€æ¢å¤ (+${moodRecovery})`);
        }
        if (typeof updateUI === 'function') {
            updateUI();
        }
    }
}

/**
 * å…³é—­å®æ™¯æŸ¥çœ‹
 */
function closeSceneryView() {
    const modal = document.getElementById('scenery-modal');
    if (modal) modal.classList.remove('active');
    sceneryViewActive = false;
    currentSceneryData = null;
}

/**
 * æ£€æŸ¥ç‰¹æ®Šé£æ™¯äº‹ä»¶
 */
function checkSpecialSceneryEvent(nodeId) {
    const specialOverlay = document.getElementById('special-event-overlay');
    const specialInfo = document.getElementById('special-event-info');
    const specialName = document.getElementById('special-event-name');
    const specialDesc = document.getElementById('special-event-desc');
    
    // é‡ç½®æ˜¾ç¤º
    specialOverlay.style.display = 'none';
    specialInfo.style.display = 'none';
    
    // æ£€æŸ¥æ¯ä¸ªç‰¹æ®Šäº‹ä»¶
    for (const [eventId, eventData] of Object.entries(SPECIAL_SCENERY_EVENTS)) {
        if (eventData.condition.nodeId !== nodeId) continue;
        
        // æ£€æŸ¥å¤©æ°”æ¡ä»¶
        if (eventData.condition.weather) {
            const currentWeather = gameState.weather ? gameState.weather.id : 'sunny';
            if (!eventData.condition.weather.includes(currentWeather)) continue;
        }
        
        // æ£€æŸ¥æ—¶é—´æ¡ä»¶
        if (eventData.condition.time) {
            const currentTime = getTimeOfDay ? getTimeOfDay() : 'day';
            if (eventData.condition.time !== currentTime) continue;
        }
        
        // æ¦‚ç‡æ£€æŸ¥
        if (Math.random() > eventData.condition.probability) continue;
        
        // è§¦å‘ç‰¹æ®Šäº‹ä»¶ï¼
        triggerSpecialSceneryEvent(eventData);
        return;
    }
}

/**
 * è§¦å‘ç‰¹æ®Šé£æ™¯äº‹ä»¶
 */
function triggerSpecialSceneryEvent(eventData) {
    currentSceneryData.specialEvent = eventData;
    
    const specialOverlay = document.getElementById('special-event-overlay');
    const specialInfo = document.getElementById('special-event-info');
    const specialName = document.getElementById('special-event-name');
    const specialDesc = document.getElementById('special-event-desc');
    const emojiScene = document.getElementById('emoji-scene');
    
    // æ˜¾ç¤ºç‰¹æ®Šæ•ˆæœ
    specialOverlay.style.display = 'block';
    specialOverlay.innerHTML = `<div class="special-emoji-animation">${eventData.icon}</div>`;
    
    // æ›´æ–°ä¿¡æ¯
    specialInfo.style.display = 'block';
    specialName.textContent = eventData.name;
    specialDesc.textContent = eventData.description;
    
    // æ›´æ–°emojiåœºæ™¯
    emojiScene.innerHTML = `${eventData.icon}<div class="special-scene-label">${eventData.name}</div>`;
    
    // è®°å½•è§¦å‘
    if (!photoAlbum.specialEventsTriggered.includes(eventData.id)) {
        photoAlbum.specialEventsTriggered.push(eventData.id);
        savePhotoAlbum();
        
        // æ˜¾ç¤ºé€šçŸ¥
        showNotification(`âœ¨ å‘ç°ç‰¹æ®Šæ™¯è§‚ï¼š${eventData.name}ï¼`, "success");
        
        // è®°å½•åˆ°æ¸¸æˆæ—¥å¿—
        if (typeof logEvent === 'function') {
            logEvent(`ğŸ‰ ç‰¹æ®Šæ™¯è§‚ï¼š${eventData.name} - ${eventData.description.substring(0, 30)}...`);
        }
        
        // é¢å¤–å¿ƒæƒ…å¥–åŠ±
        if (typeof gameState !== 'undefined') {
            gameState.mood = Math.min(100, gameState.mood + eventData.moodBonus);
        }
    }
}

/**
 * æ‹ç…§ç•™å¿µ
 */
function takePhoto() {
    if (!currentSceneryData) return;
    
    const { nodeId, scenery, specialEvent } = currentSceneryData;
    const photoTemplate = PHOTO_TEMPLATES[nodeId];
    
    // ç”Ÿæˆç…§ç‰‡æ•°æ®
    const photo = {
        id: `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        nodeId: nodeId,
        nodeName: scenery.name,
        title: specialEvent ? specialEvent.specialTitle : photoTemplate.title,
        description: specialEvent ? specialEvent.description : photoTemplate.description,
        emojiScene: specialEvent ? specialEvent.icon : scenery.emojiScene,
        timestamp: Date.now(),
        gameDay: gameState.day,
        gameHour: gameState.hour,
        weather: gameState.weather ? gameState.weather.name : 'æœªçŸ¥',
        isSpecial: !!specialEvent,
        specialEventId: specialEvent ? specialEvent.id : null,
        moodBonus: specialEvent ? specialEvent.moodBonus : photoTemplate.moodBonus
    };
    
    // æ·»åŠ åˆ°ç›¸å†Œ
    photoAlbum.photos.push(photo);
    if (!photoAlbum.nodePhotos[nodeId]) {
        photoAlbum.nodePhotos[nodeId] = [];
    }
    photoAlbum.nodePhotos[nodeId].push(photo.id);
    photoAlbum.photosTaken++;
    savePhotoAlbum();
    
    // æ¢å¤å¿ƒæƒ…å€¼
    const moodRecovery = photo.moodBonus;
    gameState.mood = Math.min(100, gameState.mood + moodRecovery);
    
    // æ¶ˆè€—å°‘é‡ä½“åŠ›
    gameState.stamina = Math.max(0, gameState.stamina - 3);
    
    // æ˜¾ç¤ºæ‹ç…§æ•ˆæœ
    showPhotoEffect(photo);
    
    // è®°å½•æ—¥å¿—
    if (typeof logEvent === 'function') {
        logEvent(`ğŸ“¸ åœ¨${scenery.name}æ‹ç…§ç•™å¿µï¼š${photo.title} (+${moodRecovery}å¿ƒæƒ…)`);
    }
    
    // æ£€æŸ¥æ‘„å½±å¸ˆæˆå°±
    checkPhotographerAchievement();
    
    if (typeof updateUI === 'function') {
        updateUI();
    }
    
    // å»¶è¿Ÿå…³é—­
    setTimeout(() => {
        closeSceneryView();
    }, 1500);
}

/**
 * æ˜¾ç¤ºæ‹ç…§æ•ˆæœ
 */
function showPhotoEffect(photo) {
    const effect = document.createElement('div');
    effect.className = 'photo-flash-effect';
    effect.innerHTML = `
        <div class="flash-overlay"></div>
        <div class="photo-preview">
            <div class="preview-emoji">${photo.emojiScene}</div>
            <div class="preview-title">${photo.title}</div>
            <div class="preview-location">ğŸ“ ${photo.nodeName}</div>
            <div class="preview-saved">âœ“ å·²ä¿å­˜åˆ°ç›¸å†Œ</div>
        </div>
    `;
    document.body.appendChild(effect);
    
    setTimeout(() => effect.classList.add('active'), 10);
    setTimeout(() => {
        effect.classList.remove('active');
        setTimeout(() => effect.remove(), 300);
    }, 1200);
}

/**
 * ä»”ç»†æ¢ç´¢
 */
function exploreScenery() {
    if (!currentSceneryData) return;
    
    const { nodeId, scenery } = currentSceneryData;
    
    // æ¶ˆè€—æ›´å¤šä½“åŠ›å’Œæ—¶é—´
    gameState.stamina = Math.max(0, gameState.stamina - 8);
    photoAlbum.totalViewTime += 30;
    savePhotoAlbum();
    
    // å¯èƒ½å‘ç°ç‰©å“æˆ–è§¦å‘äº‹ä»¶
    const rand = Math.random();
    
    if (rand < 0.2) {
        // å‘ç°è¡¥ç»™
        const foodGain = 10;
        const waterGain = 10;
        gameState.food = Math.min(100, gameState.food + foodGain);
        gameState.water = Math.min(100, gameState.water + waterGain);
        if (typeof logEvent === 'function') {
            logEvent(`åœ¨${scenery.name}æ¢ç´¢æ—¶å‘ç°äº†è¡¥ç»™ï¼(+${foodGain}é£Ÿç‰©, +${waterGain}æ°´)`);
        }
        showNotification("æ¢ç´¢å‘ç°ï¼šè¡¥ç»™å“ï¼", "success");
    } else if (rand < 0.4 && scenery.specialEvent) {
        // è§¦å‘èŠ‚ç‚¹ç‰¹æ®Šäº‹ä»¶
        if (typeof triggerSceneryEvent === 'function') {
            triggerSceneryEvent(nodeId);
        }
    } else {
        // æ™®é€šæ¢ç´¢ç»“æœ
        const moodGain = 8;
        gameState.mood = Math.min(100, gameState.mood + moodGain);
        if (typeof logEvent === 'function') {
            logEvent(`ä»”ç»†æ¢ç´¢äº†${scenery.name}ï¼Œå¯¹è¿™é‡Œæœ‰äº†æ›´æ·±çš„äº†è§£ã€‚(+${moodGain}å¿ƒæƒ…)`);
        }
        showNotification("æ¢ç´¢å®Œæˆï¼šæœ‰äº†æ›´æ·±çš„äº†è§£", "info");
    }
    
    closeSceneryView();
    if (typeof updateUI === 'function') {
        updateUI();
    }
}

/**
 * åº”ç”¨å¤©æ°”æ•ˆæœåˆ°å®æ™¯
 */
function applyWeatherToScenery() {
    const sceneEffects = document.getElementById('scene-effects');
    const weatherOverlay = document.getElementById('scene-weather-overlay');
    if (!sceneEffects || !weatherOverlay) return;
    
    sceneEffects.innerHTML = '';
    
    const weatherId = gameState.weather ? gameState.weather.id : 'sunny';
    const visual = WEATHER_VISUALS ? WEATHER_VISUALS[weatherId] : null;
    
    if (visual && visual.particleEffect) {
        // åœ¨å®æ™¯ä¸­å¤åˆ¶å¤©æ°”æ•ˆæœ
        switch(visual.particleEffect) {
            case 'rain-light':
            case 'rain-heavy':
                createSceneryRain(sceneEffects, 30);
                break;
            case 'snow':
                createScenerySnow(sceneEffects, 40);
                break;
            case 'fog':
                weatherOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(200,210,220,0.4);
                    backdrop-filter: blur(3px);
                    z-index: 2;
                `;
                break;
            case 'cloud':
                weatherOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(255,255,255,0.2);
                    z-index: 2;
                `;
                break;
        }
    } else {
        weatherOverlay.style.cssText = 'display: none;';
    }
}

/**
 * åˆ›å»ºå®æ™¯é›¨æ»´
 */
function createSceneryRain(container, count) {
    for (let i = 0; i < count; i++) {
        const drop = document.createElement('div');
        drop.className = 'scenery-rain-drop';
        drop.style.cssText = `
            position: absolute;
            width: 2px;
            height: 15px;
            background: linear-gradient(to bottom, transparent, rgba(174,194,224,0.8));
            left: ${Math.random() * 100}%;
            top: -20px;
            animation: rain-fall ${0.5 + Math.random() * 0.5}s linear infinite;
            animation-delay: ${Math.random() * 2}s;
            z-index: 3;
        `;
        container.appendChild(drop);
    }
}

/**
 * åˆ›å»ºå®æ™¯é›ªèŠ±
 */
function createScenerySnow(container, count) {
    for (let i = 0; i < count; i++) {
        const flake = document.createElement('div');
        flake.className = 'scenery-snow-flake';
        const size = 3 + Math.random() * 5;
        flake.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            left: ${Math.random() * 100}%;
            top: -10px;
            animation: snow-fall ${3 + Math.random() * 4}s linear infinite;
            animation-delay: ${Math.random() * 5}s;
            z-index: 3;
        `;
        container.appendChild(flake);
    }
}

// ==================== ç›¸å†Œç³»ç»Ÿ ====================

/**
 * æ‰“å¼€ç›¸å†Œ
 */
function openAlbum() {
    renderAlbum();
    document.getElementById('album-modal').classList.add('active');
}

/**
 * å…³é—­ç›¸å†Œ
 */
function closeAlbum() {
    document.getElementById('album-modal').classList.remove('active');
}

/**
 * åˆ‡æ¢ç›¸å†Œæ ‡ç­¾
 */
function switchAlbumTab(tab) {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.album-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    // æ˜¾ç¤ºå¯¹åº”å†…å®¹
    document.getElementById('album-grid').style.display = tab === 'all' ? 'grid' : 'none';
    document.getElementById('album-nodes').style.display = tab === 'nodes' ? 'block' : 'none';
    document.getElementById('album-special-events').style.display = tab === 'special' ? 'block' : 'none';
    
    // é‡æ–°æ¸²æŸ“
    if (tab === 'all') renderAlbumGrid();
    else if (tab === 'nodes') renderAlbumByNodes();
    else if (tab === 'special') renderAlbumSpecial();
}

/**
 * æ¸²æŸ“ç›¸å†Œ
 */
function renderAlbum() {
    // æ›´æ–°ç»Ÿè®¡
    const uniqueNodes = Object.keys(photoAlbum.nodePhotos).length;
    const totalNodes = 9;
    const specialCount = photoAlbum.specialEventsTriggered.length;
    
    document.getElementById('album-progress').textContent = `æ”¶é›†è¿›åº¦: ${uniqueNodes}/${totalNodes}`;
    document.getElementById('album-special').textContent = `ç‰¹æ®Šæ™¯è§‚: ${specialCount}`;
    
    // æ¸²æŸ“å½“å‰æ ‡ç­¾
    const activeTab = document.querySelector('.album-tabs .tab-btn.active');
    if (activeTab) {
        switchAlbumTab(activeTab.dataset.tab);
    } else {
        renderAlbumGrid();
    }
}

/**
 * æ¸²æŸ“ç…§ç‰‡ç½‘æ ¼
 */
function renderAlbumGrid() {
    const grid = document.getElementById('album-grid');
    grid.innerHTML = '';
    
    if (photoAlbum.photos.length === 0) {
        grid.innerHTML = `
            <div class="album-empty">
                <div class="empty-icon">ğŸ“·</div>
                <div class="empty-text">è¿˜æ²¡æœ‰ç…§ç‰‡</div>
                <div class="empty-hint">åœ¨æ¸¸æˆä¸­ä½¿ç”¨"å®æ™¯"åŠŸèƒ½æ‹ç…§ç•™å¿µ</div>
            </div>
        `;
        return;
    }
    
    // æŒ‰æ—¶é—´å€’åºæ’åˆ—
    const sortedPhotos = [...photoAlbum.photos].sort((a, b) => b.timestamp - a.timestamp);
    
    sortedPhotos.forEach(photo => {
        const card = createPhotoCard(photo);
        grid.appendChild(card);
    });
}

/**
 * æŒ‰èŠ‚ç‚¹æ¸²æŸ“ç›¸å†Œ
 */
function renderAlbumByNodes() {
    const container = document.getElementById('album-nodes');
    container.innerHTML = '';
    
    if (photoAlbum.photos.length === 0) {
        container.innerHTML = '<div class="album-empty">è¿˜æ²¡æœ‰ç…§ç‰‡</div>';
        return;
    }
    
    // éå†æ‰€æœ‰èŠ‚ç‚¹
    for (let i = 0; i <= 8; i++) {
        const nodePhotos = photoAlbum.photos.filter(p => p.nodeId === i);
        if (nodePhotos.length === 0) continue;
        
        const nodeSection = document.createElement('div');
        nodeSection.className = 'album-node-section';
        
        const nodeName = NODE_SCENERY[i] ? NODE_SCENERY[i].name : `èŠ‚ç‚¹${i}`;
        nodeSection.innerHTML = `<h4 class="node-section-title">${nodeName} (${nodePhotos.length}å¼ )</h4>`;
        
        const nodeGrid = document.createElement('div');
        nodeGrid.className = 'album-node-grid';
        
        nodePhotos.forEach(photo => {
            const card = createPhotoCard(photo, true);
            nodeGrid.appendChild(card);
        });
        
        nodeSection.appendChild(nodeGrid);
        container.appendChild(nodeSection);
    }
}

/**
 * æ¸²æŸ“ç‰¹æ®Šæ™¯è§‚
 */
function renderAlbumSpecial() {
    const container = document.getElementById('album-special-events');
    container.innerHTML = '';
    
    const specialPhotos = photoAlbum.photos.filter(p => p.isSpecial);
    
    if (specialPhotos.length === 0) {
        container.innerHTML = `
            <div class="album-empty">
                <div class="empty-icon">âœ¨</div>
                <div class="empty-text">è¿˜æ²¡æœ‰ç‰¹æ®Šæ™¯è§‚ç…§ç‰‡</div>
                <div class="empty-hint">åœ¨ç‰¹å®šå¤©æ°”å’Œæ—¶é—´æ¡ä»¶ä¸‹æ¢ç´¢èŠ‚ç‚¹ï¼Œæœ‰æœºä¼šè§¦å‘ç‰¹æ®Šæ™¯è§‚</div>
                <div class="special-hints">
                    <div class="hint-item">â˜€ï¸ğŸ”ï¸ æ™´å¤©+é³Œå±±å¤§æ¢ = äº‘æµ·å¥‡è§‚</div>
                    <div class="hint-item">ğŸŒ  å¤œé—´+2900è¥åœ° = æµæ˜Ÿé›¨</div>
                    <div class="hint-item">ğŸŒ«ï¸ å¤§é›¾+å¯¼èˆªæ¶ = ç¥ç§˜æ°›å›´</div>
                    <div class="hint-item">â„ï¸ é›ªå¤©+è¯ç‹åº™ = é›ªä¸­å¤åº™</div>
                </div>
            </div>
        `;
        return;
    }
    
    const grid = document.createElement('div');
    grid.className = 'album-special-grid';
    
    specialPhotos.forEach(photo => {
        const card = createPhotoCard(photo);
        grid.appendChild(card);
    });
    
    container.appendChild(grid);
}

/**
 * åˆ›å»ºç…§ç‰‡å¡ç‰‡
 */
function createPhotoCard(photo, compact = false) {
    const card = document.createElement('div');
    card.className = `photo-card ${photo.isSpecial ? 'special' : ''}`;
    
    const date = new Date(photo.timestamp);
    const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    
    card.innerHTML = `
        <div class="photo-image">
            <div class="photo-emoji">${photo.emojiScene}</div>
            ${photo.isSpecial ? '<div class="special-badge">âœ¨</div>' : ''}
        </div>
        <div class="photo-info">
            <div class="photo-title">${photo.title}</div>
            <div class="photo-meta">
                <span class="photo-location">ğŸ“ ${photo.nodeName}</span>
                <span class="photo-time">${dateStr}</span>
            </div>
            ${!compact ? `<div class="photo-desc">${photo.description.substring(0, 50)}...</div>` : ''}
        </div>
        <button class="photo-delete" onclick="deletePhoto('${photo.id}')" title="åˆ é™¤ç…§ç‰‡">ğŸ—‘ï¸</button>
    `;
    
    // ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
    card.addEventListener('click', (e) => {
        if (!e.target.classList.contains('photo-delete')) {
            showPhotoDetail(photo);
        }
    });
    
    return card;
}

/**
 * æ˜¾ç¤ºç…§ç‰‡è¯¦æƒ…
 */
function showPhotoDetail(photo) {
    const date = new Date(photo.timestamp);
    const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    
    const modal = document.createElement('div');
    modal.className = 'screen modal photo-detail-modal';
    modal.innerHTML = `
        <div class="modal-content photo-detail-content">
            <button class="btn-close" onclick="this.closest('.modal').remove()">âœ•</button>
            <div class="photo-detail-image">
                <div class="detail-emoji">${photo.emojiScene}</div>
            </div>
            <div class="photo-detail-info">
                <h3>${photo.title}</h3>
                <div class="detail-meta">
                    <div class="meta-item">ğŸ“ åœ°ç‚¹ï¼š${photo.nodeName}</div>
                    <div class="meta-item">ğŸ“… æ‹æ‘„æ—¶é—´ï¼š${dateStr}</div>
                    <div class="meta-item">ğŸ® æ¸¸æˆå†…ï¼šç¬¬${photo.gameDay}å¤© ${photo.gameHour}:00</div>
                    <div class="meta-item">ğŸŒ¤ï¸ å¤©æ°”ï¼š${photo.weather}</div>
                </div>
                <div class="detail-description">${photo.description}</div>
                ${photo.isSpecial ? `<div class="detail-special">âœ¨ ç‰¹æ®Šæ™¯è§‚ç…§ç‰‡</div>` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('active'), 10);
}

/**
 * åˆ é™¤ç…§ç‰‡
 */
function deletePhoto(photoId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) return;
    
    const photoIndex = photoAlbum.photos.findIndex(p => p.id === photoId);
    if (photoIndex === -1) return;
    
    const photo = photoAlbum.photos[photoIndex];
    
    // ä»æ•°ç»„ä¸­ç§»é™¤
    photoAlbum.photos.splice(photoIndex, 1);
    
    // ä»èŠ‚ç‚¹åˆ†ç±»ä¸­ç§»é™¤
    if (photoAlbum.nodePhotos[photo.nodeId]) {
        photoAlbum.nodePhotos[photo.nodeId] = photoAlbum.nodePhotos[photo.nodeId].filter(id => id !== photoId);
        if (photoAlbum.nodePhotos[photo.nodeId].length === 0) {
            delete photoAlbum.nodePhotos[photo.nodeId];
        }
    }
    
    savePhotoAlbum();
    renderAlbum();
    
    showNotification("ç…§ç‰‡å·²åˆ é™¤", "info");
}

// ==================== æˆå°±æ£€æŸ¥ ====================

/**
 * æ£€æŸ¥æ‘„å½±å¸ˆæˆå°±
 */
function checkPhotographerAchievement() {
    // æ£€æŸ¥æ˜¯å¦æ”¶é›†äº†æ‰€æœ‰èŠ‚ç‚¹çš„ç…§ç‰‡
    const uniqueNodes = Object.keys(photoAlbum.nodePhotos).length;
    const totalNodes = 9;
    
    if (uniqueNodes >= totalNodes) {
        // è§£é”æ‘„å½±å¸ˆæˆå°±
        if (typeof unlockAchievement === 'function') {
            unlockAchievement('photographer');
        }
        
        // æ£€æŸ¥æ˜¯å¦æ”¶é›†äº†æ‰€æœ‰ç‰¹æ®Šæ™¯è§‚
        const specialPhotos = photoAlbum.photos.filter(p => p.isSpecial);
        const uniqueSpecialEvents = [...new Set(specialPhotos.map(p => p.specialEventId))];
        
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šæˆå°±æ£€æŸ¥
        if (uniqueSpecialEvents.length >= 4) {
            // æ™¯è§‚å¤§å¸ˆæˆå°±ï¼ˆå¯ä»¥æ·»åŠ åˆ°ACHIEVEMENTSä¸­ï¼‰
            showNotification("ğŸ† æˆå°±è§£é”ï¼šæ™¯è§‚å¤§å¸ˆï¼", "success");
        }
    }
}

// ==================== CSSæ ·å¼ ====================

function addSceneryStyles() {
    // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
    if (document.getElementById('scenery-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'scenery-styles';
    style.textContent = `
        /* å®æ™¯å¼¹çª—æ ·å¼ */
        .scenery-content {
            max-width: 600px;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
        }
        
        .scenery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #2c5f2d, #4a7c4b);
            color: white;
        }
        
        .scenery-header h3 {
            margin: 0;
            color: white;
            font-size: 1.3rem;
        }
        
        .scenery-scene {
            position: relative;
            height: 220px;
            background: linear-gradient(180deg, #87ceeb 0%, #e8f4f8 50%, #c5d1db 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .emoji-scene {
            font-size: 5rem;
            z-index: 2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            animation: scene-float 3s ease-in-out infinite;
            text-align: center;
        }
        
        .special-scene-label {
            font-size: 1rem;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
            margin-top: 8px;
            animation: special-glow 2s ease-in-out infinite;
        }
        
        @keyframes special-glow {
            0%, 100% { opacity: 0.8; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
            50% { opacity: 1; text-shadow: 0 0 20px rgba(255,215,0,0.8); }
        }
        
        .scene-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }
        
        .scene-weather-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        .special-event-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 4;
            background: radial-gradient(circle at center, rgba(255,215,0,0.2) 0%, transparent 70%);
            animation: special-overlay-pulse 3s ease-in-out infinite;
        }
        
        @keyframes special-overlay-pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .special-emoji-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            animation: special-emoji-float 4s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255,215,0,0.6));
        }
        
        @keyframes special-emoji-float {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -60%) scale(1.1); }
        }
        
        @keyframes scene-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .scenery-info {
            padding: 20px;
        }
        
        .scenery-description {
            line-height: 1.8;
            color: #eaeaea;
            font-size: 0.95rem;
            margin-bottom: 15px;
        }
        
        .scenery-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .feature-tag {
            background: rgba(151,188,98,0.2);
            border: 1px solid #97bc62;
            color: #97bc62;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .scenery-atmosphere {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .atmosphere-label {
            color: #d4a574;
        }
        
        .special-event-info {
            background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,165,0,0.1));
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .special-event-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .special-event-name {
            font-size: 1.1rem;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .special-event-desc {
            font-size: 0.9rem;
            color: #ccc;
            line-height: 1.6;
        }
        
        .scenery-actions {
            padding: 0 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .view-time-hint {
            text-align: center;
            padding-bottom: 15px;
            color: #888;
            font-size: 0.85rem;
        }
        
        /* æ‹ç…§æ•ˆæœ */
        .photo-flash-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
        }
        
        .photo-flash-effect.active {
            opacity: 1;
        }
        
        .flash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            animation: flash 0.3s ease-out;
        }
        
        @keyframes flash {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .photo-preview {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: preview-pop 0.5s ease-out 0.2s both;
            border: 2px solid #97bc62;
        }
        
        @keyframes preview-pop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .preview-emoji {
            font-size: 4rem;
            margin-bottom: 10px;
        }
        
        .preview-title {
            font-size: 1.2rem;
            color: #97bc62;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .preview-location {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .preview-saved {
            color: #27ae60;
            font-size: 0.85rem;
        }
        
        /* ç›¸å†Œæ ·å¼ */
        .album-content {
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .album-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #2c5f2d, #4a7c4b);
            color: white;
        }
        
        .album-header h3 {
            margin: 0;
            color: white;
        }
        
        .album-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }
        
        .album-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #ccc;
        }
        
        .tab-btn.active {
            background: rgba(151,188,98,0.2);
            color: #97bc62;
            border-bottom: 2px solid #97bc62;
        }
        
        .album-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-height: 50vh;
        }
        
        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .album-node-grid,
        .album-special-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }
        
        .photo-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .photo-card.special {
            border: 1px solid rgba(255,215,0,0.3);
            box-shadow: 0 0 20px rgba(255,215,0,0.1);
        }
        
        .photo-image {
            height: 120px;
            background: linear-gradient(180deg, #87ceeb 0%, #c5d1db 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .photo-emoji {
            font-size: 3rem;
        }
        
        .special-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .photo-info {
            padding: 12px;
        }
        
        .photo-title {
            font-weight: bold;
            color: #eaeaea;
            font-size: 0.9rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .photo-meta {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 0.75rem;
            color: #888;
        }
        
        .photo-desc {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .photo-delete {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(231,76,60,0.8);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .photo-card:hover .photo-delete {
            opacity: 1;
        }
        
        .photo-delete:hover {
            background: rgba(231,76,60,1);
        }
        
        .album-empty {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .empty-text {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .empty-hint {
            font-size: 0.85rem;
            color: #666;
        }
        
        .special-hints {
            margin-top: 20px;
            text-align: left;
            display: inline-block;
        }
        
        .hint-item {
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .album-node-section {
            margin-bottom: 20px;
        }
        
        .node-section-title {
            color: #97bc62;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(151,188,98,0.3);
        }
        
        .album-actions {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        
        /* ç…§ç‰‡è¯¦æƒ…å¼¹çª— */
        .photo-detail-modal .modal-content {
            max-width: 500px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .photo-detail-image {
            height: 250px;
            background: linear-gradient(180deg, #87ceeb 0%, #c5d1db 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .detail-emoji {
            font-size: 6rem;
        }
        
        .photo-detail-info {
            padding: 25px;
        }
        
        .photo-detail-info h3 {
            color: #97bc62;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .detail-meta {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .meta-item {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .detail-description {
            color: #ccc;
            line-height: 1.7;
            margin-bottom: 15px;
        }
        
        .detail-special {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        /* å¤©æ°”åŠ¨ç”» */
        @keyframes rain-fall {
            to { transform: translateY(240px); }
        }
        
        @keyframes snow-fall {
            to { transform: translateY(240px) translateX(20px); }
        }
        
        .scenery-rain-drop {
            animation: rain-fall 0.6s linear infinite;
        }
        
        .scenery-snow-flake {
            animation: snow-fall 3s linear infinite;
        }
    `;
    document.head.appendChild(style);
}

// ==================== åˆå§‹åŒ– ====================

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    addSceneryStyles();
    // å»¶è¿Ÿåˆå§‹åŒ–ä»¥ç¡®ä¿å…¶ä»–ç³»ç»Ÿå·²åŠ è½½
    setTimeout(initScenerySystem, 100);
});

// å¯¼å‡ºå‡½æ•°ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        initScenerySystem,
        openSceneryView,
        closeSceneryView,
        openAlbum,
        closeAlbum,
        takePhoto,
        deletePhoto
    };
}
/**
 * é³Œå¤ªçº¿æ¨¡æ‹Ÿå™¨ - æ¸¸æˆä¸»é€»è¾‘ (é‡æ„ç‰ˆ)
 * ç§¦å²­é³Œå±±-å¤ªç™½å±±ç©¿è¶Šç”Ÿå­˜æ¸¸æˆ
 * 
 * ç‰ˆæœ¬: 2.0 - æ·±åº¦æ•´åˆçš„å¤©æ°”-åœ°å½¢-äº‹ä»¶-å±æ€§ç³»ç»Ÿ
 */

// ==================== æ¸¸æˆé…ç½® ====================

// çœŸå®é³Œå¤ªçº¿æ•°æ®
const AOTAI_DATA = {
    totalDistance: 59,          // æ€»è·ç¦» km
    totalElevation: 2075,       // ç´¯è®¡çˆ¬å‡ m
    maxAltitude: 3475,          // æœ€é«˜æµ·æ‹” m (å¯¼èˆªæ¶)
    normalDuration: { min: 3, max: 5 },  // æ­£å¸¸è€—æ—¶ 3-5å¤©
    fastRecord: 1.5,            // å¼ºé©´è®°å½• 1.5å¤©
    dangerLevel: 'high'         // æ­»äº¡é£é™©ç­‰çº§
};

// ==================== éš¾åº¦é…ç½® ====================

const DIFFICULTY_MODES = {
    easy: {
        id: "easy",
        name: "ç®€å•æ¨¡å¼",
        icon: "ğŸŒ±",
        description: "é€‚åˆæ–°æ‰‹ä½“éªŒï¼Œèµ„æºä¸°å¯Œï¼Œå¤©æ°”æ¸©å’Œ",
        color: "#4CAF50",
        initialStats: {
            stamina: 120,
            maxStamina: 120,
            food: 120,
            water: 120,
            mood: 80,
            sanity: 100,
            bodyTemp: 37
        },
        equipmentPoints: 150,
        weatherModifier: -0.30,      // æ¶åŠ£å¤©æ°”æ¦‚ç‡ -30%
        moveCostModifier: -0.20,     // ç§»åŠ¨æ¶ˆè€— -20%
        resourceDrainModifier: -0.20, // èµ„æºæ¶ˆè€— -20%
        achievementMultiplier: 0.5,   // æˆå°±å€ç‡ 0.5x
        blizzardChanceModifier: 0,    // æš´é£é›ªæ¦‚ç‡ä¿®æ­£
        permanentDeath: false,        // æ˜¯å¦æ°¸ä¹…æ­»äº¡
        unlockRequirement: null       // è§£é”æ¡ä»¶
    },
    normal: {
        id: "normal",
        name: "æ™®é€šæ¨¡å¼",
        icon: "ğŸ¯",
        description: "æ ‡å‡†æŒ‘æˆ˜ï¼Œå¹³è¡¡çš„æ¸¸æˆä½“éªŒ",
        color: "#2196F3",
        initialStats: {
            stamina: 100,
            maxStamina: 100,
            food: 100,
            water: 100,
            mood: 50,
            sanity: 100,
            bodyTemp: 37
        },
        equipmentPoints: 100,
        weatherModifier: 0,          // åŸºå‡†
        moveCostModifier: 0,         // åŸºå‡†
        resourceDrainModifier: 0,    // åŸºå‡†
        achievementMultiplier: 1.0,   // æˆå°±å€ç‡ 1.0x
        blizzardChanceModifier: 0,    // åŸºå‡†
        permanentDeath: false,
        unlockRequirement: null
    },
    hard: {
        id: "hard",
        name: "å›°éš¾æ¨¡å¼",
        icon: "ğŸ”¥",
        description: "ä¸¥å³»æŒ‘æˆ˜ï¼Œèµ„æºç´§å¼ ï¼Œå¤©æ°”æ¶åŠ£",
        color: "#FF5722",
        initialStats: {
            stamina: 80,
            maxStamina: 80,
            food: 80,
            water: 80,
            mood: 30,
            sanity: 80,
            bodyTemp: 37
        },
        equipmentPoints: 80,
        weatherModifier: 0.30,       // æ¶åŠ£å¤©æ°”æ¦‚ç‡ +30%
        moveCostModifier: 0.20,      // ç§»åŠ¨æ¶ˆè€— +20%
        resourceDrainModifier: 0.20,  // èµ„æºæ¶ˆè€— +20%
        achievementMultiplier: 1.5,   // æˆå°±å€ç‡ 1.5x
        blizzardChanceModifier: 0.15, // æš´é£é›ªæ¦‚ç‡å¢åŠ 
        permanentDeath: false,
        unlockRequirement: "complete_normal" // éœ€è¦é€šå…³æ™®é€šæ¨¡å¼
    },
    hell: {
        id: "hell",
        name: "åœ°ç‹±æ¨¡å¼",
        icon: "ğŸ’€",
        description: "æé™æŒ‘æˆ˜ï¼Œç”Ÿå­˜å‡ ç‡æä½ï¼Œæ°¸ä¹…æ­»äº¡",
        color: "#9C27B0",
        initialStats: {
            stamina: 60,
            maxStamina: 60,
            food: 60,
            water: 60,
            mood: 20,
            sanity: 60,
            bodyTemp: 36
        },
        equipmentPoints: 50,
        weatherModifier: 0.50,       // æ¶åŠ£å¤©æ°”æ¦‚ç‡ +50%
        moveCostModifier: 0.40,      // ç§»åŠ¨æ¶ˆè€— +40%
        resourceDrainModifier: 0.40,  // èµ„æºæ¶ˆè€— +40%
        achievementMultiplier: 2.0,   // æˆå°±å€ç‡ 2.0x
        blizzardChanceModifier: 0.30, // æš´é£é›ªæ¦‚ç‡å¤§å¹…å¢åŠ 
        permanentDeath: true,         // æ°¸ä¹…æ­»äº¡ï¼Œæ— å­˜æ¡£
        unlockRequirement: "complete_hard" // éœ€è¦é€šå…³å›°éš¾æ¨¡å¼
    }
};

// ç‰¹æ®Šæˆå°±ï¼ˆé«˜éš¾åº¦è§£é”ï¼‰
const SPECIAL_ACHIEVEMENTS = [
    { id: "hell_survivor", name: "åœ°ç‹±è¡Œè€…", icon: "ğŸ”¥", desc: "åœ¨åœ°ç‹±æ¨¡å¼ä¸‹å®Œæˆç©¿è¶Š", category: "special", condition: "hell_mode_complete" },
    { id: "iron_will", name: "é’¢é“æ„å¿—", icon: "âš”ï¸", desc: "åœ¨å›°éš¾æˆ–åœ°ç‹±æ¨¡å¼ä¸‹æ— ä¼¤é€šå…³", category: "special", condition: "hard_no_injury" },
    { id: "minimalist", name: "æç®€ä¸»ä¹‰è€…", icon: "ğŸƒ", desc: "åœ¨åœ°ç‹±æ¨¡å¼ä¸‹ä½¿ç”¨ä¸è¶…è¿‡30ç‚¹è£…å¤‡é¢„ç®—é€šå…³", category: "special", condition: "hell_minimal_equipment" },
    { id: "storm_master", name: "é£æš´ä¹‹ä¸»", icon: "ğŸŒªï¸", desc: "åœ¨åœ°ç‹±æ¨¡å¼ä¸‹ç»å†5æ¬¡ä»¥ä¸Šæš´é£é›ªå¹¶å­˜æ´»", category: "special", condition: "hell_blizzard_survivor" }
];

// ==================== å¤©æ°”ç³»ç»Ÿ ====================

const WEATHER_TYPES = {
    sunny: {
        id: "sunny",
        name: "æ™´å¤©",
        icon: "â˜€ï¸",
        temperature: 15,           // åŸºç¡€æ¸©åº¦(Â°C)
        windSpeed: 2,              // é£é€Ÿç­‰çº§ 0-5
        visibility: "good",        // èƒ½è§åº¦
        moveCost: 1.0,             // ç§»åŠ¨æ¶ˆè€—å€ç‡
        staminaDrain: 1.0,         // ä½“åŠ›æ¶ˆè€—å€ç‡
        waterDrain: 1.2,           // æ°´åˆ†æ¶ˆè€—å€ç‡ (æ™´å¤©å‡ºæ±—å¤š)
        foodDrain: 1.0,            // é£Ÿç‰©æ¶ˆè€—å€ç‡
        moodEffect: 5,             // å¿ƒæƒ…æ¯å°æ—¶å˜åŒ–
        bodyTempEffect: 0.5,       // ä½“æ¸©æ¯å°æ—¶å˜åŒ–
        wetnessChange: -5,         // æ¹¿èº«ç¨‹åº¦å˜åŒ–
        eventModifiers: {          // äº‹ä»¶æ¦‚ç‡ä¿®æ­£
            heatStroke: 0.15,      // ä¸­æš‘æ¦‚ç‡å¢åŠ 
            dehydration: 0.1,      // è„±æ°´æ¦‚ç‡
            sunburn: 0.08,         // æ™’ä¼¤æ¦‚ç‡
            getLost: -0.1,         // è¿·è·¯æ¦‚ç‡é™ä½
            fall: 0.0              // æ»‘å æ¦‚ç‡
        },
        description: "é˜³å…‰æ˜åªšï¼Œè§†é‡è‰¯å¥½ï¼Œä½†è¦æ³¨æ„é˜²æ™’å’Œè¡¥æ°´"
    },
    cloudy: {
        id: "cloudy",
        name: "å¤šäº‘",
        icon: "â˜ï¸",
        temperature: 12,
        windSpeed: 2,
        visibility: "good",
        moveCost: 1.0,
        staminaDrain: 1.0,
        waterDrain: 1.0,
        foodDrain: 1.0,
        moodEffect: 2,
        bodyTempEffect: 0,
        wetnessChange: -2,
        eventModifiers: {
            heatStroke: 0.05,
            dehydration: 0.02,
            getLost: 0.0,
            fall: 0.0
        },
        description: "å¤©æ°”å‡‰çˆ½ï¼Œé€‚åˆè¡Œè¿›"
    },
    lightRain: {
        id: "light_rain",
        name: "å°é›¨",
        icon: "ğŸŒ¦ï¸",
        temperature: 8,
        windSpeed: 3,
        visibility: "normal",
        moveCost: 1.2,
        staminaDrain: 1.1,
        waterDrain: 0.9,
        foodDrain: 1.1,
        moodEffect: -3,
        bodyTempEffect: -0.3,
        wetnessChange: 10,
        eventModifiers: {
            heatStroke: -0.1,
            hypothermia: 0.05,
            getLost: 0.05,
            fall: 0.08,
            equipmentDamage: 0.05
        },
        description: "è·¯é¢æ¹¿æ»‘ï¼Œå°å¿ƒè¡Œèµ°"
    },
    heavyRain: {
        id: "heavy_rain",
        name: "å¤§é›¨",
        icon: "ğŸŒ§ï¸",
        temperature: 5,
        windSpeed: 4,
        visibility: "poor",
        moveCost: 1.5,
        staminaDrain: 1.3,
        waterDrain: 0.8,
        foodDrain: 1.2,
        moodEffect: -8,
        bodyTempEffect: -0.8,
        wetnessChange: 25,
        eventModifiers: {
            heatStroke: -0.2,
            hypothermia: 0.15,
            getLost: 0.15,
            fall: 0.2,
            equipmentDamage: 0.1,
            landslide: 0.05
        },
        description: "å¤§é›¨å€¾ç›†ï¼Œèƒ½è§åº¦ä½ï¼Œå¤±æ¸©é£é™©å¢åŠ "
    },
    fog: {
        id: "fog",
        name: "å¤§é›¾",
        icon: "ğŸŒ«ï¸",
        temperature: 6,
        windSpeed: 1,
        visibility: "none",
        moveCost: 1.4,
        staminaDrain: 1.2,
        waterDrain: 1.0,
        foodDrain: 1.1,
        moodEffect: -10,
        bodyTempEffect: -0.2,
        wetnessChange: 15,
        eventModifiers: {
            getLost: 0.35,         // ææ˜“è¿·è·¯
            fall: 0.15,
            panic: 0.1,
            altitudeSickness: 0.05
        },
        description: "æµ“é›¾å¼¥æ¼«ï¼Œèƒ½è§åº¦æä½ï¼Œææ˜“è¿·è·¯"
    },
    snow: {
        id: "snow",
        name: "å°é›ª",
        icon: "ğŸŒ¨ï¸",
        temperature: -5,
        windSpeed: 3,
        visibility: "poor",
        moveCost: 1.6,
        staminaDrain: 1.4,
        waterDrain: 0.7,
        foodDrain: 1.3,
        moodEffect: -12,
        bodyTempEffect: -1.0,
        wetnessChange: 20,
        eventModifiers: {
            hypothermia: 0.2,
            frostbite: 0.1,
            getLost: 0.1,
            fall: 0.15,
            altitudeSickness: 0.05
        },
        description: "é›ªèŠ±é£˜è½ï¼Œå¯’å†·åˆºéª¨"
    },
    snowstorm: {
        id: "snowstorm",
        name: "æš´é£é›ª",
        icon: "â„ï¸",
        temperature: -15,
        windSpeed: 5,
        visibility: "none",
        moveCost: 2.5,
        staminaDrain: 2.0,
        waterDrain: 0.5,
        foodDrain: 1.5,
        moodEffect: -20,
        bodyTempEffect: -2.0,
        wetnessChange: 40,
        eventModifiers: {
            hypothermia: 0.5,      // æé«˜å¤±æ¸©é£é™©
            frostbite: 0.3,
            getLost: 0.4,
            fall: 0.25,
            altitudeSickness: 0.1,
            death: 0.05            // ç›´æ¥æ­»äº¡é£é™©
        },
        description: "æš´é£é›ªè‚†è™ï¼Œæåº¦å±é™©ï¼Œå¿…é¡»ç«‹å³å¯»æ‰¾é¿éš¾æ‰€"
    },
    thunderstorm: {
        id: "thunderstorm",
        name: "é›·æš´",
        icon: "â›ˆï¸",
        temperature: 10,
        windSpeed: 5,
        visibility: "poor",
        moveCost: 1.8,
        staminaDrain: 1.5,
        waterDrain: 0.9,
        foodDrain: 1.2,
        moodEffect: -15,
        bodyTempEffect: -0.5,
        wetnessChange: 30,
        eventModifiers: {
            hypothermia: 0.1,
            getLost: 0.2,
            fall: 0.2,
            lightning: 0.03,       // é›·å‡»é£é™©
            panic: 0.15
        },
        description: "ç”µé—ªé›·é¸£ï¼Œå±±è„Šæåº¦å±é™©"
    }
};

// å¤©æ°”è¿é”ååº”é“¾
const WEATHER_CHAINS = {
    sunny: {
        duration: { min: 2, max: 6 },  // æŒç»­å°æ—¶æ•°
        nextWeather: { cloudy: 0.4, sunny: 0.3, lightRain: 0.2, fog: 0.1 }
    },
    cloudy: {
        duration: { min: 2, max: 5 },
        nextWeather: { sunny: 0.3, cloudy: 0.25, lightRain: 0.3, fog: 0.15 }
    },
    lightRain: {
        duration: { min: 1, max: 4 },
        nextWeather: { cloudy: 0.3, lightRain: 0.2, heavyRain: 0.3, fog: 0.2 }
    },
    heavyRain: {
        duration: { min: 1, max: 3 },
        nextWeather: { lightRain: 0.4, heavyRain: 0.2, fog: 0.3, thunderstorm: 0.1 }
    },
    fog: {
        duration: { min: 2, max: 8 },
        nextWeather: { cloudy: 0.3, fog: 0.3, lightRain: 0.2, sunny: 0.2 }
    },
    snow: {
        duration: { min: 2, max: 6 },
        nextWeather: { snow: 0.3, cloudy: 0.2, snowstorm: 0.3, fog: 0.2 }
    },
    snowstorm: {
        duration: { min: 3, max: 12 },
        nextWeather: { snow: 0.4, snowstorm: 0.3, cloudy: 0.3 }
    },
    thunderstorm: {
        duration: { min: 1, max: 3 },
        nextWeather: { heavyRain: 0.5, lightRain: 0.3, cloudy: 0.2 }
    }
};

// ==================== åœ°å½¢ç³»ç»Ÿ ====================

const TERRAIN_TYPES = {
    grassland: {
        id: "grassland",
        name: "è‰ç”¸",
        icon: "ğŸŒ¿",
        moveSpeed: 1.0,
        danger: 1,
        staminaCost: 1.0,
        description: "å¹³å¦çš„è‰ç”¸ï¼Œè¡Œèµ°èˆ’é€‚",
        risks: {},
        modifiers: {}
    },
    rocky: {
        id: "rocky",
        name: "ç¢çŸ³å¡",
        icon: "ğŸª¨",
        moveSpeed: 0.7,
        danger: 2,
        staminaCost: 1.3,
        description: "ç¢çŸ³éå¸ƒï¼Œå®¹æ˜“æ‰­ä¼¤",
        risks: {
            ankleSprain: 0.1,      // æ‰­ä¼¤æ¦‚ç‡
            fall: 0.05,
            equipmentDamage: 0.03
        },
        modifiers: {
            staminaDrain: 1.2,
            moodEffect: -2
        }
    },
    cliff: {
        id: "cliff",
        name: "é™¡å³­å²©å£",
        icon: "ğŸ§—",
        moveSpeed: 0.4,
        danger: 4,
        staminaCost: 1.8,
        description: "éœ€è¦æ”€çˆ¬ï¼Œæåº¦å±é™©",
        risks: {
            fall: 0.15,            // é«˜å æ¦‚ç‡
            injury: 0.1,
            equipmentDamage: 0.05,
            panic: 0.08
        },
        modifiers: {
            staminaDrain: 1.5,
            moodEffect: -8,
            sanityEffect: -5
        }
    },
    ridge: {
        id: "ridge",
        name: "å±±è„Š",
        icon: "ğŸ”ï¸",
        moveSpeed: 0.6,
        danger: 3,
        staminaCost: 1.5,
        description: "é£å¤§å¯’å†·ï¼Œæš´éœ²æ„Ÿå¼º",
        risks: {
            fall: 0.08,
            blownAway: 0.05,       // è¢«é£å¹å€’
            hypothermia: 0.1
        },
        modifiers: {
            staminaDrain: 1.3,
            bodyTempEffect: -1.0,  // ä½“æ¸©ä¸‹é™å¿«
            windEffect: 2,         // é£é€Ÿ+2çº§
            moodEffect: -5,
            sanityEffect: -3
        }
    },
    forest: {
        id: "forest",
        name: "çŒæœ¨ä¸›",
        icon: "ğŸŒ²",
        moveSpeed: 0.8,
        danger: 2,
        staminaCost: 1.2,
        description: "çŒæœ¨ä¸›ç”Ÿï¼Œéœ€è¦å¼€è·¯",
        risks: {
            wildAnimal: 0.08,      // é‡ç”ŸåŠ¨ç‰©
            getLost: 0.05,
            scratched: 0.1         // åˆ’ä¼¤
        },
        modifiers: {
            staminaDrain: 1.1,
            windEffect: -1,        // é¿é£
            moodEffect: 2
        }
    },
    snowfield: {
        id: "snowfield",
        name: "ç§¯é›ªåŒº",
        icon: "â„ï¸",
        moveSpeed: 0.5,
        danger: 3,
        staminaCost: 1.6,
        description: "æ·±é›ªéš¾è¡Œï¼Œå®¹æ˜“é™·è½",
        risks: {
            fall: 0.1,
            frostbite: 0.15,
            hypothermia: 0.2,
            avalanche: 0.02        // é›ªå´©
        },
        modifiers: {
            staminaDrain: 1.4,
            bodyTempEffect: -1.5,
            moodEffect: -10,
            wetnessChange: 15
        }
    },
    scree: {
        id: "scree",
        name: "æµçŸ³æ»©",
        icon: "â›°ï¸",
        moveSpeed: 0.5,
        danger: 3,
        staminaCost: 1.7,
        description: "ç¢çŸ³æµåŠ¨ï¼Œææ˜“æ»‘å ",
        risks: {
            fall: 0.2,
            ankleSprain: 0.15,
            equipmentDamage: 0.08
        },
        modifiers: {
            staminaDrain: 1.6,
            moodEffect: -10,
            sanityEffect: -5
        }
    },
    river: {
        id: "river",
        name: "æ¶‰æ°´è·¯æ®µ",
        icon: "ğŸ’§",
        moveSpeed: 0.6,
        danger: 2,
        staminaCost: 1.4,
        description: "éœ€è¦æ¶‰æ°´è¿‡æ²³",
        risks: {
            fall: 0.1,
            wetness: 0.5,          // é«˜æ¦‚ç‡æ¹¿èº«
            hypothermia: 0.1
        },
        modifiers: {
            staminaDrain: 1.3,
            wetnessChange: 30,
            bodyTempEffect: -1.0
        }
    }
};

// ==================== åœ°å›¾èŠ‚ç‚¹å®šä¹‰ ====================

const MAP_NODES = [
    { 
        id: 0, 
        name: "å¡˜å£æ‘", 
        type: "start", 
        desc: "å¾’æ­¥èµ·ç‚¹ï¼Œæœ€åçš„è¡¥ç»™ç«™", 
        elevation: 1700,
        terrain: "grassland"
    },
    { 
        id: 1, 
        name: "ç«çƒ§å¡", 
        type: "normal", 
        desc: "é™¡å³­çš„å±±å¡ï¼Œè§†é‡å¼€é˜”", 
        elevation: 2400,
        terrain: "scree"
    },
    { 
        id: 2, 
        name: "2900è¥åœ°", 
        type: "camp", 
        desc: "ç†æƒ³çš„éœ²è¥åœ°ç‚¹ï¼Œæœ‰æ°´æº", 
        elevation: 2900,
        terrain: "grassland"
    },
    { 
        id: 3, 
        name: "é³Œå±±å¤§æ¢", 
        type: "danger", 
        desc: "å±±è„Šè¡Œèµ°ï¼Œé£å¤§å±é™©", 
        elevation: 3400,
        terrain: "ridge"
    },
    { 
        id: 4, 
        name: "å¯¼èˆªæ¶", 
        type: "landmark", 
        desc: "æ ‡å¿—æ€§åœ°ç‚¹ï¼Œå®¹æ˜“è¿·è·¯", 
        elevation: 3475,
        terrain: "ridge"
    },
    { 
        id: 5, 
        name: "è¯ç‹åº™", 
        type: "camp", 
        desc: "åºŸå¼ƒåº™å®‡ï¼Œå¯é®é£é¿é›¨", 
        elevation: 3200,
        terrain: "grassland"
    },
    { 
        id: 6, 
        name: "éº¦ç§¸å²­", 
        type: "danger", 
        desc: "é™¡å³­å²©å£ï¼Œéœ€è¦æ”€çˆ¬", 
        elevation: 3500,
        terrain: "cliff"
    },
    { 
        id: 7, 
        name: "æ°´çªå­è¥åœ°", 
        type: "camp", 
        desc: "ä¼˜è´¨è¥åœ°ï¼Œæ°´æºå……è¶³", 
        elevation: 3100,
        terrain: "grassland"
    },
    { 
        id: 8, 
        name: "å¤ªç™½å±±æ™¯åŒº", 
        type: "end", 
        desc: "ç»ˆç‚¹ï¼ä½ æˆåŠŸç©¿è¶Šäº†é³Œå¤ªçº¿ï¼", 
        elevation: 2800,
        terrain: "forest"
    }
];

// èŠ‚ç‚¹é—´è¿æ¥å…³ç³»
const ROUTES = [
    { from: 0, to: 1, distance: 8, difficulty: "normal", desc: "å¸¸è§„å±±è·¯ä¸Šå¡", terrain: "scree", altitudeChange: 700 },
    { from: 1, to: 2, distance: 6, difficulty: "easy", desc: "ç©¿è¶ŠçŒæœ¨ä¸›", terrain: "forest", altitudeChange: 500 },
    { from: 2, to: 3, distance: 10, difficulty: "hard", desc: "æ”€ç™»é³Œå±±", terrain: "ridge", altitudeChange: 500 },
    { from: 3, to: 4, distance: 5, difficulty: "hard", desc: "å±±è„Šæ¨ªåˆ‡", terrain: "ridge", altitudeChange: 75 },
    { from: 4, to: 5, distance: 8, difficulty: "normal", desc: "ä¸‹å¡è·¯æ®µ", terrain: "rocky", altitudeChange: -275 },
    { from: 5, to: 6, distance: 7, difficulty: "hard", desc: "ç¿»è¶Šéº¦ç§¸å²­", terrain: "cliff", altitudeChange: 300 },
    { from: 6, to: 7, distance: 9, difficulty: "normal", desc: "é•¿è·ç¦»ä¸‹å¡", terrain: "snowfield", altitudeChange: -400 },
    { from: 7, to: 8, distance: 6, difficulty: "easy", desc: "æ™¯åŒºæ­¥é“", terrain: "forest", altitudeChange: -300 }
];

// ==================== çŠ¶æ€æ•ˆæœç³»ç»Ÿ ====================

const STATUS_EFFECTS = {
    heatStroke: {
        id: "heatStroke",
        name: "ä¸­æš‘",
        icon: "ğŸ¥µ",
        description: "ä½“æ¸©è¿‡é«˜ï¼Œå¤´æ™•æ¶å¿ƒ",
        effects: {
            staminaRegen: -0.8,      // ä½“åŠ›æ¢å¤é™ä½
            staminaDrain: 1.3,       // ä½“åŠ›æ¶ˆè€—å¢åŠ 
            judgment: -25,           // åˆ¤æ–­åŠ›ä¸‹é™
            moveSpeed: 0.7,          // ç§»åŠ¨é€Ÿåº¦é™ä½
            moodEffect: -10
        },
        duration: 3600,              // æŒç»­æ—¶é—´(ç§’)
        cure: ["rest", "water", "shade"],
        fatal: false,
        chainEvents: ["decisionMistake", "stumble"]
    },
    hypothermia: {
        id: "hypothermia",
        name: "å¤±æ¸©",
        icon: "ğŸ¥¶",
        description: "ä½“æ¸©è¿‡ä½ï¼Œæ„è¯†æ¨¡ç³Š",
        effects: {
            staminaRegen: -1.0,
            staminaDrain: 1.5,
            judgment: -35,
            moveSpeed: 0.5,
            moodEffect: -15,
            sanityEffect: -10
        },
        duration: -1,                // -1è¡¨ç¤ºéœ€è¦ä¸»åŠ¨æ²»ç–—
        cure: ["warmth", "rest", "dry"],
        fatal: true,                 // å¯èƒ½è‡´å‘½
        chainEvents: ["panic", "decisionMistake", "collapse"]
    },
    altitudeSickness: {
        id: "altitudeSickness",
        name: "é«˜åŸååº”",
        icon: "ğŸ¤¢",
        description: "å¤´ç—›æ¶å¿ƒï¼Œå‘¼å¸å›°éš¾",
        effects: {
            staminaRegen: -0.5,
            staminaDrain: 1.2,
            moveSpeed: 0.75,
            judgment: -15,
            moodEffect: -8
        },
        duration: -1,
        cure: ["descent", "rest", "oxygen"],
        fatal: false,
        chainEvents: ["nausea", "weakness"]
    },
    injured: {
        id: "injured",
        name: "å—ä¼¤",
        icon: "ğŸ¤•",
        description: "èº«ä½“å—ä¼¤ï¼Œè¡ŒåŠ¨ä¸ä¾¿",
        effects: {
            moveSpeed: 0.6,
            maxStamina: 70,
            staminaDrain: 1.2,
            moodEffect: -10
        },
        duration: 86400,             // 24å°æ—¶
        cure: ["medicine", "rest"],
        fatal: false,
        chainEvents: ["slowProgress", "missCamp"]
    },
    panic: {
        id: "panic",
        name: "ææ…Œ",
        icon: "ğŸ˜°",
        description: "å¿ƒç¥ä¸å®ï¼Œåˆ¤æ–­åŠ›ä¸‹é™",
        effects: {
            judgment: -45,
            eventSuccessRate: 0.6,
            sanityEffect: -15,
            moodEffect: -20,
            staminaDrain: 1.3
        },
        duration: 1800,              // 30åˆ†é’Ÿ
        cure: ["rest", "calm", "company"],
        fatal: false,
        chainEvents: ["rashDecision", "getLost"]
    },
    dehydration: {
        id: "dehydration",
        name: "è„±æ°´",
        icon: "ğŸ’§",
        description: "ä¸¥é‡ç¼ºæ°´ï¼Œå£å¹²èˆŒç‡¥",
        effects: {
            staminaRegen: -0.6,
            staminaDrain: 1.2,
            judgment: -20,
            moodEffect: -12
        },
        duration: 7200,
        cure: ["water", "rest"],
        fatal: true,
        chainEvents: ["weakness", "heatStroke"]
    },
    frostbite: {
        id: "frostbite",
        name: "å†»ä¼¤",
        icon: "â„ï¸",
        description: "è‚¢ä½“å†»ä¼¤ï¼ŒçŸ¥è§‰ä¸§å¤±",
        effects: {
            moveSpeed: 0.5,
            maxStamina: 60,
            staminaDrain: 1.3,
            moodEffect: -15
        },
        duration: 172800,            // 48å°æ—¶
        cure: ["warmth", "medicine", "rest"],
        fatal: false,
        chainEvents: ["gangrene"]     // åç–½
    },
    wet: {
        id: "wet",
        name: "æ¹¿èº«",
        icon: "ğŸ’¦",
        description: "è¡£ç‰©æ¹¿é€ï¼Œä½“æ¸©æµå¤±å¿«",
        effects: {
            bodyTempEffect: -1.5,
            staminaDrain: 1.1,
            moodEffect: -8
        },
        duration: -1,
        cure: ["dry", "warmth", "changeClothes"],
        fatal: false,
        chainEvents: ["hypothermia"]
    },
    exhausted: {
        id: "exhausted",
        name: "æåº¦ç–²åŠ³",
        icon: "ğŸ˜«",
        description: "ç²¾ç–²åŠ›ç«­ï¼Œéœ€è¦ä¼‘æ¯",
        effects: {
            staminaRegen: -0.3,
            moveSpeed: 0.6,
            judgment: -20,
            eventSuccessRate: 0.7,
            moodEffect: -10
        },
        duration: 3600,
        cure: ["rest", "food", "sleep"],
        fatal: false,
        chainEvents: ["fall", "decisionMistake"]
    },
    sunburn: {
        id: "sunburn",
        name: "æ™’ä¼¤",
        icon: "â˜€ï¸",
        description: "çš®è‚¤æ™’ä¼¤ï¼Œç–¼ç—›éš¾å¿",
        effects: {
            staminaDrain: 1.1,
            moodEffect: -5
        },
        duration: 21600,             // 6å°æ—¶
        cure: ["rest", "shade"],
        fatal: false,
        chainEvents: []
    },
    ankleSprain: {
        id: "ankleSprain",
        name: "è„šè¸æ‰­ä¼¤",
        icon: "ğŸ¦¶",
        description: "è„šè¸æ‰­ä¼¤ï¼Œè¡Œèµ°å›°éš¾",
        effects: {
            moveSpeed: 0.5,
            staminaDrain: 1.4,
            maxStamina: 75
        },
        duration: 43200,             // 12å°æ—¶
        cure: ["medicine", "rest", "bandage"],
        fatal: false,
        chainEvents: ["slowProgress"]
    }
};

// ==================== äº‹ä»¶ç³»ç»Ÿ ====================

// äº‹ä»¶è§¦å‘æ¡ä»¶çŸ©é˜µ
const EVENT_CONDITIONS = {
    heatStroke: {
        weather: ["sunny"],
        temperature: { min: 25 },
        terrain: "any",
        altitude: "any",
        time: "day",
        statusEffects: [],
        baseChance: 0.05
    },
    hypothermia: {
        weather: ["snow", "snowstorm", "heavyRain"],
        temperature: { max: 5 },
        terrain: "any",
        altitude: "any",
        time: "any",
        statusEffects: ["wet"],
        baseChance: 0.08
    },
    getLost: {
        weather: ["fog", "snowstorm"],
        temperature: "any",
        terrain: ["forest", "ridge"],
        altitude: { min: 2500 },
        time: "any",
        statusEffects: ["panic"],
        baseChance: 0.1
    },
    fall: {
        weather: "any",
        temperature: "any",
        terrain: ["cliff", "scree", "snowfield", "ridge"],
        altitude: "any",
        time: "any",
        statusEffects: ["exhausted", "panic"],
        baseChance: 0.05
    },
    altitudeSickness: {
        weather: "any",
        temperature: "any",
        terrain: "any",
        altitude: { min: 3000 },
        time: "any",
        statusEffects: [],
        baseChance: 0.06
    },
    wildAnimal: {
        weather: "any",
        temperature: "any",
        terrain: ["forest", "grassland"],
        altitude: "any",
        time: ["dusk", "night"],
        statusEffects: [],
        baseChance: 0.04
    },
    dehydration: {
        weather: ["sunny", "cloudy"],
        temperature: { min: 20 },
        terrain: "any",
        altitude: "any",
        time: "day",
        statusEffects: [],
        baseChance: 0.05
    },
    panic: {
        weather: ["fog", "snowstorm", "thunderstorm"],
        temperature: "any",
        terrain: "any",
        altitude: { min: 2800 },
        time: "night",
        statusEffects: ["getLost"],
        baseChance: 0.1
    },
    equipmentDamage: {
        weather: ["heavyRain", "snowstorm"],
        temperature: "any",
        terrain: ["rocky", "scree", "cliff"],
        altitude: "any",
        time: "any",
        statusEffects: [],
        baseChance: 0.06
    },
    landslide: {
        weather: ["heavyRain", "thunderstorm"],
        temperature: "any",
        terrain: ["scree", "cliff"],
        altitude: "any",
        time: "any",
        statusEffects: [],
        baseChance: 0.02
    }
};

// éšæœºäº‹ä»¶å®šä¹‰
const RANDOM_EVENTS = [
    {
        id: "find_water",
        title: "å‘ç°æ°´æº",
        icon: "ğŸ’§",
        description: "ä½ å‘ç°äº†ä¸€å¤„æ¸…æ¾ˆçš„å±±æ³‰ï¼",
        type: "good",
        choices: [
            { text: "å–æ°´è¡¥å…… (+30æ°´åˆ†, +5å¿ƒæƒ…)", effect: { water: 30, mood: 5 }, condition: null },
            { text: "è£…æ»¡æ°´å£¶ (+20æ°´åˆ†, -5ä½“åŠ›)", effect: { water: 20, stamina: -5 }, condition: "has_bottle" },
            { text: "ä¼‘æ¯ç‰‡åˆ» (+10ä½“åŠ›, +10å¿ƒæƒ…)", effect: { stamina: 10, mood: 10 }, condition: null }
        ]
    },
    {
        id: "wild_animal",
        title: "é‡ç”ŸåŠ¨ç‰©",
        icon: "ğŸ¦Œ",
        description: "ä½ é‡åˆ°äº†ä¸€åªç¾šç‰›ï¼Œå®ƒæ­£è­¦æƒ•åœ°çœ‹ç€ä½ ã€‚",
        type: "neutral",
        choices: [
            { text: "æ…¢æ…¢åé€€ (-10ä½“åŠ›, +5ç†æ™º)", effect: { stamina: -10, sanity: 5 }, condition: null },
            { text: "å¤§å£°é©±èµ¶ (-20ä½“åŠ›, -10å¿ƒæƒ…, å¯èƒ½æ¿€æ€’)", effect: { stamina: -20, mood: -10 }, risk: { angryAnimal: 0.3 }, condition: null },
            { text: "ç»•é“è€Œè¡Œ (-30ä½“åŠ›)", effect: { stamina: -30 }, condition: null }
        ]
    },
    {
        id: "other_hiker",
        title: "é‡åˆ°å¾’æ­¥è€…",
        icon: "ğŸ§—",
        description: "ä½ é‡åˆ°äº†å¦ä¸€ä½ç©¿è¶Šè€…ï¼Œä»–çœ‹èµ·æ¥ç»éªŒä¸°å¯Œã€‚",
        type: "good",
        choices: [
            { text: "äº¤æ¢æƒ…æŠ¥ (+10å¿ƒæƒ…, +5ç†æ™º)", effect: { mood: 10, sanity: 5 }, condition: null },
            { text: "åˆ†äº«é£Ÿç‰© (-10é£Ÿç‰©, +20å¿ƒæƒ…, åŠ©äººä¸ºä¹)", effect: { food: -10, mood: 20 }, condition: "has_food", isHelp: true },
            { text: "ç»“ä¼´åŒè¡Œ (+15ç†æ™º, ç§»åŠ¨æ¶ˆè€—-10%)", effect: { sanity: 15 }, buff: { moveCost: 0.9 }, condition: null }
        ]
    },
    {
        id: "equipment_damage",
        title: "è£…å¤‡æŸå",
        icon: "ğŸ”§",
        description: "ç³Ÿç³•ï¼ä½ çš„è£…å¤‡åœ¨è¡Œè¿›ä¸­å—æŸäº†ã€‚",
        type: "bad",
        choices: [
            { text: "å°è¯•ä¿®ç† (-20ä½“åŠ›, 50%æˆåŠŸ)", effect: { stamina: -20 }, successRate: 0.5, condition: null },
            { text: "æ”¾å¼ƒä½¿ç”¨ (-15å¿ƒæƒ…)", effect: { mood: -15 }, condition: null },
            { text: "å‡‘åˆç€ç”¨ (-15ä½“åŠ›, -10å¿ƒæƒ…, åç»­é£é™©+10%)", effect: { stamina: -15, mood: -10 }, debuff: { riskIncrease: 0.1 }, condition: null }
        ]
    },
    {
        id: "beautiful_view",
        title: "ç»ç¾é£æ™¯",
        icon: "ğŸ”ï¸",
        description: "çœ¼å‰çš„æ™¯è‰²è®©ä½ å±ä½äº†å‘¼å¸ï¼Œå¤ªç¾äº†ï¼",
        type: "scenery",
        choices: [
            { text: "æ‹ç…§ç•™å¿µ (+15å¿ƒæƒ…, +5ç†æ™º)", effect: { mood: 15, sanity: 5 }, condition: null },
            { text: "é™é™æ¬£èµ (+10å¿ƒæƒ…, -10ä½“åŠ›, +10ç†æ™º)", effect: { mood: 10, stamina: -10, sanity: 10 }, condition: null },
            { text: "ç»§ç»­å‰è¿›", effect: {}, condition: null }
        ]
    },
    {
        id: "slip_fall",
        title: "æ»‘å€’æ‘”ä¼¤",
        icon: "âš ï¸",
        description: "è·¯é¢æ¹¿æ»‘ï¼Œä½ ä¸æ…æ»‘å€’äº†ï¼",
        type: "bad",
        choices: [
            { text: "æ£€æŸ¥ä¼¤åŠ¿ (-25ä½“åŠ›, è·å¾—'å—ä¼¤'çŠ¶æ€)", effect: { stamina: -25 }, addStatus: "injured", condition: null },
            { text: "ç®€å•å¤„ç† (-15ä½“åŠ›, -5å¿ƒæƒ…, æœ‰è¯å“åˆ™é¿å…å—ä¼¤)", effect: { stamina: -15, mood: -5 }, preventStatus: "injured", condition: "has_medicine" },
            { text: "å¿ç—›å‰è¿› (-35ä½“åŠ›, ä¼¤åŠ¿æ¶åŒ–é£é™©)", effect: { stamina: -35 }, risk: { injuryWorsen: 0.4 }, condition: null }
        ]
    },
    {
        id: "find_shelter",
        title: "å‘ç°é¿é›¨å¤„",
        icon: "ğŸšï¸",
        description: "ä½ å‘ç°äº†ä¸€å¤„å¯ä»¥é¿é›¨çš„åœ°æ–¹ã€‚",
        type: "good",
        choices: [
            { text: "ä¼‘æ¯ç‰‡åˆ» (+25ä½“åŠ›, +15å¿ƒæƒ…, æ¹¿èº«-30%)", effect: { stamina: 25, mood: 15, wetness: -30 }, condition: null },
            { text: "ç”Ÿç«å–æš– (+35ä½“åŠ›, -5é£Ÿç‰©, ç§»é™¤æ¹¿èº«)", effect: { stamina: 35, food: -5 }, removeStatus: "wet", condition: null },
            { text: "ç»§ç»­å‰è¿›", effect: {}, condition: null }
        ]
    },
    {
        id: "lost_item",
        title: "é—å¤±ç‰©å“",
        icon: "ğŸ’",
        description: "ä½ å‘ç°åœ°ä¸Šæœ‰ä¸€ä¸ªé—å¤±çš„èƒŒåŒ…...",
        type: "neutral",
        choices: [
            { text: "æŸ¥çœ‹å¹¶å¸¦èµ° (+15é£Ÿç‰© æˆ– +15æ°´åˆ†)", effect: { food: 15 }, random: [{ food: 15 }, { water: 15 }], condition: null },
            { text: "ç•™åœ¨åŸåœ° (+5ç†æ™º, ç¯ä¿è¡Œä¸º)", effect: { sanity: 5 }, eco: true, condition: null }
        ]
    },
    {
        id: "stranded_hiker",
        title: "é‡é™©è€…",
        icon: "ğŸ†˜",
        description: "ä½ å‘ç°ä¸€åå—ä¼¤çš„å¾’æ­¥è€…ï¼Œä»–è¯·æ±‚å¸®åŠ©ã€‚",
        type: "moral",
        choices: [
            { text: "å…¨åŠ›æ•‘åŠ© (-40ä½“åŠ›, -20é£Ÿç‰©, +50ç†æ™º, é“å¾·åŠ åˆ†)", effect: { stamina: -40, food: -20, sanity: 50 }, moral: "good", condition: null },
            { text: "åˆ†äº«ç‰©èµ„ (-15é£Ÿç‰©, +20ç†æ™º)", effect: { food: -15, sanity: 20 }, moral: "neutral", condition: null },
            { text: "æ— èƒ½ä¸ºåŠ› (-20ç†æ™º)", effect: { sanity: -20 }, moral: "bad", condition: null }
        ]
    },
    {
        id: "weather_change",
        title: "å¤©æ°”çªå˜",
        icon: "ğŸŒªï¸",
        description: "å¤©ç©ºçªç„¶å˜æš—ï¼Œå¤©æ°”å³å°†æ¶åŒ–ï¼",
        type: "bad",
        choices: [
            { text: "ç«‹å³å¯»æ‰¾é¿éš¾æ‰€ (-10ä½“åŠ›, å®‰å…¨)", effect: { stamina: -10 }, safe: true, condition: null },
            { text: "åŠ å¿«é€Ÿåº¦ (-25ä½“åŠ›, 20%é­é‡å±é™©)", effect: { stamina: -25 }, risk: { danger: 0.2 }, condition: null },
            { text: "åŸåœ°ç­‰å¾… (-5ä½“åŠ›, å¤©æ°”æ¶åŒ–)", effect: { stamina: -5 }, weatherWorsen: true, condition: null }
        ]
    }
];

// ==================== è£…å¤‡å®šä¹‰ ====================

const EQUIPMENT = {
    backpacks: [
        { id: "basic_bag", name: "åŸºç¡€èƒŒåŒ…", weight: 1, capacity: 15, cost: 10, desc: "è½»ä¾¿ä½†å®¹é‡å°", warmth: 0, durability: 100 },
        { id: "hiking_bag", name: "ç™»å±±åŒ…", weight: 2, capacity: 25, cost: 25, desc: "å¹³è¡¡çš„é€‰æ‹©", warmth: 0, durability: 100, effect: "reduce_weight_penalty", value: 0.1 },
        { id: "heavy_bag", name: "é‡è£…èƒŒåŒ…", weight: 4, capacity: 35, cost: 40, desc: "å¤§å®¹é‡å¯æºå¸¦å¸ç¯·", warmth: 0, durability: 100, effect: "reduce_weight_penalty", value: 0.2, canCarryTent: true }
    ],
    clothing: [
        { id: "quick_dry", name: "é€Ÿå¹²è¡£", weight: 0.5, warmth: 1, waterproof: 0, cost: 15, desc: "é›¨å¤©ä½“åŠ›æ¶ˆè€—-10%,æ¹¿èº«æ¢å¤+20%", durability: 100, effects: ["rain_stamina_reduce", "wet_recovery_boost"] },
        { id: "jacket", name: "å†²é”‹è¡£", weight: 1, warmth: 3, waterproof: 2, cost: 30, desc: "é˜²é£é˜²é›¨ä¿æš–", durability: 100, effects: ["wind_resist", "rain_resist", "warmth_keep"] },
        { id: "down_jacket", name: "ç¾½ç»’æœ", weight: 1.5, warmth: 5, waterproof: 1, cost: 35, desc: "é«˜æµ·æ‹”/æš´é£é›ªä¸“ç”¨", durability: 100, effects: ["altitude_stamina", "warmth_keep", "snowstorm_immunity"] },
        { id: "rain_gear", name: "é›¨è¡£", weight: 0.8, warmth: 1, waterproof: 3, cost: 20, desc: "é˜²é›¨ä¸“ç”¨", durability: 100 }
    ],
    tools: [
        { id: "trekking_poles", name: "ç™»å±±æ–", weight: 0.5, effect: "reduce_stamina_cost", value: 0.2, cost: 15, desc: "ç§»åŠ¨ä½“åŠ›-20%,æ»‘å€’æ¦‚ç‡-50%", durability: 100, effects: ["reduce_move_stamina", "prevent_slip"] },
        { id: "headlamp", name: "å¤´ç¯", weight: 0.3, effect: "night_move", cost: 10, desc: "å¤œé—´ç§»åŠ¨æ— é¢å¤–æ¶ˆè€—,å¤§é›¾è§†é‡+1", durability: 100, effects: ["night_move_free", "fog_vision", "dark_event"] },
        { id: "compass", name: "æŒ‡å—é’ˆ", weight: 0.2, effect: "prevent_lost", value: 0.5, cost: 10, desc: "é˜²æ­¢è¿·è·¯,æ˜¾ç¤ºæ­£ç¡®é€‰é¡¹,å¯¼èˆªæ¶é™„è¿‘æ•ˆæœå¢å¼º", durability: 100, effects: ["prevent_lost_fog", "show_correct_choice", "landmark_boost"] },
        { id: "gps", name: "GPSå®šä½å™¨", weight: 0.4, effect: "prevent_lost", value: 0.8, cost: 25, desc: "ç²¾ç¡®å®šä½,è¿·è·¯è‡ªåŠ¨æ¢å¤,ç´§æ€¥æ±‚æ•‘", durability: 100, effects: ["precise_location", "auto_recover_lost", "emergency_rescue"] },
        { id: "first_aid", name: "æ€¥æ•‘åŒ…", weight: 0.6, effect: "heal", value: 30, cost: 20, desc: "æ²»ç–—ä¼¤åŠ¿", durability: 100 },
        { id: "rope", name: "ç™»å±±ç»³", weight: 1, effect: "climb_safety", value: 0.3, cost: 18, desc: "é™ä½æ”€çˆ¬é£é™©", durability: 100 }
    ],
    food: [
        { id: "biscuits", name: "å‹ç¼©é¥¼å¹²", weight: 0.5, foodValue: 30, waterCost: -5, cost: 5, desc: "è½»ä¾¿è€é¥¿" },
        { id: "energy_bar", name: "èƒ½é‡æ£’", weight: 0.3, foodValue: 20, waterCost: 0, cost: 8, desc: "å¿«é€Ÿè¡¥å……" },
        { id: "self_heating", name: "è‡ªçƒ­ç±³é¥­", weight: 1, foodValue: 50, waterCost: -10, cost: 15, desc: "çƒ­é£Ÿæ¢å¤" },
        { id: "chocolate", name: "å·§å…‹åŠ›", weight: 0.2, foodValue: 15, moodValue: 10, cost: 8, desc: "æå‡å¿ƒæƒ…" }
    ],
    water: [
        { id: "water_bottle", name: "æ°´å£¶", weight: 0.3, capacity: 20, cost: 8, desc: "å‚¨æ°´å·¥å…·" },
        { id: "water_bladder", name: "æ°´è¢‹", weight: 0.5, capacity: 35, cost: 15, desc: "å¤§å®¹é‡å‚¨æ°´" },
        { id: "purifier", name: "å‡€æ°´ç‰‡", weight: 0.1, uses: 5, cost: 12, desc: "å‡€åŒ–æ°´æº" }
    ]
};

// ==================== è£…å¤‡æ•ˆæœç³»ç»Ÿ ====================

const EQUIPMENT_EFFECTS = {
    // é€Ÿå¹²è¡£æ•ˆæœ
    quick_dry: {
        // é›¨å¤©ä½“åŠ›æ¶ˆè€—å‡å°‘10%
        onStaminaCost: (baseCost, weather, equipment) => {
            if (weather.id === "light_rain" || weather.id === "heavy_rain") {
                return baseCost * 0.9;
            }
            return baseCost;
        },
        // æ¹¿èº«åæ¢å¤é€Ÿåº¦+20%
        onWetnessRecovery: (recoveryAmount, equipment) => {
            return recoveryAmount * 1.2;
        }
    },
    // å†²é”‹è¡£æ•ˆæœ
    jacket: {
        // é˜²é£ï¼šå¤§é£å¤©æ°”ä½“åŠ›æ¶ˆè€—-15%
        onStaminaCost: (baseCost, weather, equipment) => {
            if (weather.windSpeed >= 4) {
                return baseCost * 0.85;
            }
            return baseCost;
        },
        // é˜²é›¨ï¼šé›¨å¤©æ•ˆæœå‡åŠ
        onWeatherEffect: (effect, weather, equipment) => {
            if (weather.id === "light_rain" || weather.id === "heavy_rain") {
                return effect * 0.5;
            }
            return effect;
        },
        // ä¿æš–ï¼šä½“æ¸©ä¸‹é™é€Ÿåº¦-20%
        onBodyTempChange: (tempChange, equipment) => {
            if (tempChange < 0) {
                return tempChange * 0.8;
            }
            return tempChange;
        }
    },
    // ç¾½ç»’æœæ•ˆæœ
    down_jacket: {
        // é«˜æµ·æ‹”ï¼ˆ>3000mï¼‰ä½“åŠ›æ¶ˆè€—-15%
        onStaminaCost: (baseCost, weather, altitude, equipment) => {
            if (altitude > 3000) {
                return baseCost * 0.85;
            }
            return baseCost;
        },
        // ä½“æ¸©ä¸‹é™é€Ÿåº¦-30%
        onBodyTempChange: (tempChange, equipment) => {
            if (tempChange < 0) {
                return tempChange * 0.7;
            }
            return tempChange;
        },
        // æš´é£é›ªå¤©æ°”å¯æ­£å¸¸è¡ŒåŠ¨ï¼ˆç§»é™¤äº†æš´é£é›ªç§»åŠ¨é™åˆ¶ï¼‰
        canMoveInSnowstorm: (equipment) => true
    },
    // ç™»å±±æ–æ•ˆæœ
    trekking_poles: {
        // ç§»åŠ¨ä½“åŠ›æ¶ˆè€—-20%ï¼ˆå·²å®ç°ï¼‰
        onMoveStamina: (baseCost, equipment) => {
            return baseCost * 0.8;
        },
        // æ»‘å€’äº‹ä»¶æ¦‚ç‡-50%
        onSlipChance: (baseChance, equipment) => {
            return baseChance * 0.5;
        }
    },
    // å¤´ç¯æ•ˆæœ
    headlamp: {
        // å¤œé—´ç§»åŠ¨ä¸å¢åŠ é¢å¤–æ¶ˆè€—
        onNightMoveCost: (extraCost, equipment) => {
            return 0;
        },
        // å¤§é›¾å¤©æ°”è§†é‡+1çº§
        onVisibility: (visibility, weather, equipment) => {
            if (weather.id === "fog") {
                const levels = ["none", "poor", "normal", "good"];
                const currentIndex = levels.indexOf(visibility);
                return levels[Math.min(currentIndex + 1, levels.length - 1)];
            }
            return visibility;
        },
        // æ´ç©´/æš—å¤„äº‹ä»¶å¯æ­£å¸¸å¤„ç†
        canHandleDarkEvent: (equipment) => true
    },
    // æŒ‡å—é’ˆæ•ˆæœ
    compass: {
        // é˜²æ­¢è¿·è·¯ï¼ˆå¤§é›¾å¤©æ°”ï¼‰
        onGetLostChance: (baseChance, weather, equipment) => {
            if (weather.id === "fog") {
                return 0;
            }
            return baseChance * 0.5;
        },
        // è¿·è·¯äº‹ä»¶å¯æ˜¾ç¤ºæ­£ç¡®é€‰é¡¹
        showCorrectChoiceInLostEvent: (equipment) => true,
        // å¯¼èˆªæ¶é™„è¿‘æ•ˆæœå¢å¼º
        nearLandmarkBoost: (node, equipment) => {
            if (node.name === "å¯¼èˆªæ¶") {
                return 1.5; // æ•ˆæœå¢å¼º50%
            }
            return 1;
        }
    },
    // GPSå®šä½å™¨æ•ˆæœ
    gps: {
        // éšæ—¶æŸ¥çœ‹ç²¾ç¡®ä½ç½®
        getPreciseLocation: (equipment) => true,
        // è¿·è·¯æ—¶è‡ªåŠ¨æ¢å¤
        autoRecoverFromLost: (equipment) => {
            return Math.random() < 0.8;
        },
        // ç´§æ€¥æ±‚æ•‘åŠŸèƒ½ï¼ˆä¸€æ¬¡æ€§ï¼‰
        emergencyRescue: (equipment) => {
            if (!equipment.rescueUsed) {
                equipment.rescueUsed = true;
                return true;
            }
            return false;
        }
    },
    // ç™»å±±åŒ…æ•ˆæœ
    hiking_bag: {
        // è´Ÿé‡å¯¹ä½“åŠ›å½±å“-10%
        onWeightPenalty: (penalty, equipment) => {
            return penalty * 0.9;
        }
    },
    // é‡è£…èƒŒåŒ…æ•ˆæœ
    heavy_bag: {
        // è´Ÿé‡å¯¹ä½“åŠ›å½±å“-20%
        onWeightPenalty: (penalty, equipment) => {
            return penalty * 0.8;
        },
        // å¯æºå¸¦å¸ç¯·ï¼ˆè§£é”éœ²è¥é€‰é¡¹ï¼‰
        canCarryTent: (equipment) => true
    }
};

// è£…å¤‡è€ä¹…åº¦ç³»ç»Ÿ
const EQUIPMENT_DURABILITY = {
    // ä½¿ç”¨è£…å¤‡æ¶ˆè€—è€ä¹…
    useEquipment: (equipment, amount = 1) => {
        if (!equipment.durability) return true;
        equipment.durability = Math.max(0, equipment.durability - amount);
        return equipment.durability > 0;
    },
    
    // æ£€æŸ¥è£…å¤‡æ˜¯å¦æœ‰æ•ˆï¼ˆè€ä¹…>0ï¼‰
    isEquipmentValid: (equipment) => {
        if (!equipment.durability) return true;
        return equipment.durability > 0;
    },
    
    // è·å–è£…å¤‡æ•ˆæœå€ç‡ï¼ˆè€ä¹…<30%æ•ˆæœå‡åŠï¼‰
    getEffectMultiplier: (equipment) => {
        if (!equipment.durability) return 1;
        if (equipment.durability <= 0) return 0;
        if (equipment.durability < 30) return 0.5;
        return 1;
    },
    
    // ä¿®å¤è£…å¤‡
    repairEquipment: (equipment, amount = 30) => {
        if (!equipment.durability) return;
        equipment.durability = Math.min(100, equipment.durability + amount);
    },
    
    // è·å–è€ä¹…çŠ¶æ€æè¿°
    getDurabilityStatus: (equipment) => {
        if (!equipment.durability) return { text: "", class: "" };
        if (equipment.durability <= 0) return { text: "å·²æŸå", class: "broken" };
        if (equipment.durability < 30) return { text: "ä¸¥é‡ç£¨æŸ", class: "critical" };
        if (equipment.durability < 60) return { text: "è½»å¾®ç£¨æŸ", class: "warning" };
        return { text: "çŠ¶æ€è‰¯å¥½", class: "good" };
    }
};

// è£…å¤‡æ•ˆæœåº”ç”¨å‡½æ•°
const EquipmentSystem = {
    // æ£€æŸ¥æ˜¯å¦æœ‰æŸä»¶è£…å¤‡
    hasEquipment: (equipmentId) => {
        return gameState.equipment.some(e => e.id === equipmentId && EQUIPMENT_DURABILITY.isEquipmentValid(e));
    },
    
    // è·å–è£…å¤‡å®ä¾‹
    getEquipment: (equipmentId) => {
        return gameState.equipment.find(e => e.id === equipmentId && EQUIPMENT_DURABILITY.isEquipmentValid(e));
    },
    
    // åº”ç”¨ç§»åŠ¨ä½“åŠ›æ¶ˆè€—æ•ˆæœ
    applyMoveStaminaEffects: (baseCost, weather, terrain, altitude) => {
        let finalCost = baseCost;
        let multiplier = 1;
        
        // ç™»å±±æ–æ•ˆæœ
        const poles = EquipmentSystem.getEquipment("trekking_poles");
        if (poles) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(poles);
            finalCost *= (1 - 0.2 * m);
            // æ¶ˆè€—è€ä¹…
            EQUIPMENT_DURABILITY.useEquipment(poles, 0.5);
        }
        
        // é€Ÿå¹²è¡£é›¨å¤©æ•ˆæœ
        const quickDry = EquipmentSystem.getEquipment("quick_dry");
        if (quickDry && (weather.id === "light_rain" || weather.id === "heavy_rain")) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(quickDry);
            finalCost *= (1 - 0.1 * m);
        }
        
        // å†²é”‹è¡£é˜²é£æ•ˆæœ
        const jacket = EquipmentSystem.getEquipment("jacket");
        if (jacket && weather.windSpeed >= 4) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(jacket);
            finalCost *= (1 - 0.15 * m);
        }
        
        // ç¾½ç»’æœé«˜æµ·æ‹”æ•ˆæœ
        const downJacket = EquipmentSystem.getEquipment("down_jacket");
        if (downJacket && altitude > 3000) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(downJacket);
            finalCost *= (1 - 0.15 * m);
        }
        
        // èƒŒåŒ…è´Ÿé‡æ•ˆæœ
        const backpack = gameState.equipment.find(e => 
            EQUIPMENT.backpacks.some(b => b.id === e.id)
        );
        if (backpack) {
            const weightRatio = gameState.totalWeight / gameState.maxCapacity;
            let weightPenalty = 1 + (weightRatio * 0.5); // è´Ÿé‡è¶Šé«˜æƒ©ç½šè¶Šå¤§
            
            // ç™»å±±åŒ…/é‡è£…èƒŒåŒ…å‡è½»è´Ÿé‡å½±å“
            const hikingBag = EquipmentSystem.getEquipment("hiking_bag");
            const heavyBag = EquipmentSystem.getEquipment("heavy_bag");
            if (heavyBag) {
                const m = EQUIPMENT_DURABILITY.getEffectMultiplier(heavyBag);
                weightPenalty = 1 + (weightRatio * 0.5 * 0.8 * m);
                EQUIPMENT_DURABILITY.useEquipment(heavyBag, 0.3);
            } else if (hikingBag) {
                const m = EQUIPMENT_DURABILITY.getEffectMultiplier(hikingBag);
                weightPenalty = 1 + (weightRatio * 0.5 * 0.9 * m);
                EQUIPMENT_DURABILITY.useEquipment(hikingBag, 0.3);
            }
            
            finalCost *= weightPenalty;
        }
        
        return Math.floor(finalCost);
    },
    
    // åº”ç”¨ä½“æ¸©å˜åŒ–æ•ˆæœ
    applyBodyTempEffects: (tempChange) => {
        let finalChange = tempChange;
        
        // å†²é”‹è¡£ä¿æš–
        const jacket = EquipmentSystem.getEquipment("jacket");
        if (jacket && tempChange < 0) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(jacket);
            finalChange *= (1 - 0.2 * m);
        }
        
        // ç¾½ç»’æœä¿æš–ï¼ˆæ›´å¼ºï¼‰
        const downJacket = EquipmentSystem.getEquipment("down_jacket");
        if (downJacket && tempChange < 0) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(downJacket);
            finalChange *= (1 - 0.3 * m);
        }
        
        return finalChange;
    },
    
    // åº”ç”¨æ¹¿èº«æ¢å¤æ•ˆæœ
    applyWetnessRecovery: (recoveryAmount) => {
        let finalRecovery = recoveryAmount;
        
        // é€Ÿå¹²è¡£åŠ é€Ÿæ¢å¤
        const quickDry = EquipmentSystem.getEquipment("quick_dry");
        if (quickDry) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(quickDry);
            finalRecovery *= (1 + 0.2 * m);
        }
        
        return finalRecovery;
    },
    
    // åº”ç”¨è¿·è·¯æ¦‚ç‡æ•ˆæœ
    applyGetLostChance: (baseChance) => {
        let finalChance = baseChance;
        
        // æŒ‡å—é’ˆæ•ˆæœ
        const compass = EquipmentSystem.getEquipment("compass");
        if (compass) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(compass);
            // å¤§é›¾å¤©æ°”å®Œå…¨é˜²æ­¢è¿·è·¯
            if (gameState.weather.id === "fog") {
                finalChance = 0;
            } else {
                finalChance *= (1 - 0.5 * m);
            }
            EQUIPMENT_DURABILITY.useEquipment(compass, 0.2);
        }
        
        // GPSæ•ˆæœï¼ˆæ›´å¼ºï¼‰
        const gps = EquipmentSystem.getEquipment("gps");
        if (gps) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(gps);
            finalChance *= (1 - 0.8 * m);
            EQUIPMENT_DURABILITY.useEquipment(gps, 0.2);
        }
        
        return finalChance;
    },
    
    // åº”ç”¨æ»‘å€’æ¦‚ç‡æ•ˆæœ
    applySlipChance: (baseChance) => {
        let finalChance = baseChance;
        
        // ç™»å±±æ–æ•ˆæœ
        const poles = EquipmentSystem.getEquipment("trekking_poles");
        if (poles) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(poles);
            finalChance *= (1 - 0.5 * m);
        }
        
        return finalChance;
    },
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥åœ¨æš´é£é›ªä¸­æ­£å¸¸è¡ŒåŠ¨
    canMoveInSnowstorm: () => {
        const downJacket = EquipmentSystem.getEquipment("down_jacket");
        if (downJacket) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(downJacket);
            return m > 0;
        }
        return false;
    },
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å¤œé—´ç§»åŠ¨æƒ©ç½š
    hasNightMovePenalty: () => {
        const headlamp = EquipmentSystem.getEquipment("headlamp");
        if (headlamp) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(headlamp);
            if (m > 0) {
                EQUIPMENT_DURABILITY.useEquipment(headlamp, 0.5);
                return false; // æ— æƒ©ç½š
            }
        }
        return true; // æœ‰æƒ©ç½š
    },
    
    // è·å–è§†é‡ç­‰çº§
    getVisibilityLevel: () => {
        let visibility = gameState.weather.visibility;
        
        // å¤´ç¯æå‡å¤§é›¾è§†é‡
        const headlamp = EquipmentSystem.getEquipment("headlamp");
        if (headlamp && gameState.weather.id === "fog") {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(headlamp);
            if (m > 0) {
                const levels = ["none", "poor", "normal", "good"];
                const currentIndex = levels.indexOf(visibility);
                visibility = levels[Math.min(currentIndex + 1, levels.length - 1)];
            }
        }
        
        return visibility;
    },
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¤„ç†æš—å¤„äº‹ä»¶
    canHandleDarkEvent: () => {
        const headlamp = EquipmentSystem.getEquipment("headlamp");
        if (headlamp) {
            return EQUIPMENT_DURABILITY.getEffectMultiplier(headlamp) > 0;
        }
        return false;
    },
    
    // æ£€æŸ¥è¿·è·¯äº‹ä»¶æ˜¯å¦æ˜¾ç¤ºæ­£ç¡®é€‰é¡¹
    showCorrectChoiceInLostEvent: () => {
        const compass = EquipmentSystem.getEquipment("compass");
        if (compass) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(compass);
            if (m > 0) {
                // å¯¼èˆªæ¶é™„è¿‘æ•ˆæœå¢å¼º
                const node = MAP_NODES[gameState.currentNode];
                if (node.name === "å¯¼èˆªæ¶") {
                    return Math.random() < (0.8 * m * 1.5);
                }
                return Math.random() < (0.8 * m);
            }
        }
        return false;
    },
    
    // æ£€æŸ¥GPSæ˜¯å¦å¯ä»¥è‡ªåŠ¨æ¢å¤è¿·è·¯
    tryAutoRecoverFromLost: () => {
        const gps = EquipmentSystem.getEquipment("gps");
        if (gps) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(gps);
            if (m > 0 && Math.random() < (0.8 * m)) {
                logEvent("ğŸ“¡ GPSå®šä½æˆåŠŸï¼Œä½ æ‰¾åˆ°äº†æ­£ç¡®çš„æ–¹å‘ï¼");
                return true;
            }
        }
        return false;
    },
    
    // ä½¿ç”¨GPSç´§æ€¥æ±‚æ•‘
    useEmergencyRescue: () => {
        const gps = EquipmentSystem.getEquipment("gps");
        if (gps && !gps.rescueUsed) {
            gps.rescueUsed = true;
            logEvent("ğŸ†˜ GPSç´§æ€¥æ±‚æ•‘ä¿¡å·å·²å‘é€ï¼æ•‘æ´é˜Ÿæ­£åœ¨èµ¶æ¥...");
            // æ¢å¤å¤§é‡ä½“åŠ›å’Œç†æ™º
            gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 50);
            gameState.sanity = Math.min(100, gameState.sanity + 30);
            gameState.mood = Math.min(100, gameState.mood + 20);
            return true;
        }
        return false;
    },
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æºå¸¦å¸ç¯·ï¼ˆéœ²è¥é€‰é¡¹ï¼‰
    canCarryTent: () => {
        const heavyBag = EquipmentSystem.getEquipment("heavy_bag");
        if (heavyBag) {
            return EQUIPMENT_DURABILITY.getEffectMultiplier(heavyBag) > 0;
        }
        return false;
    },
    
    // åº”ç”¨å†²é”‹è¡£é˜²é›¨æ•ˆæœï¼ˆå‡å°‘å¤©æ°”è´Ÿé¢æ•ˆæœï¼‰
    applyRainResist: (effect) => {
        const jacket = EquipmentSystem.getEquipment("jacket");
        if (jacket && (gameState.weather.id === "light_rain" || gameState.weather.id === "heavy_rain")) {
            const m = EQUIPMENT_DURABILITY.getEffectMultiplier(jacket);
            return effect * (1 - 0.5 * m);
        }
        return effect;
    },
    
    // æ¶ˆè€—è£…å¤‡è€ä¹…ï¼ˆé€šç”¨ï¼‰
    consumeDurability: (equipmentId, amount = 1) => {
        const equipment = EquipmentSystem.getEquipment(equipmentId);
        if (equipment) {
            const result = EQUIPMENT_DURABILITY.useEquipment(equipment, amount);
            if (!result && equipment.durability <= 0) {
                logEvent(`âš ï¸ ${equipment.name} å·²æŸåï¼`);
            }
            return result;
        }
        return false;
    }
};

const ACHIEVEMENTS = [
    { id: "speed_runner", name: "æé€Ÿç©¿è¶Š", icon: "ğŸƒ", desc: "3å¤©å†…å®Œæˆç©¿è¶Š", category: "survival", condition: "day <= 3" },
    { id: "light_packer", name: "è½»è£…ä¸Šé˜µ", icon: "ğŸƒ", desc: "åªå¸¦åŸºç¡€è£…å¤‡å®Œæˆ", category: "survival", condition: "basic_only" },
    { id: "iron_man", name: "é“äººæ¨¡å¼", icon: "ğŸ’ª", desc: "å›°éš¾éš¾åº¦é€šå…³", category: "survival", condition: "hard_mode" },
    { id: "survivor", name: "ç”Ÿå­˜ä¸“å®¶", icon: "ğŸ”¥", desc: "åœ¨æ¶åŠ£å¤©æ°”ä¸­å­˜æ´»", category: "survival", condition: "bad_weather_survive" },
    { id: "photographer", name: "æ‘„å½±å¸ˆ", icon: "ğŸ“¸", desc: "è§¦å‘æ‰€æœ‰é£æ™¯äº‹ä»¶", category: "explore", condition: "all_scenery" },
    { id: "explorer", name: "æ¢ç´¢è€…", icon: "ğŸ—ºï¸", desc: "èµ°è¿‡æ‰€æœ‰å†’é™©è·¯çº¿", category: "explore", condition: "all_danger_routes" },
    { id: "camp_master", name: "éœ²è¥å¤§å¸ˆ", icon: "ğŸ•ï¸", desc: "åœ¨æ¯ä¸ªè¥åœ°ä¼‘æ¯è¿‡", category: "explore", condition: "all_camps" },
    { id: "helper", name: "åŠ©äººä¸ºä¹", icon: "ğŸ¤", desc: "å¸®åŠ©æ‰€æœ‰é‡åˆ°çš„å¾’æ­¥è€…", category: "moral", condition: "help_all_hikers" },
    { id: "nature_respect", name: "æ•¬ç•è‡ªç„¶", icon: "ğŸ™", desc: "ä¸é€‰æ‹©å†’é™©è·¯çº¿", category: "moral", condition: "no_danger_routes" },
    { id: "eco_guardian", name: "ç¯ä¿å«å£«", icon: "ğŸ’š", desc: "ä¸ç•™ä¸‹ä»»ä½•åƒåœ¾", category: "moral", condition: "no_trash" },
    { id: "blizzard_survivor", name: "æš´é£é›ªå¹¸å­˜è€…", icon: "â„ï¸", desc: "åœ¨æš´é£é›ªä¸­å­˜æ´»", category: "special", condition: "survive_blizzard" },
    { id: "perfect_finish", name: "å®Œç¾é€šå…³", icon: "ğŸŒŸ", desc: "æ»¡ä½“åŠ›åˆ°è¾¾ç»ˆç‚¹", category: "special", condition: "full_stamina_end" },
    { id: "lucky_one", name: "å¹¸è¿å„¿", icon: "ğŸ²", desc: "è¿ç»­3æ¬¡é‡åˆ°å¥½äº‹", category: "special", condition: "three_good_events" },
    { id: "doctor", name: "é‡å¤–åŒ»ç”Ÿ", icon: "âš•ï¸", desc: "æˆåŠŸæ²»ç–—æ‰€æœ‰ä¼¤åŠ¿", category: "special", condition: "heal_all" },
    { id: "navigator", name: "å¯¼èˆªä¸“å®¶", icon: "ğŸ§­", desc: "ä»æœªè¿·è·¯", category: "special", condition: "never_lost" }
];

// ==================== æ¸¸æˆçŠ¶æ€ ====================

let gameState = {
    // åŸºç¡€çŠ¶æ€
    currentNode: 0,
    day: 1,
    hour: 8,                     // å½“å‰å°æ—¶ (0-23)
    weather: null,
    weatherDuration: 0,          // å¤©æ°”å‰©ä½™æŒç»­æ—¶é—´
    
    // ç©å®¶æ ¸å¿ƒå±æ€§
    stamina: 100,                // ä½“åŠ› (0-100)
    maxStamina: 100,
    food: 100,                   // é¥±é£Ÿåº¦ (0-100)
    water: 100,                  // æ°´åˆ† (0-100)
    bodyTemp: 37,                // ä½“æ¸© (35-42Â°C)
    
    // ç²¾ç¥çŠ¶æ€
    mood: 50,                    // å¿ƒæƒ… (0-100)
    sanity: 100,                 // ç†æ™º (0-100)
    
    // èº«ä½“çŠ¶æ€
    health: 100,                 // å¥åº· (0-100)
    fatigue: 0,                  // ç–²åŠ³åº¦ (0-100)
    wetness: 0,                  // æ¹¿èº«ç¨‹åº¦ (0-100)
    
    // çŠ¶æ€æ•ˆæœ
    statusEffects: [],           // çŠ¶æ€æ•ˆæœæ•°ç»„
    
    // è£…å¤‡
    equipment: [],
    inventory: [],
    totalWeight: 0,
    maxCapacity: 0,
    
    // è£…å¤‡è€ä¹…åº¦è¿½è¸ª
    equipmentDurability: {},     // { equipmentId: durability }
    
    // æ¸¸æˆè¿›åº¦
    gameOver: false,
    victory: false,
    difficulty: "normal",
    difficultyConfig: null,      // å½“å‰éš¾åº¦é…ç½®
    
    // éš¾åº¦ç»Ÿè®¡
    blizzardCount: 0,            // ç»å†çš„æš´é£é›ªæ¬¡æ•°
    injuryCount: 0,              // å—ä¼¤æ¬¡æ•°
    equipmentPointsUsed: 0,      // ä½¿ç”¨çš„è£…å¤‡ç‚¹æ•°
    
    // ç»Ÿè®¡
    moves: 0,
    eventsTriggered: 0,
    restCount: 0,
    totalDistance: 0,
    
    // æˆå°±è¿½è¸ª
    achievements: [],
    unlockedAchievements: [],
    sceneryEventsTriggered: [],
    dangerRoutesTaken: [],
    campsRested: [],
    hikersHelped: 0,
    hikersEncountered: 0,
    normalRoutesTaken: [],
    trashLeft: 0,
    survivedBlizzard: false,
    goodEventStreak: 0,
    maxGoodEventStreak: 0,
    neverLost: true,
    injuriesHealed: 0,
    
    // å†³ç­–å½±å“
    decisionHistory: [],         // å†³ç­–å†å²
    moralScore: 0,               // é“å¾·åˆ†æ•°
    chainEffects: [],            // è¿é”æ•ˆæœ
    
    // æ­»äº¡åŸå› 
    deathReason: ""
};

// ==================== åˆå§‹åŒ–å‡½æ•° ====================

function initGame() {
    loadAchievements();
    loadGame();
    loadUnlockedDifficulties();
    setupEventListeners();
    // å®æ™¯ç³»ç»Ÿç”± scenery.js è‡ªåŠ¨åˆå§‹åŒ–
    updateUI();
}

// ==================== éš¾åº¦ç³»ç»Ÿ ====================

let unlockedDifficulties = ['easy', 'normal']; // é»˜è®¤è§£é”ç®€å•å’Œæ™®é€š

function loadUnlockedDifficulties() {
    const saved = localStorage.getItem("aotai_unlocked_difficulties");
    if (saved) {
        unlockedDifficulties = JSON.parse(saved);
    }
}

function saveUnlockedDifficulties() {
    localStorage.setItem("aotai_unlocked_difficulties", JSON.stringify(unlockedDifficulties));
}

function unlockDifficulty(difficultyId) {
    if (!unlockedDifficulties.includes(difficultyId)) {
        unlockedDifficulties.push(difficultyId);
        saveUnlockedDifficulties();
        logEvent(`ğŸ‰ è§£é”æ–°éš¾åº¦: ${DIFFICULTY_MODES[difficultyId]?.name || difficultyId}!`);
    }
}

function isDifficultyUnlocked(difficultyId) {
    return unlockedDifficulties.includes(difficultyId);
}

function showDifficultyScreen() {
    renderDifficultyOptions();
    showScreen("difficulty-screen");
}

function renderDifficultyOptions() {
    const container = document.getElementById("difficulty-options");
    if (!container) return;
    container.innerHTML = "";
    
    Object.values(DIFFICULTY_MODES).forEach(mode => {
        const isUnlocked = isDifficultyUnlocked(mode.id);
        const isRecommended = mode.id === 'normal';
        
        const modeDiv = document.createElement("div");
        modeDiv.className = `difficulty-option ${mode.id} ${isUnlocked ? '' : 'locked'} ${isRecommended ? 'recommended' : ''}`;
        modeDiv.style.borderColor = mode.color;
        
        if (!isUnlocked) {
            modeDiv.style.opacity = "0.6";
        }
        
        modeDiv.innerHTML = `
            <div class="difficulty-header">
                <span class="difficulty-icon">${isUnlocked ? mode.icon : 'ğŸ”’'}</span>
                <span class="difficulty-name">${mode.name}</span>
                ${isRecommended ? '<span class="recommended-badge">æ¨è</span>' : ''}
            </div>
            <div class="difficulty-desc">${isUnlocked ? mode.description : 'å®Œæˆå‰ä¸€éš¾åº¦ä»¥è§£é”'}</div>
            <div class="difficulty-stats">
                <div class="stat-row">
                    <span>åˆå§‹ä½“åŠ›:</span>
                    <span>${mode.initialStats.stamina}</span>
                </div>
                <div class="stat-row">
                    <span>è£…å¤‡é¢„ç®—:</span>
                    <span>${mode.equipmentPoints}ç‚¹</span>
                </div>
                <div class="stat-row">
                    <span>æˆå°±å€ç‡:</span>
                    <span>${mode.achievementMultiplier}x</span>
                </div>
                ${mode.permanentDeath ? '<div class="stat-row warning"><span>âš ï¸ æ°¸ä¹…æ­»äº¡</span></div>' : ''}
            </div>
        `;
        
        if (isUnlocked) {
            modeDiv.addEventListener("click", () => selectDifficulty(mode.id));
        }
        
        container.appendChild(modeDiv);
    });
}

function selectDifficulty(difficultyId) {
    gameState.difficulty = difficultyId;
    gameState.difficultyConfig = DIFFICULTY_MODES[difficultyId];
    
    // é«˜äº®é€‰ä¸­çš„éš¾åº¦
    document.querySelectorAll('.difficulty-option').forEach(el => {
        el.classList.remove('selected');
    });
    const selectedEl = document.querySelector(`.difficulty-option.${difficultyId}`);
    if (selectedEl) selectedEl.classList.add('selected');
    
    // å¯ç”¨å¼€å§‹æŒ‰é’®
    const startBtn = document.getElementById("btn-start-equipment");
    if (startBtn) startBtn.disabled = false;
    
    logEvent(`é€‰æ‹©äº†${DIFFICULTY_MODES[difficultyId].name}`);
}

function confirmDifficulty() {
    if (!gameState.difficultyConfig) {
        gameState.difficultyConfig = DIFFICULTY_MODES.normal;
    }
    showEquipmentScreen();
}

function setupEventListeners() {
    // ä¸»èœå•æŒ‰é’®
    document.getElementById("btn-new-game")?.addEventListener("click", () => {
        startNewGame();
    });
    document.getElementById("btn-continue")?.addEventListener("click", () => {
        continueGame();
    });
    document.getElementById("btn-help")?.addEventListener("click", () => {
        showHelp();
    });
    document.getElementById("btn-achievements")?.addEventListener("click", () => {
        showAchievements();
    });
    
    // éš¾åº¦é€‰æ‹©ç•Œé¢
    document.getElementById("btn-start-equipment")?.addEventListener("click", () => {
        confirmDifficulty();
    });
    document.getElementById("btn-back-from-difficulty")?.addEventListener("click", () => {
        showScreen("main-menu");
    });
    
    // è£…å¤‡é€‰æ‹©ç•Œé¢
    document.getElementById("btn-start-journey")?.addEventListener("click", () => {
        startJourney();
    });
    document.getElementById("btn-back-menu")?.addEventListener("click", () => {
        showScreen("main-menu");
    });
    
    // æ¸¸æˆä¸»ç•Œé¢
    document.getElementById("btn-move")?.addEventListener("click", () => {
        showMoveOptions();
    });
    document.getElementById("btn-rest")?.addEventListener("click", () => {
        rest();
    });
    document.getElementById("btn-eat")?.addEventListener("click", () => {
        eat();
    });
    document.getElementById("btn-drink")?.addEventListener("click", () => {
        drink();
    });
    document.getElementById("btn-inventory")?.addEventListener("click", () => {
        showInventory();
    });
    document.getElementById("btn-save")?.addEventListener("click", () => {
        saveGame();
    });
    
    // ç§»åŠ¨ç•Œé¢
    document.getElementById("btn-cancel-move")?.addEventListener("click", () => {
        hideModal("move-screen");
    });
    
    // èƒŒåŒ…ç•Œé¢
    document.getElementById("btn-close-inventory")?.addEventListener("click", () => {
        hideModal("inventory-screen");
    });
    
    // æ¸¸æˆç»“æŸç•Œé¢
    document.getElementById("btn-restart")?.addEventListener("click", () => {
        startNewGame();
    });
    document.getElementById("btn-main-menu")?.addEventListener("click", () => {
        showScreen("main-menu");
    });
    
    // å¸®åŠ©ç•Œé¢
    document.getElementById("btn-close-help")?.addEventListener("click", () => {
        hideModal("help-screen");
    });
    
    // æˆå°±ç•Œé¢
    document.getElementById("btn-close-achievements")?.addEventListener("click", () => {
        hideModal("achievements-screen");
    });
}

// ==================== æ¸¸æˆæµç¨‹æ§åˆ¶ ====================

function startNewGame() {
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    gameState = {
        currentNode: 0,
        day: 1,
        hour: 8,
        weather: generateWeather(),
        weatherDuration: Math.floor(Math.random() * 4) + 2,
        
        stamina: 100,
        maxStamina: 100,
        food: 100,
        water: 100,
        bodyTemp: 37,
        
        mood: 50,
        sanity: 100,
        
        health: 100,
        fatigue: 0,
        wetness: 0,
        
        statusEffects: [],
        
        equipment: [],
        inventory: [],
        totalWeight: 0,
        maxCapacity: 0,
        
        // è£…å¤‡è€ä¹…åº¦è¿½è¸ª
        equipmentDurability: {},
        
        gameOver: false,
        victory: false,
        difficulty: "normal",
        difficultyConfig: null,
        
        moves: 0,
        eventsTriggered: 0,
        restCount: 0,
        totalDistance: 0,
        blizzardCount: 0,
        injuryCount: 0,
        equipmentPointsUsed: 0,
        
        achievements: [],
        unlockedAchievements: gameState.unlockedAchievements || [],
        sceneryEventsTriggered: [],
        dangerRoutesTaken: [],
        campsRested: [],
        hikersHelped: 0,
        hikersEncountered: 0,
        normalRoutesTaken: [],
        trashLeft: 0,
        survivedBlizzard: false,
        goodEventStreak: 0,
        maxGoodEventStreak: 0,
        neverLost: true,
        injuriesHealed: 0,
        
        decisionHistory: [],
        moralScore: 0,
        chainEffects: [],
        
        deathReason: ""
    };
    
    showDifficultyScreen();
}

function continueGame() {
    if (localStorage.getItem("aotai_save")) {
        loadGame();
        if (!gameState.gameOver) {
            showScreen("game-screen");
            updateUI();
        }
    }
}

function showEquipmentScreen() {
    renderEquipmentList();
    showScreen("equipment-screen");
}

function renderEquipmentList() {
    const categories = ["backpacks", "clothing", "tools", "food", "water"];
    const containerIds = ["backpack-list", "clothing-list", "tool-list", "food-list", "water-list"];
    
    // è·å–å½“å‰éš¾åº¦çš„è£…å¤‡ç‚¹æ•°
    const equipmentPoints = gameState.difficultyConfig?.equipmentPoints || 100;
    
    categories.forEach((category, index) => {
        const container = document.getElementById(containerIds[index]);
        if (!container) return;
        container.innerHTML = "";
        
        const items = EQUIPMENT[category] || [];
        items.forEach(item => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "equipment-item";
            itemDiv.dataset.id = item.id;
            itemDiv.dataset.category = category;
            itemDiv.innerHTML = `
                <div class="item-name">${item.name}</div>
                <div class="item-desc">${item.desc}</div>
                <div class="item-stats">
                    <span>é‡é‡: ${item.weight}kg</span>
                    <span>æ¶ˆè€—: ${item.cost}ç‚¹</span>
                </div>
            `;
            itemDiv.addEventListener("click", () => toggleEquipment(item, category, itemDiv));
            container.appendChild(itemDiv);
        });
    });
    
    updateEquipmentSummary();
}

function toggleEquipment(item, category, element) {
    const isSelected = element.classList.contains("selected");
    const equipmentPoints = gameState.difficultyConfig?.equipmentPoints || 100;
    const currentPoints = parseInt(document.getElementById("remaining-points")?.textContent || equipmentPoints);
    
    if (isSelected) {
        element.classList.remove("selected");
        gameState.equipment = gameState.equipment.filter(e => e.id !== item.id);
    } else {
        // èƒŒåŒ…ç±»åªèƒ½é€‰ä¸€ä¸ª
        if (category === "backpacks") {
            const existingBackpack = gameState.equipment.find(e => 
                EQUIPMENT.backpacks.some(b => b.id === e.id)
            );
            if (existingBackpack) {
                gameState.equipment = gameState.equipment.filter(e => e.id !== existingBackpack.id);
                document.querySelectorAll("#backpack-list .equipment-item").forEach(el => {
                    el.classList.remove("selected");
                });
            }
        }
        
        if (currentPoints < item.cost) {
            logEvent("ç‚¹æ•°ä¸è¶³ï¼Œæ— æ³•é€‰æ‹©æ­¤è£…å¤‡ï¼");
            return;
        }
        
        element.classList.add("selected");
        gameState.equipment.push({ ...item, category });
    }
    
    updateEquipmentSummary();
}

function updateEquipmentSummary() {
    const equipmentPoints = gameState.difficultyConfig?.equipmentPoints || 100;
    const selectedCount = gameState.equipment.length;
    const totalWeight = gameState.equipment.reduce((sum, item) => sum + (item.weight || 0), 0);
    const totalCost = gameState.equipment.reduce((sum, item) => sum + (item.cost || 0), 0);
    const remainingPoints = equipmentPoints - totalCost;
    
    const backpack = gameState.equipment.find(e => 
        EQUIPMENT.backpacks.some(b => b.id === e.id)
    );
    gameState.maxCapacity = backpack ? backpack.capacity : 10;
    gameState.totalWeight = totalWeight;
    gameState.equipmentPointsUsed = totalCost;
    
    const selectedCountEl = document.getElementById("selected-count");
    const totalWeightEl = document.getElementById("total-weight");
    const remainingPointsEl = document.getElementById("remaining-points");
    const startBtn = document.getElementById("btn-start-journey");
    const pointsDisplayEl = document.getElementById("equipment-points-display");
    
    if (selectedCountEl) selectedCountEl.textContent = selectedCount;
    if (totalWeightEl) totalWeightEl.textContent = totalWeight.toFixed(1);
    if (remainingPointsEl) remainingPointsEl.textContent = remainingPoints;
    if (pointsDisplayEl) pointsDisplayEl.textContent = equipmentPoints;
    if (startBtn) startBtn.disabled = !backpack || remainingPoints < 0;
}

function startJourney() {
    // åº”ç”¨éš¾åº¦é…ç½®çš„åˆå§‹å±æ€§
    const config = gameState.difficultyConfig || DIFFICULTY_MODES.normal;
    gameState.stamina = config.initialStats.stamina;
    gameState.maxStamina = config.initialStats.maxStamina;
    gameState.food = config.initialStats.food;
    gameState.water = config.initialStats.water;
    gameState.mood = config.initialStats.mood;
    gameState.sanity = config.initialStats.sanity;
    gameState.bodyTemp = config.initialStats.bodyTemp;
    
    gameState.inventory = [...gameState.equipment];
    
    // åˆå§‹åŒ–è£…å¤‡è€ä¹…åº¦
    gameState.equipment.forEach(item => {
        if (item.durability) {
            gameState.equipmentDurability[item.id] = item.durability;
        }
    });
    
    // åˆå§‹åŒ–é£Ÿç‰©
    const foodItems = gameState.equipment.filter(e => 
        EQUIPMENT.food.some(f => f.id === e.id)
    );
    const foodBonus = foodItems.reduce((sum, item) => sum + (item.foodValue || 0), 0);
    gameState.food = Math.min(config.initialStats.food, config.initialStats.food * 0.5 + foodBonus);
    
    // åˆå§‹åŒ–æ°´
    const waterItems = gameState.equipment.filter(e => 
        EQUIPMENT.water.some(w => w.id === e.id)
    );
    const waterBonus = waterItems.reduce((sum, item) => sum + (item.capacity || 0), 0);
    gameState.water = Math.min(config.initialStats.water, config.initialStats.water * 0.5 + waterBonus);
    
    logEvent(`ğŸ® å¼€å§‹${config.name}ç©¿è¶Šï¼ç¥ä½ å¥½è¿ï¼`);
    logEvent(`å½“å‰å¤©æ°”: ${gameState.weather.name} ${gameState.weather.icon}`);
    
    // åœ°ç‹±æ¨¡å¼ç‰¹æ®Šæç¤º
    if (config.id === 'hell') {
        logEvent("âš ï¸ è­¦å‘Šï¼šåœ°ç‹±æ¨¡å¼ä¸‹æ­»äº¡å°†æ°¸ä¹…å¤±å»å­˜æ¡£ï¼");
    }
    
    showScreen("game-screen");
    renderMap();
    updateUI();
}

// ==================== å¤©æ°”ç³»ç»Ÿ ====================

function generateWeather() {
    const config = gameState.difficultyConfig || DIFFICULTY_MODES.normal;
    const rand = Math.random();
    
    // åº”ç”¨éš¾åº¦å¤©æ°”ä¿®æ­£
    let adjustedRand = rand;
    if (config.weatherModifier > 0) {
        // å¢åŠ æ¶åŠ£å¤©æ°”æ¦‚ç‡
        adjustedRand = Math.min(1, rand + config.weatherModifier * 0.3);
    } else if (config.weatherModifier < 0) {
        // å‡å°‘æ¶åŠ£å¤©æ°”æ¦‚ç‡
        adjustedRand = Math.max(0, rand + config.weatherModifier * 0.3);
    }
    
    // æš´é£é›ªæ¦‚ç‡ä¿®æ­£
    const blizzardThreshold = 0.90 - config.blizzardChanceModifier;
    
    if (adjustedRand < 0.25) return WEATHER_TYPES.sunny;
    if (adjustedRand < 0.45) return WEATHER_TYPES.cloudy;
    if (adjustedRand < 0.60) return WEATHER_TYPES.lightRain;
    if (adjustedRand < 0.72) return WEATHER_TYPES.heavyRain;
    if (adjustedRand < 0.82) return WEATHER_TYPES.fog;
    if (adjustedRand < 0.90) return WEATHER_TYPES.snow;
    if (adjustedRand < blizzardThreshold) return WEATHER_TYPES.snowstorm;
    return WEATHER_TYPES.thunderstorm;
}

function updateWeather() {
    gameState.weatherDuration--;
    
    if (gameState.weatherDuration <= 0) {
        const chain = WEATHER_CHAINS[gameState.weather.id];
        if (chain) {
            const nextWeatherProb = chain.nextWeather;
            const rand = Math.random();
            let cumulative = 0;
            
            for (const [weatherId, prob] of Object.entries(nextWeatherProb)) {
                cumulative += prob;
                if (rand <= cumulative) {
                    const oldWeather = gameState.weather;
                    gameState.weather = WEATHER_TYPES[weatherId];
                    gameState.weatherDuration = Math.floor(Math.random() * 
                        (chain.duration.max - chain.duration.min + 1)) + chain.duration.min;
                    
                    if (oldWeather.id !== gameState.weather.id) {
                        logEvent(`å¤©æ°”å˜åŒ–äº†ï¼${oldWeather.icon} â†’ ${gameState.weather.icon} ${gameState.weather.name}`);
                        logEvent(gameState.weather.description);
                    }
                    break;
                }
            }
        }
    }
    
    // åº”ç”¨å¤©æ°”æ•ˆæœ
    applyWeatherEffects();
}

function applyWeatherEffects() {
    const weather = gameState.weather;
    
    // ä½“æ¸©å˜åŒ–ï¼ˆåº”ç”¨è¡£ç‰©ä¿æš–æ•ˆæœï¼‰
    let bodyTempChange = weather.bodyTempEffect;
    bodyTempChange = EquipmentSystem.applyBodyTempEffects(bodyTempChange);
    gameState.bodyTemp = Math.max(35, Math.min(42, 
        gameState.bodyTemp + bodyTempChange
    ));
    
    // æ¹¿èº«ç¨‹åº¦ï¼ˆåº”ç”¨å†²é”‹è¡£é˜²é›¨æ•ˆæœï¼‰
    let wetnessChange = weather.wetnessChange;
    if (wetnessChange > 0) {
        wetnessChange = EquipmentSystem.applyRainResist(wetnessChange);
    }
    gameState.wetness = Math.max(0, Math.min(100, 
        gameState.wetness + wetnessChange
    ));
    
    // å¿ƒæƒ…å½±å“
    gameState.mood = Math.max(0, Math.min(100, 
        gameState.mood + weather.moodEffect / 10
    ));
    
    // æ£€æŸ¥å¤©æ°”è¿é”ååº”
    checkWeatherChains();
}

function checkWeatherChains() {
    // æ™´å¤©æš´æ™’ â†’ ä¸­æš‘
    if (gameState.weather.id === "sunny" && gameState.bodyTemp > 38 && gameState.water < 30) {
        if (Math.random() < 0.1 && !hasStatusEffect("heatStroke")) {
            addStatusEffect("heatStroke");
            logEvent("âš ï¸ çƒˆæ—¥æš´æ™’ï¼Œä½ æ„Ÿè§‰å¤´æ™•æ¶å¿ƒï¼Œå¯èƒ½ä¸­æš‘äº†ï¼");
        }
    }
    
    // æ¹¿èº« + ä½æ¸© â†’ å¤±æ¸©
    if (gameState.wetness > 50 && (gameState.bodyTemp < 36 || gameState.weather.temperature < 5)) {
        if (Math.random() < 0.15 && !hasStatusEffect("hypothermia")) {
            addStatusEffect("hypothermia");
            logEvent("âš ï¸ æ¹¿å†·çš„è¡£ç‰©è®©ä½ ä½“æ¸©å¿«é€Ÿæµå¤±ï¼Œä½ å¼€å§‹å¤±æ¸©äº†ï¼");
        }
    }
    
    // æš´é£é›ªå­˜æ´»è®°å½•
    if (gameState.weather.id === "snowstorm" && gameState.stamina > 0) {
        gameState.survivedBlizzard = true;
        gameState.blizzardCount++;
    }
}

// ==================== çŠ¶æ€æ•ˆæœç³»ç»Ÿ ====================

function addStatusEffect(effectId) {
    if (hasStatusEffect(effectId)) return;
    
    const effect = STATUS_EFFECTS[effectId];
    if (!effect) return;
    
    // è®°å½•å—ä¼¤æ¬¡æ•°ï¼ˆç”¨äºæˆå°±ç»Ÿè®¡ï¼‰
    if (effectId === 'injured' || effectId === 'ankleSprain' || effectId === 'frostbite') {
        gameState.injuryCount++;
    }
    
    const statusEffect = {
        id: effectId,
        name: effect.name,
        icon: effect.icon,
        startTime: Date.now(),
        duration: effect.duration,
        effects: effect.effects
    };
    
    gameState.statusEffects.push(statusEffect);
    
    // åº”ç”¨å³æ—¶æ•ˆæœ
    if (effect.effects.maxStamina) {
        gameState.maxStamina = Math.min(100, effect.effects.maxStamina);
        gameState.stamina = Math.min(gameState.stamina, gameState.maxStamina);
    }
    
    logEvent(`${effect.icon} è·å¾—çŠ¶æ€: ${effect.name} - ${effect.description}`);
    
    // è§¦å‘è¿é”äº‹ä»¶
    if (effect.chainEvents && effect.chainEvents.length > 0) {
        setTimeout(() => {
            triggerChainEvent(effect.chainEvents);
        }, 2000);
    }
}

function removeStatusEffect(effectId) {
    const index = gameState.statusEffects.findIndex(e => e.id === effectId);
    if (index === -1) return;
    
    const effect = STATUS_EFFECTS[effectId];
    gameState.statusEffects.splice(index, 1);
    
    // æ¢å¤æœ€å¤§ä½“åŠ›
    if (effect?.effects?.maxStamina) {
        gameState.maxStamina = 100;
    }
    
    logEvent(`âœ… çŠ¶æ€è§£é™¤: ${effect?.name || effectId}`);
}

function hasStatusEffect(effectId) {
    return gameState.statusEffects.some(e => e.id === effectId);
}

function updateStatusEffects() {
    const now = Date.now();
    
    gameState.statusEffects = gameState.statusEffects.filter(effect => {
        // æŒç»­æ—¶é—´ä¸º-1è¡¨ç¤ºéœ€è¦ä¸»åŠ¨æ²»ç–—
        if (effect.duration === -1) return true;
        
        const elapsed = (now - effect.startTime) / 1000;
        if (elapsed >= effect.duration) {
            const statusDef = STATUS_EFFECTS[effect.id];
            if (statusDef) {
                logEvent(`â° çŠ¶æ€è¿‡æœŸ: ${statusDef.name}`);
                // æ¢å¤æœ€å¤§ä½“åŠ›
                if (statusDef.effects?.maxStamina) {
                    gameState.maxStamina = 100;
                }
            }
            return false;
        }
        return true;
    });
}

function getStatusEffectModifiers() {
    let modifiers = {
        staminaRegen: 0,
        staminaDrain: 1,
        moveSpeed: 1,
        judgment: 0,
        eventSuccessRate: 1,
        moodEffect: 0,
        sanityEffect: 0
    };
    
    gameState.statusEffects.forEach(effect => {
        const def = STATUS_EFFECTS[effect.id];
        if (def && def.effects) {
            if (def.effects.staminaRegen) modifiers.staminaRegen += def.effects.staminaRegen;
            if (def.effects.staminaDrain) modifiers.staminaDrain *= def.effects.staminaDrain;
            if (def.effects.moveSpeed) modifiers.moveSpeed *= def.effects.moveSpeed;
            if (def.effects.judgment) modifiers.judgment += def.effects.judgment;
            if (def.effects.eventSuccessRate) modifiers.eventSuccessRate *= def.effects.eventSuccessRate;
            if (def.effects.moodEffect) modifiers.moodEffect += def.effects.moodEffect;
            if (def.effects.sanityEffect) modifiers.sanityEffect += def.effects.sanityEffect;
        }
    });
    
    return modifiers;
}

// ==================== äº‹ä»¶ç³»ç»Ÿ ====================

function triggerChainEvent(eventIds) {
    if (!eventIds || eventIds.length === 0) return;
    
    const eventId = eventIds[Math.floor(Math.random() * eventIds.length)];
    
    switch (eventId) {
        case "decisionMistake":
            logEvent("ğŸ¤” ä½ çš„åˆ¤æ–­åŠ›å—åˆ°å½±å“ï¼Œåšäº†ä¸€ä¸ªä¸å¤ªæ˜æ™ºçš„å†³å®š...");
            gameState.mood -= 10;
            break;
        case "stumble":
            logEvent("ğŸ˜µ ä½ ç»Šäº†ä¸€ä¸‹ï¼Œå·®ç‚¹æ‘”å€’ï¼");
            gameState.stamina -= 10;
            break;
        case "panic":
            if (!hasStatusEffect("panic")) {
                addStatusEffect("panic");
                logEvent("ğŸ˜° ä½ æ„Ÿåˆ°ä¸€é˜µææ…Œï¼");
            }
            break;
        case "collapse":
            logEvent("ğŸ’€ ä½ ä½“åŠ›ä¸æ”¯å€’ä¸‹äº†ï¼");
            gameState.stamina -= 30;
            break;
        case "slowProgress":
            logEvent("ğŸ¢ ä¼¤åŠ¿æ‹–æ…¢äº†ä½ çš„è¿›åº¦...");
            break;
        case "missCamp":
            logEvent("ğŸ•ï¸ ä½ æ— æ³•åœ¨å¤©é»‘å‰åˆ°è¾¾è¥åœ°...");
            break;
        case "getLost":
            logEvent("ğŸ—ºï¸ ä½ è¿·å¤±äº†æ–¹å‘ï¼");
            gameState.neverLost = false;
            break;
    }
}

function checkEventTriggers() {
    const currentNode = MAP_NODES[gameState.currentNode];
    const currentRoute = getCurrentRoute();
    const terrain = currentRoute ? TERRAIN_TYPES[currentRoute.terrain] : TERRAIN_TYPES[currentNode.terrain];
    const weather = gameState.weather;
    const timeOfDay = getTimeOfDay();
    
    for (const [eventId, conditions] of Object.entries(EVENT_CONDITIONS)) {
        let shouldTrigger = true;
        let chance = conditions.baseChance;
        
        // æ£€æŸ¥å¤©æ°”æ¡ä»¶
        if (conditions.weather !== "any") {
            if (Array.isArray(conditions.weather)) {
                if (!conditions.weather.includes(weather.id)) shouldTrigger = false;
            } else if (conditions.weather !== weather.id) {
                shouldTrigger = false;
            }
        }
        
        // æ£€æŸ¥æ¸©åº¦æ¡ä»¶
        if (conditions.temperature && shouldTrigger) {
            if (conditions.temperature.min && weather.temperature < conditions.temperature.min) {
                shouldTrigger = false;
            }
            if (conditions.temperature.max && weather.temperature > conditions.temperature.max) {
                shouldTrigger = false;
            }
        }
        
        // æ£€æŸ¥åœ°å½¢æ¡ä»¶
        if (conditions.terrain !== "any" && shouldTrigger) {
            if (Array.isArray(conditions.terrain)) {
                if (!conditions.terrain.includes(terrain.id)) shouldTrigger = false;
            } else if (conditions.terrain !== terrain.id) {
                shouldTrigger = false;
            }
        }
        
        // æ£€æŸ¥æµ·æ‹”æ¡ä»¶
        if (conditions.altitude && shouldTrigger) {
            if (conditions.altitude.min && currentNode.elevation < conditions.altitude.min) {
                shouldTrigger = false;
            }
            if (conditions.altitude.max && currentNode.elevation > conditions.altitude.max) {
                shouldTrigger = false;
            }
        }
        
        // æ£€æŸ¥æ—¶é—´æ¡ä»¶
        if (conditions.time !== "any" && shouldTrigger) {
            if (Array.isArray(conditions.time)) {
                if (!conditions.time.includes(timeOfDay)) shouldTrigger = false;
            } else if (conditions.time !== timeOfDay) {
                shouldTrigger = false;
            }
        }
        
        // æ£€æŸ¥çŠ¶æ€æ•ˆæœæ¡ä»¶
        if (conditions.statusEffects && conditions.statusEffects.length > 0 && shouldTrigger) {
            const hasRequiredStatus = conditions.statusEffects.some(status => hasStatusEffect(status));
            if (!hasRequiredStatus) shouldTrigger = false;
            else chance *= 1.5; // æœ‰å¯¹åº”çŠ¶æ€æ•ˆæœæ—¶æ¦‚ç‡å¢åŠ 
        }
        
        // åº”ç”¨å¤©æ°”äº‹ä»¶ä¿®æ­£
        if (shouldTrigger && weather.eventModifiers[eventId]) {
            chance += weather.eventModifiers[eventId];
        }
        
        // åº”ç”¨åœ°å½¢é£é™©ä¿®æ­£
        if (shouldTrigger && terrain.risks && terrain.risks[eventId]) {
            chance += terrain.risks[eventId];
        }
        
        // åº”ç”¨ç–²åŠ³åº¦å½±å“
        if (gameState.fatigue > 70) {
            chance *= 1.3; // ç–²åŠ³æ—¶äº‹ä»¶æ¦‚ç‡å¢åŠ 
        }
        
        // åº”ç”¨è£…å¤‡æ•ˆæœï¼ˆè¿·è·¯æ¦‚ç‡ï¼‰
        if (eventId === "getLost") {
            chance = EquipmentSystem.applyGetLostChance(chance);
        }
        
        // åº”ç”¨è£…å¤‡æ•ˆæœï¼ˆæ»‘å€’æ¦‚ç‡ï¼‰
        if (eventId === "fall") {
            chance = EquipmentSystem.applySlipChance(chance);
        }
        
        // è§¦å‘äº‹ä»¶
        if (shouldTrigger && Math.random() < chance) {
            triggerDangerEvent(eventId);
            return;
        }
    }
}

function triggerDangerEvent(eventId) {
    switch (eventId) {
        case "heatStroke":
            addStatusEffect("heatStroke");
            showEventModal({
                title: "ä¸­æš‘ï¼",
                icon: "ğŸ¥µ",
                description: "çƒˆæ—¥å½“ç©ºï¼Œä½ æ„Ÿåˆ°å¤´æ™•ç›®çœ©ï¼Œæ¶å¿ƒå‘•åã€‚è¿™æ˜¯ä¸­æš‘çš„ç—‡çŠ¶ï¼",
                choices: [
                    { text: "å¯»æ‰¾é˜´å‡‰å¤„ä¼‘æ¯ (-20ä½“åŠ›, +10ç†æ™º)", effect: { stamina: -20, sanity: 10 }, removeStatus: "heatStroke" },
                    { text: "å–æ°´é™æ¸© (-10æ°´åˆ†, ç¼“è§£ç—‡çŠ¶)", effect: { water: -10 }, removeStatus: "heatStroke" },
                    { text: "ç¡¬æ’‘å‰è¿› (-30ä½“åŠ›, ç—‡çŠ¶åŠ é‡)", effect: { stamina: -30 }, addStatus: "exhausted" }
                ]
            });
            break;
            
        case "hypothermia":
            addStatusEffect("hypothermia");
            showEventModal({
                title: "å¤±æ¸©ï¼",
                icon: "ğŸ¥¶",
                description: "ä½ çš„ä½“æ¸©æ­£åœ¨å¿«é€Ÿæµå¤±ï¼Œæ‰‹è„šå†°å†·ï¼Œæ„è¯†å¼€å§‹æ¨¡ç³Šã€‚è¿™æ˜¯å¤±æ¸©çš„å¾å…†ï¼",
                choices: [
                    { text: "ç«‹å³æ‰è¥å–æš– (-30ä½“åŠ›, ç§»é™¤æ¹¿èº«)", effect: { stamina: -30 }, removeStatus: "wet" },
                    { text: "æ›´æ¢å¹²è¡£ç‰© (-10ä½“åŠ›, ç¼“è§£å¤±æ¸©)", effect: { stamina: -10 }, removeStatus: "hypothermia" },
                    { text: "ç»§ç»­èµ¶è·¯ (-40ä½“åŠ›, ç”Ÿå‘½å±é™©ï¼)", effect: { stamina: -40 }, risk: { death: 0.3 } }
                ]
            });
            break;
            
        case "getLost":
            gameState.neverLost = false;
            showEventModal({
                title: "è¿·è·¯ï¼",
                icon: "ğŸ—ºï¸",
                description: "æµ“é›¾ä¸­ä½ è¿·å¤±äº†æ–¹å‘ï¼Œä¸çŸ¥é“è¯¥å¾€å“ªé‡Œèµ°...",
                choices: [
                    { text: "ä½¿ç”¨æŒ‡å—é’ˆ/GPS (-5ä½“åŠ›)", effect: { stamina: -5 }, condition: "has_navigation" },
                    { text: "åŸåœ°ç­‰å¾…é›¾æ•£ (-30ä½“åŠ›, -20ç†æ™º)", effect: { stamina: -30, sanity: -20 } },
                    { text: "å‡­æ„Ÿè§‰èµ° (-20ä½“åŠ›, 50%æ›´è¿·è·¯)", effect: { stamina: -20 }, risk: { moreLost: 0.5 } }
                ]
            });
            break;
            
        case "fall":
            showEventModal({
                title: "æ»‘å ï¼",
                icon: "âš ï¸",
                description: "è·¯é¢æ¹¿æ»‘ï¼Œä½ è„šä¸‹ä¸€æ»‘ï¼Œä»æ–œå¡ä¸Šæ‘”äº†ä¸‹å»ï¼",
                choices: [
                    { text: "ç´§æ€¥è‡ªæ•‘ (-25ä½“åŠ›, å—ä¼¤)", effect: { stamina: -25 }, addStatus: "injured" },
                    { text: "ä½¿ç”¨ç»³ç´¢ (-10ä½“åŠ›, æœ‰ç»³åˆ™å®‰å…¨)", effect: { stamina: -10 }, condition: "has_rope" },
                    { text: "ä»»ç”±æ»‘è½ (-40ä½“åŠ›, é‡ä¼¤)", effect: { stamina: -40, health: -30 }, addStatus: "injured" }
                ]
            });
            break;
            
        case "altitudeSickness":
            addStatusEffect("altitudeSickness");
            showEventModal({
                title: "é«˜åŸååº”ï¼",
                icon: "ğŸ¤¢",
                description: `æµ·æ‹”${MAP_NODES[gameState.currentNode].elevation}ç±³ï¼Œä½ æ„Ÿåˆ°å¤´ç—›æ¶å¿ƒï¼Œå‘¼å¸å›°éš¾ã€‚`,
                choices: [
                    { text: "åŸåœ°ä¼‘æ¯é€‚åº” (-20ä½“åŠ›)", effect: { stamina: -20 } },
                    { text: "ç¼“æ…¢ä¸‹æ’¤ (-30ä½“åŠ›, ç¼“è§£ç—‡çŠ¶)", effect: { stamina: -30 }, removeStatus: "altitudeSickness" },
                    { text: "ç¡¬æ’‘å‰è¿› (-35ä½“åŠ›, ç—‡çŠ¶åŠ é‡)", effect: { stamina: -35 }, addStatus: "exhausted" }
                ]
            });
            break;
            
        case "wildAnimal":
            showEventModal({
                title: "é‡ç”ŸåŠ¨ç‰©ï¼",
                icon: "ğŸ‚",
                description: "ä¸€å¤´ç¾šç‰›å‡ºç°åœ¨å‰æ–¹ï¼Œå®ƒçœ‹èµ·æ¥å¾ˆä¸å‹å–„...",
                choices: [
                    { text: "æ…¢æ…¢åé€€ (-15ä½“åŠ›)", effect: { stamina: -15 } },
                    { text: "å¤§å£°é©±èµ¶ (-25ä½“åŠ›, å¯èƒ½æ¿€æ€’)", effect: { stamina: -25 }, risk: { attack: 0.4 } },
                    { text: "çˆ¬ä¸Šå²©çŸ³èº²é¿ (-20ä½“åŠ›, å®‰å…¨)", effect: { stamina: -20 } }
                ]
            });
            break;
            
        case "dehydration":
            addStatusEffect("dehydration");
            showEventModal({
                title: "è„±æ°´ï¼",
                icon: "ğŸ’§",
                description: "ä½ çš„å˜´å”‡å¹²è£‚ï¼Œå¤´æ™•ç›®çœ©ï¼Œä¸¥é‡ç¼ºæ°´äº†ï¼",
                choices: [
                    { text: "å¤§é‡è¡¥æ°´ (-30æ°´åˆ†, ç¼“è§£ç—‡çŠ¶)", effect: { water: -30 }, removeStatus: "dehydration" },
                    { text: " rationé¥®æ°´ (-15æ°´åˆ†)", effect: { water: -15 } },
                    { text: "å¿è€ (-20ä½“åŠ›, å±é™©ï¼)", effect: { stamina: -20 }, risk: { collapse: 0.3 } }
                ]
            });
            break;
            
        case "panic":
            addStatusEffect("panic");
            showEventModal({
                title: "ææ…Œï¼",
                icon: "ğŸ˜°",
                description: "æ¶åŠ£å¤©æ°”å’Œé™©å³»åœ°å½¢è®©ä½ æ„Ÿåˆ°æåº¦ææ…Œï¼",
                choices: [
                    { text: "æ·±å‘¼å¸å†·é™ (-10ä½“åŠ›, +20ç†æ™º)", effect: { stamina: -10, sanity: 20 }, removeStatus: "panic" },
                    { text: "åŸåœ°åä¸‹ (-20ä½“åŠ›, +15ç†æ™º)", effect: { stamina: -20, sanity: 15 }, removeStatus: "panic" },
                    { text: "ç›²ç›®å¥”è·‘ (-30ä½“åŠ›, å¯èƒ½å—ä¼¤)", effect: { stamina: -30 }, risk: { injury: 0.5 } }
                ]
            });
            break;
    }
}

function triggerRandomEvent() {
    const event = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
    gameState.eventsTriggered++;
    
    if (event.type === "scenery") {
        if (!gameState.sceneryEventsTriggered.includes(event.id)) {
            gameState.sceneryEventsTriggered.push(event.id);
        }
    }
    
    if (event.id === "other_hiker") {
        gameState.hikersEncountered++;
    }
    
    if (event.type === "good") {
        gameState.goodEventStreak++;
        gameState.maxGoodEventStreak = Math.max(gameState.maxGoodEventStreak, gameState.goodEventStreak);
    } else if (event.type === "bad") {
        gameState.goodEventStreak = 0;
    }
    
    showEventModal(event);
}

function showEventModal(event) {
    const iconEl = document.getElementById("event-icon");
    const titleEl = document.getElementById("event-title");
    const descEl = document.getElementById("event-description");
    const choicesContainer = document.getElementById("event-choices");
    
    if (!iconEl || !titleEl || !descEl || !choicesContainer) return;
    
    iconEl.textContent = event.icon;
    titleEl.textContent = event.title;
    descEl.textContent = event.description;
    choicesContainer.innerHTML = "";
    
    event.choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "btn btn-choice";
        btn.textContent = choice.text;
        
        // æ£€æŸ¥æ¡ä»¶
        if (choice.condition === "has_food" && gameState.food < 10) {
            btn.disabled = true;
            btn.textContent += " (é£Ÿç‰©ä¸è¶³)";
        }
        if (choice.condition === "has_medicine" && !gameState.inventory.some(i => i.id === "first_aid")) {
            btn.disabled = true;
            btn.textContent += " (æ— è¯å“)";
        }
        if (choice.condition === "has_navigation" && 
            !gameState.inventory.some(i => i.id === "compass" || i.id === "gps")) {
            btn.disabled = true;
            btn.textContent += " (æ— å¯¼èˆªè®¾å¤‡)";
        }
        if (choice.condition === "has_rope" && !gameState.inventory.some(i => i.id === "rope")) {
            btn.disabled = true;
            btn.textContent += " (æ— ç»³ç´¢)";
        }
        
        btn.addEventListener("click", () => {
            // è®°å½•å†³ç­–
            gameState.decisionHistory.push({
                event: event.title,
                choice: choice.text,
                time: Date.now()
            });
            
            // åº”ç”¨æ•ˆæœ
            if (choice.effect) {
                applyEventEffect(choice.effect);
            }
            
            // æ·»åŠ çŠ¶æ€
            if (choice.addStatus) {
                addStatusEffect(choice.addStatus);
            }
            
            // ç§»é™¤çŠ¶æ€
            if (choice.removeStatus) {
                removeStatusEffect(choice.removeStatus);
            }
            
            // é“å¾·è¯„åˆ†
            if (choice.moral) {
                if (choice.moral === "good") gameState.moralScore += 10;
                else if (choice.moral === "bad") gameState.moralScore -= 10;
            }
            
            // å¸®åŠ©è®°å½•
            if (choice.isHelp && event.id === "other_hiker") {
                gameState.hikersHelped++;
            }
            
            // ç¯ä¿è®°å½•
            if (choice.eco) {
                gameState.trashLeft = Math.max(0, gameState.trashLeft - 1);
            }
            
            // é£é™©å¤„ç†
            if (choice.risk) {
                for (const [risk, prob] of Object.entries(choice.risk)) {
                    if (Math.random() < prob) {
                        handleRiskEvent(risk);
                    }
                }
            }
            
            hideModal("event-screen");
            updateUI();
            checkSurvival();
        });
        
        choicesContainer.appendChild(btn);
    });
    
    showModal("event-screen");
}

function handleRiskEvent(risk) {
    switch (risk) {
        case "death":
            gameState.gameOver = true;
            gameState.deathReason = "æ¶åŠ£å¤©æ°”ä¸­å¼ºè¡Œå‰è¿›ï¼Œä¸å¹¸é‡éš¾...";
            showGameOver();
            break;
        case "injury":
            addStatusEffect("injured");
            logEvent("ğŸ’¥ ä½ åœ¨æ…Œä¹±ä¸­å—ä¼¤äº†ï¼");
            break;
        case "attack":
            gameState.stamina -= 40;
            gameState.health -= 30;
            logEvent("ğŸ‚ ç¾šç‰›æ”»å‡»äº†ä½ ï¼");
            break;
        case "moreLost":
            gameState.stamina -= 30;
            gameState.sanity -= 20;
            logEvent("ğŸ—ºï¸ ä½ è¶Šèµ°è¶Šè¿·èŒ«...");
            break;
        case "collapse":
            gameState.stamina -= 50;
            addStatusEffect("exhausted");
            logEvent("ğŸ’€ ä½ å› è„±æ°´è€Œè™šè„±ï¼");
            break;
    }
}

function applyEventEffect(effect) {
    if (!effect) return;
    
    if (effect.stamina) {
        gameState.stamina = Math.max(0, Math.min(gameState.maxStamina, gameState.stamina + effect.stamina));
    }
    if (effect.food) {
        gameState.food = Math.max(0, Math.min(100, gameState.food + effect.food));
    }
    if (effect.water) {
        gameState.water = Math.max(0, Math.min(100, gameState.water + effect.water));
    }
    if (effect.mood) {
        gameState.mood = Math.max(0, Math.min(100, gameState.mood + effect.mood));
    }
    if (effect.sanity) {
        gameState.sanity = Math.max(0, Math.min(100, gameState.sanity + effect.sanity));
    }
    if (effect.health) {
        gameState.health = Math.max(0, Math.min(100, gameState.health + effect.health));
    }
    if (effect.wetness) {
        gameState.wetness = Math.max(0, Math.min(100, gameState.wetness + effect.wetness));
    }
}

// ==================== ç§»åŠ¨ç³»ç»Ÿ ====================

function getCurrentRoute() {
    if (gameState.currentNode === 0) return null;
    return ROUTES.find(r => r.to === gameState.currentNode);
}

function showMoveOptions() {
    if (gameState.gameOver) return;
    
    const currentNode = gameState.currentNode;
    const availableRoutes = ROUTES.filter(r => r.from === currentNode);
    
    const container = document.getElementById("route-options");
    if (!container) return;
    container.innerHTML = "";
    
    const config = gameState.difficultyConfig || DIFFICULTY_MODES.normal;
    
    if (availableRoutes.length === 0) {
        container.innerHTML = "<p>æ²¡æœ‰å¯é€šè¡Œçš„è·¯çº¿</p>";
    } else {
        availableRoutes.forEach(route => {
            const toNode = MAP_NODES[route.to];
            const terrain = TERRAIN_TYPES[route.terrain];
            const difficultyClass = route.difficulty;
            
            // è®¡ç®—æ¶ˆè€—ï¼ˆåº”ç”¨éš¾åº¦ä¿®æ­£å’Œè£…å¤‡æ•ˆæœï¼‰
            const modifiers = getStatusEffectModifiers();
            const weatherMultiplier = gameState.weather.moveCost;
            const terrainMultiplier = terrain.staminaCost;
            const statusMultiplier = modifiers.staminaDrain;
            const difficultyMoveMultiplier = 1 + config.moveCostModifier;
            
            const baseStaminaCost = route.distance * 3;
            const rawStaminaCost = Math.floor(baseStaminaCost * weatherMultiplier * terrainMultiplier * statusMultiplier * difficultyMoveMultiplier);
            const timeCost = Math.floor(route.distance * weatherMultiplier / modifiers.moveSpeed);
            
            // åº”ç”¨è£…å¤‡æ•ˆæœè®¡ç®—æœ€ç»ˆä½“åŠ›æ¶ˆè€—
            const finalStaminaCost = EquipmentSystem.applyMoveStaminaEffects(
                rawStaminaCost, 
                gameState.weather, 
                terrain, 
                toNode.elevation
            );
            
            const routeDiv = document.createElement("div");
            routeDiv.className = `route-option ${difficultyClass}`;
            routeDiv.innerHTML = `
                <div class="route-header">
                    <span class="route-name">å‰å¾€ ${toNode.name}</span>
                    <span class="route-difficulty ${difficultyClass}">${getDifficultyText(route.difficulty)}</span>
                </div>
                <div class="route-desc">${route.desc}</div>
                <div class="route-terrain">${terrain.icon} ${terrain.name} - ${terrain.description}</div>
                <div class="route-stats">
                    <span>ğŸ“ ${route.distance}km</span>
                    <span>âš¡ -${finalStaminaCost}ä½“åŠ›</span>
                    <span>â±ï¸ ${timeCost}å°æ—¶</span>
                    <span>ğŸ”ï¸ ${toNode.elevation}m</span>
                </div>
            `;
            routeDiv.addEventListener("click", () => moveToNode(route, finalStaminaCost, timeCost));
            container.appendChild(routeDiv);
        });
    }
    
    showModal("move-screen");
}

function getDifficultyText(difficulty) {
    const map = { easy: "ç®€å•", normal: "æ™®é€š", hard: "å›°éš¾" };
    return map[difficulty] || difficulty;
}

function moveToNode(route, staminaCost, timeCost) {
    hideModal("move-screen");
    
    // æ£€æŸ¥ä½“åŠ›
    if (gameState.stamina < staminaCost) {
        logEvent("ä½“åŠ›ä¸è¶³ï¼éœ€è¦ä¼‘æ¯æ¢å¤ã€‚");
        return;
    }
    
    const terrain = TERRAIN_TYPES[route.terrain];
    const weather = gameState.weather;
    const config = gameState.difficultyConfig || DIFFICULTY_MODES.normal;
    
    // åº”ç”¨æ¶ˆè€—ï¼ˆåº”ç”¨éš¾åº¦èµ„æºæ¶ˆè€—ä¿®æ­£ï¼‰
    const resourceMultiplier = 1 + config.resourceDrainModifier;
    
    gameState.stamina -= staminaCost;
    gameState.food = Math.max(0, gameState.food - route.distance * 0.5 * weather.foodDrain * resourceMultiplier);
    gameState.water = Math.max(0, gameState.water - route.distance * 1.5 * weather.waterDrain * resourceMultiplier);
    gameState.fatigue = Math.min(100, gameState.fatigue + route.distance * 2);
    gameState.totalDistance += route.distance;
    
    // æ›´æ–°æ—¶é—´
    gameState.hour += timeCost;
    if (gameState.hour >= 24) {
        gameState.hour -= 24;
        gameState.day++;
        logEvent(`ğŸŒ… ç¬¬ ${gameState.day} å¤©å¼€å§‹äº†`);
    }
    
    // ç§»åŠ¨
    gameState.currentNode = route.to;
    gameState.moves++;
    
    // è®°å½•è·¯çº¿
    if (route.difficulty === "hard") {
        gameState.dangerRoutesTaken.push(`${route.from}-${route.to}`);
    } else {
        gameState.normalRoutesTaken.push(`${route.from}-${route.to}`);
    }
    
    const node = MAP_NODES[route.to];
    logEvent(`åˆ°è¾¾ ${node.name} (${node.elevation}m) - ${terrain.icon} ${terrain.name}`);
    
    // æµ·æ‹”å˜åŒ–å½±å“
    if (route.altitudeChange > 500) {
        logEvent("âš ï¸ å¿«é€Ÿçˆ¬å‡ï¼Œæ³¨æ„é«˜åŸååº”ï¼");
    }
    
    // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹
    if (node.type === "end") {
        gameState.victory = true;
        gameState.gameOver = true;
        checkAchievements();
        handleVictory();
        return;
    }
    
    // è¥åœ°æ•ˆæœ
    if (node.type === "camp") {
        gameState.mood = Math.min(100, gameState.mood + 15);
        gameState.sanity = Math.min(100, gameState.sanity + 10);
        if (!gameState.campsRested.includes(node.id)) {
            gameState.campsRested.push(node.id);
        }
        logEvent("ğŸ•ï¸ åˆ°è¾¾è¥åœ°ï¼Œå¿ƒæƒ…å’Œç†æ™ºæ¢å¤ï¼");
    }
    
    // æ›´æ–°å¤©æ°”
    updateWeather();
    
    // æ›´æ–°çŠ¶æ€æ•ˆæœ
    updateStatusEffects();
    
    // æ£€æŸ¥äº‹ä»¶è§¦å‘
    checkEventTriggers();
    
    // éšæœºäº‹ä»¶
    if (Math.random() < 0.3) {
        setTimeout(() => triggerRandomEvent(), 500);
    }
    
    checkSurvival();
    renderMap();
    updateUI();
}

function getTimeOfDay() {
    const hour = gameState.hour;
    if (hour >= 6 && hour < 18) return "day";
    if (hour >= 18 && hour < 20) return "dusk";
    return "night";
}

// ==================== ä¼‘æ¯å’Œæ¢å¤ ====================

function rest() {
    if (gameState.gameOver) return;
    
    const node = MAP_NODES[gameState.currentNode];
    const isCamp = node.type === "camp";
    const weather = gameState.weather;
    const config = gameState.difficultyConfig || DIFFICULTY_MODES.normal;
    
    // è®¡ç®—æ¢å¤é‡
    const modifiers = getStatusEffectModifiers();
    let staminaRecovery = isCamp ? 50 : 30;
    let moodRecovery = isCamp ? 25 : 15;
    let sanityRecovery = isCamp ? 20 : 10;
    
    // åº”ç”¨éš¾åº¦ä¿®æ­£
    if (config.resourceDrainModifier > 0) {
        staminaRecovery *= (1 - config.resourceDrainModifier * 0.5);
        moodRecovery *= (1 - config.resourceDrainModifier * 0.5);
    } else if (config.resourceDrainModifier < 0) {
        staminaRecovery *= (1 - config.resourceDrainModifier);
        moodRecovery *= (1 - config.resourceDrainModifier);
    }
    
    // å¤©æ°”å½±å“ä¼‘æ¯æ•ˆæœ
    if (weather.id === "snowstorm" || weather.id === "heavyRain") {
        if (!isCamp) {
            staminaRecovery *= 0.5;
            moodRecovery *= 0.3;
            logEvent("æ¶åŠ£å¤©æ°”ä¸­ä¼‘æ¯æ•ˆæœå¤§æ‰“æŠ˜æ‰£ï¼");
        }
    }
    
    // çŠ¶æ€æ•ˆæœå½±å“
    staminaRecovery += modifiers.staminaRegen * 10;
    moodRecovery += modifiers.moodEffect;
    sanityRecovery += modifiers.sanityEffect;
    
    // åº”ç”¨æ¢å¤
    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + staminaRecovery);
    gameState.mood = Math.min(100, Math.max(0, gameState.mood + moodRecovery));
    gameState.sanity = Math.min(100, Math.max(0, gameState.sanity + sanityRecovery));
    gameState.fatigue = Math.max(0, gameState.fatigue - (isCamp ? 30 : 15));
    
    // æ¹¿èº«æ¢å¤ï¼ˆåº”ç”¨é€Ÿå¹²è¡£æ•ˆæœï¼‰
    if (isCamp) {
        let wetnessRecovery = 40;
        wetnessRecovery = EquipmentSystem.applyWetnessRecovery(wetnessRecovery);
        gameState.wetness = Math.max(0, gameState.wetness - wetnessRecovery);
    }
    
    // ä½“æ¸©æ¢å¤ï¼ˆåº”ç”¨è¡£ç‰©ä¿æš–æ•ˆæœï¼‰
    if (gameState.bodyTemp < 36) {
        let tempRecovery = 0.5;
        gameState.bodyTemp = Math.min(37, gameState.bodyTemp + tempRecovery);
    } else if (gameState.bodyTemp > 38) {
        gameState.bodyTemp = Math.max(37, gameState.bodyTemp - 0.5);
    }
    
    // æ¶ˆè€—ï¼ˆåº”ç”¨éš¾åº¦èµ„æºæ¶ˆè€—ä¿®æ­£ï¼‰
    const resourceMultiplier = 1 + config.resourceDrainModifier;
    gameState.food = Math.max(0, gameState.food - 12 * resourceMultiplier);
    gameState.water = Math.max(0, gameState.water - 15 * resourceMultiplier);
    gameState.hour += isCamp ? 4 : 2;
    gameState.restCount++;
    
    // æ—¶é—´è·¨å¤©å¤„ç†
    if (gameState.hour >= 24) {
        gameState.hour -= 24;
        gameState.day++;
    }
    
    // è®°å½•è¥åœ°ä¼‘æ¯
    if (isCamp && !gameState.campsRested.includes(node.id)) {
        gameState.campsRested.push(node.id);
    }
    
    logEvent(`${isCamp ? "ğŸ•ï¸ åœ¨è¥åœ°" : "ğŸŒ² å°±åœ°"}ä¼‘æ¯ï¼Œæ¢å¤äº†ä½“åŠ›ï¼`);
    
    // ä¼‘æ¯åæ›´æ–°
    updateWeather();
    updateStatusEffects();
    
    if (Math.random() < 0.2) {
        setTimeout(() => triggerRandomEvent(), 500);
    }
    
    checkSurvival();
    updateUI();
}

function eat() {
    if (gameState.gameOver) return;
    
    const foodItems = gameState.inventory.filter(item => 
        EQUIPMENT.food.some(f => f.id === item.id)
    );
    
    if (foodItems.length === 0) {
        logEvent("æ²¡æœ‰é£Ÿç‰©äº†ï¼");
        return;
    }
    
    const food = foodItems[0];
    gameState.food = Math.min(100, gameState.food + (food.foodValue || 30));
    if (food.moodValue) {
        gameState.mood = Math.min(100, gameState.mood + food.moodValue);
    }
    gameState.inventory = gameState.inventory.filter(item => item.id !== food.id);
    
    logEvent(`ğŸ½ï¸ åƒäº†${food.name}ï¼Œæ¢å¤äº†ä½“åŠ›${food.moodValue ? "å’Œå¿ƒæƒ…" : ""}ï¼`);
    updateUI();
}

function drink() {
    if (gameState.gameOver) return;
    
    gameState.water = Math.min(100, gameState.water + 30);
    logEvent("ğŸ¥¤ å–æ°´è¡¥å……æ°´åˆ†ï¼");
    updateUI();
}

// ==================== ç”Ÿå­˜æ£€æŸ¥ ====================

function checkSurvival() {
    // æ£€æŸ¥è‡´å‘½çŠ¶æ€
    if (hasStatusEffect("hypothermia") && gameState.bodyTemp < 33) {
        if (Math.random() < 0.3) {
            gameState.gameOver = true;
            gameState.deathReason = "ä¸¥é‡å¤±æ¸©å¯¼è‡´ç”Ÿå‘½ä½“å¾è¡°ç«­...";
            showGameOver();
            return;
        }
    }
    
    if (hasStatusEffect("dehydration") && gameState.water <= 0) {
        gameState.stamina -= 10;
        gameState.health -= 5;
        logEvent("ğŸ’€ ä¸¥é‡è„±æ°´ï¼ç”Ÿå‘½å—åˆ°å¨èƒï¼");
    }
    
    // æ£€æŸ¥ä½“æ¸©
    if (gameState.bodyTemp < 33) {
        gameState.stamina -= 15;
        logEvent("ğŸ¥¶ ä½“æ¸©è¿‡ä½ï¼éœ€è¦ç«‹å³å–æš–ï¼");
    } else if (gameState.bodyTemp > 40) {
        gameState.stamina -= 15;
        logEvent("ğŸ¥µ ä½“æ¸©è¿‡é«˜ï¼éœ€è¦é™æ¸©ï¼");
    }
    
    // æ£€æŸ¥ä½“åŠ›
    if (gameState.stamina <= 0) {
        gameState.gameOver = true;
        if (gameState.food <= 0) {
            gameState.deathReason = "é¥¥é¥¿å¯¼è‡´ä½“åŠ›è¡°ç«­...";
        } else if (gameState.water <= 0) {
            gameState.deathReason = "è„±æ°´å¯¼è‡´ä½“åŠ›è¡°ç«­...";
        } else if (gameState.bodyTemp < 35) {
            gameState.deathReason = "å¤±æ¸©å¯¼è‡´ä½“åŠ›è¡°ç«­...";
        } else {
            gameState.deathReason = "ä½“åŠ›è€—å°½ï¼Œæ— æ³•ç»§ç»­å‰è¿›...";
        }
        checkAchievements();
        showGameOver();
        return;
    }
    
    // æ£€æŸ¥å¥åº·å€¼
    if (gameState.health <= 0) {
        gameState.gameOver = true;
        gameState.deathReason = "ä¼¤åŠ¿è¿‡é‡ï¼Œä¸å¹¸é‡éš¾...";
        showGameOver();
        return;
    }
    
    // æ£€æŸ¥ç†æ™º
    if (gameState.sanity <= 0) {
        addStatusEffect("panic");
        logEvent("ğŸ˜° ç†æ™ºå´©æºƒï¼ä½ é™·å…¥äº†ææ…Œï¼");
    }
    
    // ä½èµ„æºè­¦å‘Š
    if (gameState.food <= 10) {
        logEvent("âš ï¸ é£Ÿç‰©å³å°†è€—å°½ï¼");
    }
    if (gameState.water <= 10) {
        logEvent("âš ï¸ æ°´æºå³å°†è€—å°½ï¼");
    }
}

// ==================== æˆå°±ç³»ç»Ÿ ====================

function loadAchievements() {
    const saved = localStorage.getItem("aotai_achievements");
    if (saved) {
        gameState.unlockedAchievements = JSON.parse(saved);
    }
}

function saveAchievements() {
    localStorage.setItem("aotai_achievements", JSON.stringify(gameState.unlockedAchievements));
}

function unlockAchievement(achievementId) {
    if (gameState.achievements.includes(achievementId)) return;
    
    const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
    if (!achievement) return;
    
    gameState.achievements.push(achievementId);
    
    if (!gameState.unlockedAchievements.includes(achievementId)) {
        gameState.unlockedAchievements.push(achievementId);
        saveAchievements();
    }
    
    showAchievementUnlock(achievement);
}

function showAchievementUnlock(achievement) {
    const toast = document.createElement("div");
    toast.className = "achievement-toast";
    toast.innerHTML = `
        <div class="achievement-toast-icon">${achievement.icon}</div>
        <div class="achievement-toast-content">
            <div class="achievement-toast-title">æˆå°±è§£é”ï¼</div>
            <div class="achievement-toast-name">${achievement.name}</div>
            <div class="achievement-toast-desc">${achievement.desc}</div>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add("show"), 100);
    setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function checkAchievements() {
    const config = gameState.difficultyConfig || DIFFICULTY_MODES.normal;
    
    if (gameState.victory && gameState.day <= 3) {
        unlockAchievement("speed_runner");
    }
    
    const basicOnly = gameState.equipment.every(e => e.cost <= 15);
    if (gameState.victory && basicOnly && gameState.equipment.length <= 6) {
        unlockAchievement("light_packer");
    }
    
    if (gameState.victory && gameState.difficulty === "hard") {
        unlockAchievement("iron_man");
    }
    
    if (gameState.sceneryEventsTriggered.length >= 3) {
        unlockAchievement("photographer");
    }
    
    const dangerRoutes = ROUTES.filter(r => r.difficulty === "hard");
    const allDangerTaken = dangerRoutes.every(r => 
        gameState.dangerRoutesTaken.includes(`${r.from}-${r.to}`)
    );
    if (allDangerTaken) {
        unlockAchievement("explorer");
    }
    
    const campNodes = MAP_NODES.filter(n => n.type === "camp").map(n => n.id);
    const allCampsRested = campNodes.every(id => gameState.campsRested.includes(id));
    if (allCampsRested) {
        unlockAchievement("camp_master");
    }
    
    if (gameState.hikersEncountered > 0 && gameState.hikersHelped >= gameState.hikersEncountered) {
        unlockAchievement("helper");
    }
    
    if (gameState.victory && gameState.dangerRoutesTaken.length === 0) {
        unlockAchievement("nature_respect");
    }
    
    if (gameState.victory && gameState.trashLeft === 0) {
        unlockAchievement("eco_guardian");
    }
    
    if (gameState.survivedBlizzard) {
        unlockAchievement("blizzard_survivor");
    }
    
    if (gameState.victory && gameState.stamina >= 90) {
        unlockAchievement("perfect_finish");
    }
    
    if (gameState.maxGoodEventStreak >= 3) {
        unlockAchievement("lucky_one");
    }
    
    if (gameState.neverLost && gameState.victory) {
        unlockAchievement("navigator");
    }
    
    // ç‰¹æ®Šæˆå°±æ£€æŸ¥
    checkSpecialAchievements();
}

function checkSpecialAchievements() {
    const config = gameState.difficultyConfig || DIFFICULTY_MODES.normal;
    
    // åœ°ç‹±è¡Œè€…ï¼šåœ¨åœ°ç‹±æ¨¡å¼ä¸‹å®Œæˆç©¿è¶Š
    if (gameState.victory && config.id === 'hell') {
        unlockAchievement("hell_survivor");
    }
    
    // é’¢é“æ„å¿—ï¼šåœ¨å›°éš¾æˆ–åœ°ç‹±æ¨¡å¼ä¸‹æ— ä¼¤é€šå…³
    if (gameState.victory && (config.id === 'hard' || config.id === 'hell') && gameState.injuryCount === 0) {
        unlockAchievement("iron_will");
    }
    
    // æç®€ä¸»ä¹‰è€…ï¼šåœ¨åœ°ç‹±æ¨¡å¼ä¸‹ä½¿ç”¨ä¸è¶…è¿‡30ç‚¹è£…å¤‡é¢„ç®—é€šå…³
    if (gameState.victory && config.id === 'hell' && gameState.equipmentPointsUsed <= 30) {
        unlockAchievement("minimalist");
    }
    
    // é£æš´ä¹‹ä¸»ï¼šåœ¨åœ°ç‹±æ¨¡å¼ä¸‹ç»å†5æ¬¡ä»¥ä¸Šæš´é£é›ªå¹¶å­˜æ´»
    if (config.id === 'hell' && gameState.blizzardCount >= 5) {
        unlockAchievement("storm_master");
    }
}

function handleVictory() {
    const config = gameState.difficultyConfig || DIFFICULTY_MODES.normal;
    
    // è§£é”ä¸‹ä¸€éš¾åº¦
    if (config.id === 'normal' && !isDifficultyUnlocked('hard')) {
        unlockDifficulty('hard');
        logEvent("ğŸ‰ è§£é”å›°éš¾æ¨¡å¼ï¼");
    } else if (config.id === 'hard' && !isDifficultyUnlocked('hell')) {
        unlockDifficulty('hell');
        logEvent("ğŸ‰ è§£é”åœ°ç‹±æ¨¡å¼ï¼");
    }
    
    showGameOver();
}

// ==================== UI æ›´æ–° ====================

function updateUI() {
    // æ›´æ–°èµ„æºæ¡
    updateResourceBar("stamina", gameState.stamina);
    updateResourceBar("food", gameState.food);
    updateResourceBar("water", gameState.water);
    updateResourceBar("mood", gameState.mood);
    
    // æ›´æ–°çŠ¶æ€æ 
    const node = MAP_NODES[gameState.currentNode];
    const locationEl = document.getElementById("current-location");
    const dayEl = document.getElementById("current-day");
    const weatherEl = document.getElementById("current-weather");
    
    if (locationEl) locationEl.textContent = node.name;
    if (dayEl) dayEl.textContent = gameState.day;
    if (weatherEl) {
        weatherEl.innerHTML = `${gameState.weather.icon} ${gameState.weather.name} ${gameState.weather.temperature}Â°C`;
    }
    
    // æ›´æ–°ç»§ç»­æ¸¸æˆæŒ‰é’®
    const hasSave = localStorage.getItem("aotai_save") !== null;
    const continueBtn = document.getElementById("btn-continue");
    if (continueBtn) continueBtn.disabled = !hasSave;
    
    // æ›´æ–°çŠ¶æ€æ•ˆæœæ˜¾ç¤º
    updateStatusEffectsDisplay();
    
    // æ›´æ–°èº«ä½“çŠ¶æ€æ˜¾ç¤º
    updateBodyStatusDisplay();
}

function updateResourceBar(type, value) {
    const bar = document.getElementById(`${type}-bar`);
    const valueSpan = document.getElementById(`${type}-value`);
    
    if (!bar || !valueSpan) return;
    
    bar.style.width = `${value}%`;
    valueSpan.textContent = Math.floor(value);
    
    bar.classList.remove("low", "critical");
    if (value <= 20) {
        bar.classList.add("critical");
    } else if (value <= 40) {
        bar.classList.add("low");
    }
}

function updateStatusEffectsDisplay() {
    const container = document.getElementById("status-effects");
    if (!container) return;
    
    container.innerHTML = "";
    gameState.statusEffects.forEach(effect => {
        const def = STATUS_EFFECTS[effect.id];
        if (!def) return;
        
        const badge = document.createElement("span");
        badge.className = "status-badge";
        badge.textContent = `${def.icon} ${def.name}`;
        container.appendChild(badge);
    });
}

function updateBodyStatusDisplay() {
    const bodyTempEl = document.getElementById("body-temp");
    const wetnessEl = document.getElementById("wetness");
    const fatigueEl = document.getElementById("fatigue");
    const sanityEl = document.getElementById("sanity");
    
    if (bodyTempEl) bodyTempEl.textContent = `${gameState.bodyTemp.toFixed(1)}Â°C`;
    if (wetnessEl) wetnessEl.textContent = `${Math.floor(gameState.wetness)}%`;
    if (fatigueEl) fatigueEl.textContent = `${Math.floor(gameState.fatigue)}%`;
    if (sanityEl) sanityEl.textContent = `${Math.floor(gameState.sanity)}%`;
}

function renderMap() {
    const container = document.getElementById("map-container");
    if (!container) return;
    container.innerHTML = "";
    
    MAP_NODES.forEach((node, index) => {
        const nodeDiv = document.createElement("div");
        const isCurrent = index === gameState.currentNode;
        const isPast = index < gameState.currentNode;
        const isNext = index === gameState.currentNode + 1;
        
        let statusClass = "";
        if (isCurrent) statusClass = "current";
        else if (isPast) statusClass = "visited";
        else if (isNext) statusClass = "next";
        
        let icon = "ğŸ“";
        if (node.type === "start") icon = "ğŸ˜ï¸";
        else if (node.type === "end") icon = "ğŸ";
        else if (node.type === "camp") icon = "â›º";
        else if (node.type === "danger") icon = "âš ï¸";
        else if (node.type === "landmark") icon = "ğŸš©";
        
        nodeDiv.className = `map-node ${statusClass}`;
        nodeDiv.innerHTML = `
            <div class="node-icon">${icon}</div>
            <div class="node-name">${node.name}</div>
            <div class="node-elevation">${node.elevation}m</div>
        `;
        
        container.appendChild(nodeDiv);
        
        if (index < MAP_NODES.length - 1) {
            const lineDiv = document.createElement("div");
            lineDiv.className = `map-line ${isPast ? "active" : ""}`;
            container.appendChild(lineDiv);
        }
    });
}

// ==================== ç•Œé¢å‡½æ•° ====================

function showScreen(screenId) {
    document.querySelectorAll(".screen").forEach(screen => {
        screen.classList.remove("active");
    });
    const screen = document.getElementById(screenId);
    if (screen) screen.classList.add("active");
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.add("active");
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.remove("active");
}

function showInventory() {
    const container = document.getElementById("inventory-list");
    if (!container) return;
    container.innerHTML = "";
    
    if (gameState.inventory.length === 0) {
        container.innerHTML = "<p class='empty-inventory'>èƒŒåŒ…æ˜¯ç©ºçš„</p>";
    } else {
        gameState.inventory.forEach(item => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "inventory-item";
            itemDiv.innerHTML = `
                <span class="item-name">${item.name}</span>
                <span class="item-weight">${item.weight}kg</span>
            `;
            container.appendChild(itemDiv);
        });
    }
    
    const weightInfo = document.createElement("div");
    weightInfo.className = "weight-info";
    weightInfo.innerHTML = `
        <span>æ€»è´Ÿé‡: ${gameState.totalWeight.toFixed(1)}kg / ${gameState.maxCapacity}kg</span>
    `;
    container.appendChild(weightInfo);
    
    showModal("inventory-screen");
}

function showGameOver() {
    const isVictory = gameState.victory;
    
    const endIcon = document.getElementById("end-icon");
    const endTitle = document.getElementById("end-title");
    const endDesc = document.getElementById("end-description");
    const endStats = document.getElementById("end-stats");
    
    if (endIcon) endIcon.textContent = isVictory ? "ğŸ†" : "ğŸ’€";
    if (endTitle) endTitle.textContent = isVictory ? "ç©¿è¶ŠæˆåŠŸï¼" : "æ¸¸æˆç»“æŸ";
    if (endDesc) {
        endDesc.textContent = isVictory 
            ? "æ­å–œä½ æˆåŠŸç©¿è¶Šé³Œå¤ªçº¿ï¼è¿™æ˜¯ä¸€æ¬¡ä¼Ÿå¤§çš„æˆå°±ï¼"
            : gameState.deathReason || "ä½ æ²¡èƒ½å®Œæˆç©¿è¶Š...";
    }
    
    if (endStats) {
        endStats.innerHTML = `
            <div class="stat-item"><span>ç§»åŠ¨æ¬¡æ•°:</span><span>${gameState.moves}</span></div>
            <div class="stat-item"><span>è§¦å‘äº‹ä»¶:</span><span>${gameState.eventsTriggered}</span></div>
            <div class="stat-item"><span>ä¼‘æ¯æ¬¡æ•°:</span><span>${gameState.restCount}</span></div>
            <div class="stat-item"><span>è¡Œè¿›è·ç¦»:</span><span>${gameState.totalDistance}km</span></div>
            <div class="stat-item"><span>åˆ°è¾¾èŠ‚ç‚¹:</span><span>${MAP_NODES[gameState.currentNode]?.name || "æœªçŸ¥"}</span></div>
            <div class="stat-item"><span>æ¸¸æˆå¤©æ•°:</span><span>${gameState.day}</span></div>
            <div class="stat-item"><span>é“å¾·è¯„åˆ†:</span><span>${gameState.moralScore}</span></div>
        `;
        
        if (gameState.achievements.length > 0) {
            const achievementsDiv = document.createElement("div");
            achievementsDiv.className = "end-achievements";
            achievementsDiv.innerHTML = "<h4>ğŸ… æœ¬å±€æˆå°±</h4>";
            const listDiv = document.createElement("div");
            listDiv.className = "achievements-grid";
            gameState.achievements.forEach(achId => {
                const ach = ACHIEVEMENTS.find(a => a.id === achId);
                if (ach) {
                    listDiv.innerHTML += `
                        <div class="achievement-badge">
                            <span class="badge-icon">${ach.icon}</span>
                            <span class="badge-name">${ach.name}</span>
                        </div>
                    `;
                }
            });
            achievementsDiv.appendChild(listDiv);
            endStats.appendChild(achievementsDiv);
        }
    }
    
    showModal("game-over-screen");
    saveGame();
}

function showHelp() {
    showModal("help-screen");
}

function showAchievements() {
    const container = document.getElementById("achievements-list");
    if (!container) return;
    container.innerHTML = "";
    
    const categories = {
        survival: "ç”Ÿå­˜ç±»",
        explore: "æ¢ç´¢ç±»",
        moral: "é“å¾·ç±»",
        special: "ç‰¹æ®Šç±»"
    };
    
    Object.entries(categories).forEach(([catId, catName]) => {
        const catDiv = document.createElement("div");
        catDiv.className = "achievement-category";
        catDiv.innerHTML = `<h4>${catName}</h4>`;
        
        const catAchievements = ACHIEVEMENTS.filter(a => a.category === catId);
        catAchievements.forEach(achievement => {
            const isUnlocked = gameState.unlockedAchievements.includes(achievement.id);
            const isCurrentGame = gameState.achievements.includes(achievement.id);
            
            const itemDiv = document.createElement("div");
            itemDiv.className = `achievement-item ${isUnlocked ? "unlocked" : "locked"} ${isCurrentGame ? "current" : ""}`;
            itemDiv.innerHTML = `
                <div class="achievement-icon">${isUnlocked ? achievement.icon : "ğŸ”’"}</div>
                <div class="achievement-info">
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                </div>
            `;
            catDiv.appendChild(itemDiv);
        });
        
        container.appendChild(catDiv);
    });
    
    showModal("achievements-screen");
}

function logEvent(message) {
    const log = document.getElementById("event-log");
    if (!log) return;
    
    const entry = document.createElement("div");
    entry.className = "log-entry";
    entry.textContent = `[Day ${gameState.day} ${gameState.hour}:00] ${message}`;
    log.insertBefore(entry, log.firstChild);
    
    while (log.children.length > 20) {
        log.removeChild(log.lastChild);
    }
}

// ==================== å­˜æ¡£åŠŸèƒ½ ====================

function saveGame() {
    localStorage.setItem("aotai_save", JSON.stringify(gameState));
    logEvent("ğŸ’¾ æ¸¸æˆå·²ä¿å­˜ï¼");
}

function loadGame() {
    const save = localStorage.getItem("aotai_save");
    if (save) {
        const loaded = JSON.parse(save);
        // ä¿ç•™å·²è§£é”æˆå°±
        const unlocked = gameState.unlockedAchievements;
        gameState = { ...gameState, ...loaded };
        gameState.unlockedAchievements = unlocked.length > 0 ? unlocked : (loaded.unlockedAchievements || []);
    }
}

// ==================== å¯åŠ¨æ¸¸æˆ ====================

document.addEventListener("DOMContentLoaded", initGame);
</script>
</body>
</html>
